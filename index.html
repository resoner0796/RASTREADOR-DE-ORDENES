<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Control de Producción</title>
    <!-- SheetJS (xlsx) Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        :root {
            --bg-color: #0F172A; --surface-color: #1E293B; --border-color: #334155;
            --primary-color: #38BDF8; --danger-color: #FB7185; --warning-color: #FBBF24;
            --success-color: #34D399; --text-primary: #F8FAFC; --text-secondary: #94A3B8;
            --text-dark: #64748B;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color);
            color: var(--text-primary); margin: 0; padding: 24px;
            display: flex; justify-content: center;
        }
        .main-container {
            width: 100%; max-width: 1800px; display: grid;
            grid-template-columns: 280px 1fr; grid-template-rows: auto 1fr;
            grid-template-areas: "sidebar header" "sidebar main"; gap: 24px;
        }
        .sidebar {
            grid-area: sidebar; background-color: var(--surface-color); border-radius: 12px;
            padding: 24px; display: flex; flex-direction: column; gap: 16px;
        }
        .header { grid-area: header; }
        .main-content { grid-area: main; display: flex; flex-direction: column; gap: 24px; }
        .card {
            background-color: var(--surface-color); border-radius: 12px;
            padding: 24px; border: 1px solid var(--border-color);
        }
        h2, h3 {
            margin-top: 0; margin-bottom: 16px; color: var(--text-secondary);
            font-weight: 600; font-size: 1.1rem;
        }
        h3 { font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        .file-drop-area {
            border: 2px dashed var(--border-color); border-radius: 8px; padding: 30px 20px;
            text-align: center; cursor: pointer; transition: all 0.2s ease;
        }
        .file-drop-area.dragover { background-color: #334155; border-color: var(--primary-color); }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area span { color: var(--primary-color); font-weight: 500; }
        #orderList .order-btn {
            width: 100%; text-align: left; padding: 12px; border-radius: 6px;
            border: 1px solid var(--border-color); background-color: #334155;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
        }
        #orderList .order-btn:hover { background-color: #475569; color: var(--text-primary); }
        #orderList .order-btn.active {
            background-color: var(--primary-color); color: var(--bg-color);
            font-weight: 700; border-color: var(--primary-color);
        }
        .mode-switcher {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 4px;
            background-color: var(--bg-color); border-radius: 8px; margin-bottom: 16px;
        }
        .mode-switcher button {
            padding: 8px; border: none; background-color: transparent; color: var(--text-secondary);
            font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .mode-switcher button.active { background-color: var(--surface-color); color: var(--primary-color); }
        
        .summary-card {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 24px; text-align: center;
        }
        .stat-item h3 { margin: 0 0 8px 0; font-size: 1rem; font-weight: 500; }
        .stat-item p { margin: 0; font-size: 2rem; font-weight: 700; }
        #statOrderNumber { color: var(--primary-color); } #statPackedQty { color: var(--success-color); }
        #statRemainingQty { color: var(--warning-color); } #statScrapQty { color: var(--danger-color); }

        .table-wrapper { overflow: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        thead { position: sticky; top: 0; background-color: var(--surface-color); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.8rem; }
        
        /* Packing Table Specific Styles */
        .box-row { cursor: pointer; }
        .box-row:hover { background-color: #334155; }
        .box-row td:first-child::before {
            content: '►'; display: inline-block; margin-right: 10px;
            font-size: 0.7rem; transition: transform 0.2s;
        }
        .box-row.expanded td:first-child::before { transform: rotate(90deg); }
        .serial-row { display: none; background-color: var(--bg-color); }
        .serial-row td { padding-left: 40px; border-color: #2a3a5e; }

        tbody tr.is-scrap { background-color: rgba(251, 113, 133, 0.1); }
        tbody tr.is-scrap td { color: var(--danger-color); }
        tbody tr.is-delayed { background-color: rgba(251, 191, 36, 0.1); }
        tbody tr.is-delayed td { color: var(--warning-color); }
        tbody tr.is-today { background-color: rgba(52, 211, 153, 0.1); }
        tbody tr.is-today td { color: var(--success-color); }
        
        #loader, #placeholderText { text-align: center; padding: 60px; color: var(--text-dark); font-size: 1.1rem; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--surface-color); border-radius: 12px; padding: 24px;
            border: 1px solid var(--border-color); width: 90%; max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
    </style>
</head>
<body>

    <div class="main-container">
        <aside class="sidebar">
            <h2>Panel de Control</h2>
            <div class="card">
                <h3>Cargar Órdenes</h3>
                <div id="fileDropArea" class="file-drop-area">
                    <p>Arrastra archivos aquí</p>
                    <p><span>o haz clic para seleccionar</span></p>
                </div>
                <input type="file" id="fileInput" accept=".xlsx, .xls" multiple style="display: none;">
            </div>
            <div class="card" style="flex-grow: 1;">
                <h3>Órdenes Cargadas</h3>
                <div id="orderList">
                    <p class="text-dark" style="font-size:0.9rem;">Cargue uno o más archivos para comenzar.</p>
                </div>
            </div>
        </aside>

        <header class="header card">
             <div class="mode-switcher">
                <button id="modeRastreo" class="active">Rastreo</button>
                <button id="modeEmpaque">Empaque</button>
            </div>
            <div id="summaryCard" class="summary-card">
                 <div class="stat-item"><h3># de Orden</h3><p id="statOrderNumber">N/A</p></div>
                 <div class="stat-item"><h3>Cant. Orden</h3><p id="statOrderQty">0</p></div>
                 <div class="stat-item"><h3>Cant. Empacada</h3><p id="statPackedQty">0</p></div>
                 <div class="stat-item"><h3>Restante</h3><p id="statRemainingQty">0</p></div>
                 <div class="stat-item"><h3>Cant. en Scrap</h3><p id="statScrapQty">0</p></div>
            </div>
        </header>

        <main class="main-content">
            <div id="rastreoView">
                 <!-- Tracking specific content will go here -->
                <div class="card">
                     <!-- Tracking table will be dynamically inserted here -->
                     <div id="rastreoTableContainer"></div>
                </div>
            </div>
            <div id="empaqueView" style="display: none;">
                <div class="card">
                    <input type="text" id="empaqueFilterInput" placeholder="Buscar por Serial o BoxID..." style="margin-bottom:16px">
                    <div class="table-wrapper">
                         <table id="empaqueTable"></table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal HTML -->
    <div id="modalOverlay" class="modal-overlay">
        <div id="modalContent" class="modal-content">
             <span id="modalClose" class="modal-close">&times;</span>
             <h2 id="modalTitle" class="modal-title"></h2>
             <p id="modalMessage" style="margin-top:16px; color: var(--text-secondary);"></p>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let loadedOrders = new Map();
            let activeOrderKey = 'all';
            let currentMode = 'rastreo';

            // --- KEY COLUMN NAMES ---
            const TRACKING_KEYS = { SERIAL: 'Product Serial Number', IS_SCRAP: 'Is Scrap', DATE_REGISTERED: 'Date Registered', LINE: 'Line'};
            const PACKING_KEYS = { SERIAL: 'Serial Number', PACKER: 'Empacador', PACKED_DATE: 'Finish Packed Date', BOX_ID: 'BoxID' };
            const TRACKING_COLS = ['B', 'C', 'G', 'K', 'M', 'P', 'V', 'Y', 'Z', 'AA', 'AB'];
            const PACKING_COLS = { SERIAL: 'AE', PACKER: 'AF', PACKED_DATE: 'AK', BOX_ID: 'AO' };
            
            // --- DOM ELEMENTS ---
            const fileDropArea = document.getElementById('fileDropArea');
            const fileInput = document.getElementById('fileInput');
            const orderList = document.getElementById('orderList');
            const statOrderNumber = document.getElementById('statOrderNumber');
            const statOrderQty = document.getElementById('statOrderQty');
            const statPackedQty = document.getElementById('statPackedQty');
            const statRemainingQty = document.getElementById('statRemainingQty');
            const statScrapQty = document.getElementById('statScrapQty');
            const modeRastreo = document.getElementById('modeRastreo');
            const modeEmpaque = document.getElementById('modeEmpaque');
            const rastreoView = document.getElementById('rastreoView');
            const empaqueView = document.getElementById('empaqueView');
            const empaqueFilterInput = document.getElementById('empaqueFilterInput');
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalClose = document.getElementById('modalClose');

            // --- EVENT LISTENERS ---
            fileDropArea.addEventListener('click', () => fileInput.click());
            fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault(); fileDropArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files); });
            
            modeRastreo.addEventListener('click', () => switchMode('rastreo'));
            modeEmpaque.addEventListener('click', () => switchMode('empaque'));

            empaqueFilterInput.addEventListener('input', () => renderEmpaqueView(activeOrderKey));

            modalClose.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });

            // --- MODAL FUNCTIONS ---
            function showModal(title, message, type = 'info') {
                 modalOverlay.querySelector('.modal-content').className = `modal-content ${type}`;
                 modalTitle.textContent = title;
                 modalMessage.textContent = message;
                 modalOverlay.classList.add('visible');
            }
            function hideModal() { modalOverlay.classList.remove('visible'); }

            // --- HELPER FUNCTIONS ---
            function excelSerialToDate(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                try {
                    const decoded = XLSX.SSF.parse_date_code(serial);
                    if (decoded) return new Date(decoded.y, decoded.m - 1, decoded.d, decoded.H, decoded.M, decoded.S);
                } catch(e) { console.error(e); }
                return null;
            }
            function formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }
             function findHeader(headers, keyText) { return headers.find(h => h.toLowerCase() === keyText.toLowerCase()); }

            // --- FILE HANDLING & DATA PROCESSING ---
            function handleFiles(files) {
                let filePromises = Array.from(files).map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const orderNumber = worksheet['B3']?.v || `Archivo_${file.name.slice(0,10)}`;
                                
                                const orderData = {
                                    orderQty: parseInt(worksheet['O3']?.v || 0),
                                    packedQty: parseInt(worksheet['U3']?.v || 0),
                                    rastreoData: processRastreoData(extractTableData(worksheet, TRACKING_COLS, 20)),
                                    empaqueData: groupEmpaqueData(extractTableData(worksheet, Object.values(PACKING_COLS), 20, true))
                                };
                                resolve({ key: orderNumber, data: orderData });
                            } catch(err) {
                                reject(err);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    });
                });

                Promise.all(filePromises)
                    .then(results => {
                        results.forEach(result => loadedOrders.set(result.key, result.data));
                        updateOrderList();
                        render();
                    })
                    .catch(err => {
                        showModal('Error al Cargar', 'Uno o más archivos no pudieron ser procesados. Verifique el formato.', 'error');
                        console.error(err);
                    });
            }

            function extractTableData(worksheet, targetCols, startRow, isPacking = false) {
                 const headers = {};
                 const colsToUse = isPacking ? Object.keys(PACKING_COLS) : targetCols;
                 
                 colsToUse.forEach(key => {
                     const col = isPacking ? PACKING_COLS[key] : key;
                     const cell = worksheet[col + startRow];
                     if(cell && cell.v) headers[col] = cell.v.toString().trim();
                 });

                 if (Object.keys(headers).length === 0) return [];
                 const jsonData = [];
                 const range = XLSX.utils.decode_range(worksheet['!ref']);
                 for (let rowNum = startRow; rowNum <= range.e.r; ++rowNum) {
                     const row = {};
                     let hasData = false;
                     colsToUse.forEach(key => {
                         const col = isPacking ? PACKING_COLS[key] : key;
                         const headerName = headers[col];
                         if (headerName) {
                            const cellAddress = col + (rowNum + 1);
                            const cell = worksheet[cellAddress];
                            if(cell && cell.v) {
                                row[headerName] = cell.v;
                                hasData = true;
                            }
                         }
                     });
                     if (hasData) jsonData.push(row);
                 }
                 return jsonData;
            }
            
            function processRastreoData(data) {
                const today = new Date();
                const headers = Object.keys(data[0] || {});
                const scrapHeader = findHeader(headers, TRACKING_KEYS.IS_SCRAP);
                const dateHeader = findHeader(headers, TRACKING_KEYS.DATE_REGISTERED);
                
                return data.map(row => {
                    let status = 'normal';
                    const isScrap = String(row[scrapHeader]).trim().toUpperCase() === 'X';
                     if (isScrap) {
                        status = 'scrap';
                    } else {
                        const registeredDate = excelSerialToDate(row[dateHeader]);
                        if (registeredDate instanceof Date) {
                            if (registeredDate.toDateString() === today.toDateString()) status = 'today';
                            else if (registeredDate < today) status = 'delayed';
                        }
                    }
                    return { ...row, status };
                });
            }

            function groupEmpaqueData(data) {
                if (!data || data.length === 0) return new Map();
                const headers = Object.keys(data[0] || {});
                const boxIdHeader = findHeader(headers, PACKING_KEYS.BOX_ID);
                
                return data.reduce((acc, row) => {
                    const boxId = row[boxIdHeader];
                    if (boxId) {
                        if (!acc.has(boxId)) acc.set(boxId, []);
                        acc.get(boxId).push(row);
                    }
                    return acc;
                }, new Map());
            }

            // --- UI & RENDERING ---
            function switchMode(mode) {
                currentMode = mode;
                modeRastreo.classList.toggle('active', mode === 'rastreo');
                modeEmpaque.classList.toggle('active', mode === 'empaque');
                rastreoView.style.display = mode === 'rastreo' ? 'block' : 'none';
                empaqueView.style.display = mode === 'empaque' ? 'block' : 'none';
                render();
            }

            function updateOrderList() {
                orderList.innerHTML = '';
                const allBtn = document.createElement('button');
                allBtn.className = 'order-btn';
                allBtn.textContent = 'Vista General';
                allBtn.dataset.key = 'all';
                allBtn.onclick = () => setActiveOrder('all');
                orderList.appendChild(allBtn);

                for (const key of loadedOrders.keys()) {
                    const btn = document.createElement('button');
                    btn.className = 'order-btn';
                    btn.textContent = key;
                    btn.dataset.key = key;
                    btn.onclick = () => setActiveOrder(key);
                    orderList.appendChild(btn);
                }
                setActiveOrder(activeOrderKey); // Re-apply active state
            }
            
            function setActiveOrder(key) {
                activeOrderKey = key;
                const currentActive = orderList.querySelector('.active');
                if (currentActive) currentActive.classList.remove('active');
                const newActive = orderList.querySelector(`[data-key="${key}"]`);
                if (newActive) newActive.classList.add('active');
                render();
            }

            function render() {
                if (loadedOrders.size === 0) return;
                renderSummary();
                if (currentMode === 'rastreo') {
                    renderRastreoView(activeOrderKey);
                } else {
                    renderEmpaqueView(activeOrderKey);
                }
            }

            function renderSummary() {
                let orderQty = 0, packedQty = 0, scrapCount = 0;
                let ordersToProcess = [];

                if (activeOrderKey === 'all') {
                    ordersToProcess = Array.from(loadedOrders.values());
                    statOrderNumber.textContent = 'Múltiples';
                } else if (loadedOrders.has(activeOrderKey)) {
                    ordersToProcess = [loadedOrders.get(activeOrderKey)];
                    statOrderNumber.textContent = activeOrderKey;
                }

                ordersToProcess.forEach(order => {
                    orderQty += order.orderQty;
                    packedQty += order.packedQty;
                    const headers = Object.keys(order.rastreoData[0] || {});
                    const scrapHeader = findHeader(headers, TRACKING_KEYS.IS_SCRAP);
                    scrapCount += order.rastreoData.filter(row => String(row[scrapHeader]).trim().toUpperCase() === 'X').length;
                });

                statOrderQty.textContent = orderQty;
                statPackedQty.textContent = packedQty;
                statRemainingQty.textContent = orderQty - packedQty;
                statScrapQty.textContent = scrapCount;
            }
            
            function renderRastreoView(key) {
                let dataToShow = [];
                if (key === 'all') {
                    loadedOrders.forEach(order => dataToShow.push(...order.rastreoData));
                } else if (loadedOrders.has(key)) {
                    dataToShow = loadedOrders.get(key).rastreoData;
                }
                
                const rastreoTableContainer = document.getElementById('rastreoTableContainer');
                rastreoTableContainer.innerHTML = `
                    <div class="table-wrapper">
                        <table id="rastreoTable">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>`;

                const table = rastreoTableContainer.querySelector('#rastreoTable');
                if (dataToShow.length === 0) {
                     table.innerHTML = `<tr><td>No hay datos de rastreo para mostrar.</td></tr>`;
                    return;
                }
                
                const headers = Object.keys(dataToShow[0]).filter(h => h !== 'status');
                table.querySelector('thead').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = dataToShow.map(row => `
                    <tr class="is-${row.status}">
                        ${headers.map(h => `<td>${formatCell(row[h], h)}</td>`).join('')}
                    </tr>
                `).join('');
            }
            
             function renderEmpaqueView(key) {
                let dataToShow = new Map();
                if (key === 'all') {
                    loadedOrders.forEach(order => {
                        order.empaqueData.forEach((serials, boxId) => {
                            if (!dataToShow.has(boxId)) dataToShow.set(boxId, []);
                            dataToShow.get(boxId).push(...serials);
                        });
                    });
                } else if (loadedOrders.has(key)) {
                    dataToShow = loadedOrders.get(key).empaqueData;
                }
                
                const table = document.getElementById('empaqueTable');
                if (dataToShow.size === 0) {
                     table.innerHTML = `<thead><tr><th>No hay datos de empaque para mostrar.</th></tr></thead>`;
                    return;
                }
                
                const sampleRow = dataToShow.values().next().value[0];
                const headers = Object.keys(sampleRow);
                const boxIdHeader = findHeader(headers, PACKING_KEYS.BOX_ID);
                const serialHeader = findHeader(headers, PACKING_KEYS.SERIAL);
                const packedDateHeader = findHeader(headers, PACKING_KEYS.PACKED_DATE);
                const packerHeader = findHeader(headers, PACKING_KEYS.PACKER);

                const filterText = empaqueFilterInput.value.toLowerCase();
                let tableHTML = `
                    <thead>
                        <tr>
                            <th>${boxIdHeader}</th>
                            <th>Cantidad</th>
                            <th>Último Empaque</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                for (const [boxId, serials] of dataToShow.entries()) {
                    const latestDate = Math.max(...serials.map(s => s[packedDateHeader]));
                    
                    const serialsMatchFilter = serials.some(s => String(s[serialHeader]).toLowerCase().includes(filterText));
                    if (!String(boxId).toLowerCase().includes(filterText) && !serialsMatchFilter) continue;

                    tableHTML += `
                        <tr class="box-row" data-boxid="${boxId}">
                            <td>${boxId}</td>
                            <td>${serials.length}</td>
                            <td>${formatDate(excelSerialToDate(latestDate))}</td>
                        </tr>`;

                    serials.forEach(serial => {
                         tableHTML += `
                            <tr class="serial-row" data-parentbox="${boxId}">
                                <td colspan="3">
                                    <strong>Serial:</strong> ${serial[serialHeader]} | 
                                    <strong>Empacador:</strong> ${serial[packerHeader] || 'N/A'} | 
                                    <strong>Fecha:</strong> ${formatDate(excelSerialToDate(serial[packedDateHeader]))}
                                </td>
                            </tr>`;
                    });
                }
                tableHTML += `</tbody>`;
                table.innerHTML = tableHTML;

                table.querySelectorAll('.box-row').forEach(row => {
                    row.addEventListener('click', () => {
                        row.classList.toggle('expanded');
                        const boxId = row.dataset.boxid;
                        table.querySelectorAll(`.serial-row[data-parentbox="${boxId}"]`).forEach(serialRow => {
                            serialRow.style.display = row.classList.contains('expanded') ? 'table-row' : 'none';
                        });
                    });
                });
            }

            function formatCell(value, header) {
                 if (header.toLowerCase().includes('date')) return formatDate(excelSerialToDate(value));
                 return value === undefined ? '' : value;
            }

             function resetView() {
                loadedOrders.clear();
                activeOrderKey = 'all';
                currentMode = 'rastreo';
                orderList.innerHTML = `<p class="text-dark" style="font-size:0.9rem;">Cargue uno o más archivos para comenzar.</p>`;
                render();
            }

        });
    </script>
</body>
</html>