<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Órdenes Avanzado</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) Library for reading Excel/CSV files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-drop-area {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-drop-area.dragover {
            background-color: #e0f2fe;
            border-color: #38bdf8;
        }
        /* Spinner Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
     <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600 dark:text-sky-400">Rastreador de Órdenes Avanzado</h1>
            <p class="mt-2 text-lg text-slate-600 dark:text-slate-400">Sube, pega y analiza los datos de tus órdenes de producción.</p>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 space-y-6">
                <!-- File Upload Card -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b border-slate-200 dark:border-slate-700 pb-3">1. Cargar Archivo</h2>
                    <div id="fileDropArea" class="file-drop-area border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center cursor-pointer">
                        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
                            <span class="font-semibold text-sky-600 dark:text-sky-400">Arrastra y suelta</span> un archivo Excel o CSV aquí
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-500">o haz clic para seleccionar</p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
                    <p id="fileName" class="text-center mt-3 text-sm text-slate-500"></p>
                </div>

                <!-- Manual Paste Card -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b border-slate-200 dark:border-slate-700 pb-3">2. Pegar Datos Manualmente</h2>
                    <textarea id="dataInput" rows="8" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition" placeholder="Pega aquí los datos de la tabla..."></textarea>
                    <button id="processButton" class="w-full mt-4 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition duration-300">
                        Procesar Datos Pegados
                    </button>
                </div>
                 <!-- Filter Card -->
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b border-slate-200 dark:border-slate-700 pb-3">3. Filtrar Seriales</h2>
                    <input type="text" id="filterInput" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition" placeholder="Buscar por serial, línea, estación...">
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md min-h-[400px]">
                    <div id="resultsHeader" class="flex flex-wrap justify-between items-center mb-4 border-b border-slate-200 dark:border-slate-700 pb-3">
                         <h2 class="text-xl font-semibold">Resultados</h2>
                        <div class="text-right">
                           <p class="font-semibold text-lg">Orden: <span id="orderNumber" class="text-sky-600 dark:text-sky-400 font-bold">N/A</span></p>
                           <p class="text-sm text-slate-500 dark:text-slate-400">Total de seriales: <span id="serialCount" class="font-bold">0</span></p>
                        </div>
                    </div>

                    <!-- Line Counts Display -->
                    <div id="lineCounts" class="mb-4 hidden">
                        <h3 class="font-semibold text-md mb-2">Conteo por Línea:</h3>
                        <div id="lineCountsContainer" class="flex flex-wrap gap-2"></div>
                    </div>
                    
                    <div id="loader" class="hidden justify-center items-center py-16">
                        <div class="loader"></div>
                        <p class="ml-4 text-slate-500 dark:text-slate-400">Procesando archivo...</p>
                    </div>

                    <div id="output" class="overflow-x-auto">
                        <p id="placeholderText" class="text-center text-slate-500 dark:text-slate-400 py-16">
                            Los resultados del rastreo aparecerán aquí.
                        </p>
                        <table id="resultsTable" class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 hidden">
                            <thead class="bg-slate-50 dark:bg-slate-700">
                                <!-- Headers will be dynamically inserted here -->
                            </thead>
                            <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                                <!-- Rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileDropArea = document.getElementById('fileDropArea');
            const fileInput = document.getElementById('fileInput');
            const fileNameDisplay = document.getElementById('fileName');
            const dataInput = document.getElementById('dataInput');
            const processButton = document.getElementById('processButton');
            const filterInput = document.getElementById('filterInput');
            const resultsTable = document.getElementById('resultsTable');
            const tableBody = resultsTable.querySelector('tbody');
            const tableHead = resultsTable.querySelector('thead');
            const serialCount = document.getElementById('serialCount');
            const orderNumberDisplay = document.getElementById('orderNumber');
            const placeholderText = document.getElementById('placeholderText');
            const lineCounts = document.getElementById('lineCounts');
            const lineCountsContainer = document.getElementById('lineCountsContainer');
            const loader = document.getElementById('loader');

            let allData = [];

            // --- File Drag and Drop Logic ---
            fileDropArea.addEventListener('click', () => fileInput.click());
            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileDropArea.classList.add('dragover');
            });
            fileDropArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileDropArea.classList.remove('dragover');
            });
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileDropArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length) {
                    handleFile(files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFile(e.target.files[0]);
                }
            });

            // --- Core Logic Handlers ---
            processButton.addEventListener('click', () => {
                const data = dataInput.value.trim();
                if(data) {
                    resetView();
                    const parsedData = parsePastedData(data);
                    allData = parsedData;
                    displayData(allData);
                } else {
                    alert("Por favor, pega algunos datos en el área de texto.");
                }
            });

            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                if (!allData.length) return;

                const filteredData = allData.filter(row => 
                    Object.values(row).some(value => 
                        String(value).toLowerCase().includes(filterText)
                    )
                );
                displayData(filteredData, false); // false to avoid re-creating headers
                updateLineCounts(filteredData);
            });
            
            function handleFile(file) {
                fileNameDisplay.textContent = `Archivo: ${file.name}`;
                resetView();
                loader.style.display = 'flex';
                placeholderText.style.display = 'none';

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert sheet to an array of arrays to scan for order and headers
                    const sheetAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    const { order, headers, dataStartIndex } = findOrderAndTable(sheetAsArray);
                    
                    orderNumberDisplay.textContent = order || 'No encontrado';
                    
                    if(headers) {
                       // Now convert sheet to JSON with detected headers
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            range: dataStartIndex -1 // SheetJS range is 0-indexed, but we found row number
                        });

                        // Standardize keys to lowercase for easier access
                        const standardizedData = jsonData.map(row => {
                           const newRow = {};
                           for (const key in row) {
                               newRow[key.trim().toLowerCase()] = row[key];
                           }
                           return newRow;
                        });

                        allData = extractRelevantData(standardizedData);
                        displayData(allData);
                    } else {
                        placeholderText.textContent = "No se pudo detectar una tabla con cabeceras válidas (ej. 'Serial', 'Linea').";
                        placeholderText.style.display = 'block';
                    }
                    loader.style.display = 'none';
                };
                reader.readAsArrayBuffer(file);
            }
            
            /**
             * Scans the sheet (as an array) to find the order number and the table's header row.
             * Returns the order number, the detected headers, and the starting row index of data.
             */
            function findOrderAndTable(sheetArray) {
                let order = null;
                let headers = null;
                let dataStartIndex = -1;
                const MAX_SCAN_ROWS = 20; // Scan up to 20 rows for order/headers
                const REQUIRED_HEADERS = ['serial', 'linea', 'estacion'];

                for (let i = 0; i < sheetArray.length && i < MAX_SCAN_ROWS; i++) {
                    const row = sheetArray[i];
                    
                    // 1. Look for order number
                    if (!order) {
                        for(const cell of row) {
                            const cellStr = String(cell).toLowerCase();
                            if(cellStr.includes('orden') || cellStr.includes('order')) {
                                // Find the value in the same cell or the next one
                                const match = String(cell).match(/:\s*(\w+)|(\d+)/);
                                if(match && match[1]) {
                                    order = match[1];
                                } else if (row[row.indexOf(cell) + 1]) {
                                    order = row[row.indexOf(cell) + 1];
                                }
                                break; 
                            }
                        }
                    }

                    // 2. Look for header row
                    if (!headers) {
                        const lowercasedRow = row.map(h => String(h).trim().toLowerCase());
                        let foundHeaders = 0;
                        REQUIRED_HEADERS.forEach(reqHeader => {
                            if(lowercasedRow.includes(reqHeader)) {
                                foundHeaders++;
                            }
                        });

                        if (foundHeaders >= 2) { // Be flexible, require at least 2 key headers
                            headers = row.map(h => String(h).trim());
                            dataStartIndex = i + 1; // Data starts on the next row
                        }
                    }

                    if (order && headers) break;
                }

                return { order, headers, dataStartIndex };
            }
            
            /**
             * Takes the raw JSON data and extracts/maps it to a consistent format.
             */
            function extractRelevantData(data) {
                const MAPPING = {
                    'serial': ['serial', 'serial number', 'numero de serie'],
                    'linea': ['linea', 'line'],
                    'estacion': ['estacion', 'station'],
                    'fecha': ['fecha', 'date', 'timestamp'],
                    'status': ['status', 'estado']
                };

                return data.map(rawRow => {
                    const newRow = {};
                    for (const standardKey in MAPPING) {
                        for (const possibleKey of MAPPING[standardKey]) {
                            if (rawRow[possibleKey] !== undefined) {
                                newRow[standardKey.charAt(0).toUpperCase() + standardKey.slice(1)] = rawRow[possibleKey];
                                break;
                            }
                        }
                    }
                    return newRow;
                }).filter(row => row.Serial); // Only include rows that have a serial number
            }
            
            function parsePastedData(pastedText) {
                const rows = pastedText.split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) return [];

                const headers = rows[0].split('\t').map(h => h.trim());
                return rows.slice(1).map(rowText => {
                    const values = rowText.split('\t');
                    const rowObject = {};
                    headers.forEach((header, index) => {
                        rowObject[header] = values[index] ? values[index].trim() : '';
                    });
                    return rowObject;
                });
            }

            function displayData(data, createHeaders = true) {
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    serialCount.textContent = '0';
                    resultsTable.style.display = 'none';
                    placeholderText.textContent = 'No se encontraron datos que coincidan con la búsqueda.';
                    placeholderText.style.display = 'block';
                    lineCounts.style.display = 'none';
                    return;
                }
                
                resultsTable.style.display = 'table';
                placeholderText.style.display = 'none';
                
                // --- Create Table Headers (only once) ---
                if (createHeaders && data.length > 0) {
                    const headers = Object.keys(data[0]);
                    tableHead.innerHTML = `<tr>${headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
                }

                // --- Populate Table Body ---
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    // Apply conditional coloring
                    const status = (row.Status || row.status || '').toLowerCase();
                    if (status.includes('scrap')) {
                        tr.className = 'bg-red-100 dark:bg-red-900/50 hover:bg-red-200 dark:hover:bg-red-900/70';
                    } else if (status.includes('sin movimiento')) {
                         tr.className = 'bg-yellow-100 dark:bg-yellow-900/50 hover:bg-yellow-200 dark:hover:bg-yellow-900/70';
                    } else {
                        tr.className = 'hover:bg-slate-50 dark:hover:bg-slate-700/50';
                    }

                    // Create cells
                    const headers = Object.keys(data[0]);
                    tr.innerHTML = headers.map(header => `<td class="px-6 py-4 whitespace-nowrap text-sm">${row[header] || ''}</td>`).join('');
                    tableBody.appendChild(tr);
                });
                
                serialCount.textContent = data.length;
                updateLineCounts(data);
            }
            
            function updateLineCounts(data) {
                if (data.length === 0) {
                    lineCounts.style.display = 'none';
                    return;
                }

                const counts = data.reduce((acc, row) => {
                    const line = row.Linea || row.linea;
                    if(line) {
                       acc[line] = (acc[line] || 0) + 1;
                    }
                    return acc;
                }, {});

                if (Object.keys(counts).length > 0) {
                    lineCountsContainer.innerHTML = Object.entries(counts).map(([line, count]) => 
                        `<div class="bg-sky-100 dark:bg-sky-900/70 text-sky-800 dark:text-sky-200 text-xs font-semibold mr-2 px-2.5 py-1 rounded-full">
                            ${line}: <span class="font-bold">${count}</span>
                         </div>`
                    ).join('');
                    lineCounts.style.display = 'block';
                } else {
                    lineCounts.style.display = 'none';
                }
            }

            function resetView() {
                allData = [];
                tableBody.innerHTML = '';
                tableHead.innerHTML = '';
                serialCount.textContent = '0';
                orderNumberDisplay.textContent = 'N/A';
                resultsTable.style.display = 'none';
                lineCounts.style.display = 'none';
                filterInput.value = '';
                dataInput.value = '';
                fileInput.value = '';
                fileNameDisplay.textContent = '';
                placeholderText.textContent = 'Los resultados del rastreo aparecerán aquí.';
                placeholderText.style.display = 'block';
            }
        });
    </script>
</body>
</html>
