<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Control de Producción v3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    <style>
        /* =================================== */
        /* === REDISEÑO GLASSMORPHISM v3.0 === */
        /* =================================== */
        :root {
            /* Se definen los temas abajo */
        }

        body.dark-theme {
            --bg-gradient: linear-gradient(145deg, #1a1c20, #0a0a0a);
            --surface-color: rgba(30, 31, 34, 0.6);
            --surface-hover-color: rgba(55, 56, 61, 0.7);
            --border-color: rgba(255, 255, 255, 0.18);
            --primary-color: #E5E7EB; /* Light grey accent */
            --primary-text-color: #0A0A0A; /* Text on primary button */
            --danger-color: #FB7185; 
            --warning-color: #FBBF24; 
            --orange-color: #F97316;
            --success-color: #34D399; 
            --text-primary: #F1F5F9; 
            --text-secondary: #94A3B8;
            --text-dark: #64748B;
            --thead-bg: rgba(55, 65, 81, 0.8);
        }

        body.light-theme {
            --bg-gradient: linear-gradient(145deg, #f9fafb, #e5e7eb);
            --surface-color: rgba(255, 255, 255, 0.5);
            --surface-hover-color: rgba(243, 244, 246, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-color: #1F2937; /* Dark grey accent */
            --primary-text-color: #FFFFFF; /* Text on primary button */
            --danger-color: #EF4444; 
            --warning-color: #F59E0B; 
            --orange-color: #EA580C;
            --success-color: #10B981; 
            --text-primary: #111827; 
            --text-secondary: #4B5563;
            --text-dark: #9CA3AF;
            --thead-bg: rgba(229, 231, 235, 0.8);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shine-green {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        @keyframes shine-orange-reverse {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        body {
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient);
            color: var(--text-primary); 
            margin: 0; 
            padding: 32px 16px;
            display: flex; 
            justify-content: center;
            transition: background 0.3s ease-in-out;
        }

        .animated-startup {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        
        /* Contenedores Principales */
        .app-container { width: 100%; max-width: 1800px; }
        .app-header { text-align: center; margin-bottom: 16px; position: relative; }
        .app-branding { font-family: 'Tinos', 'Times New Roman', serif; font-weight: 400; font-size: 2.2rem; color: var(--text-primary); letter-spacing: 2px; margin: 0; }
        .app-title { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); margin: 4px 0 0 0; }
        .main-container { width: 100%; display: grid; grid-template-columns: 260px 1fr; grid-template-rows: auto auto 1fr; grid-template-areas: "sidebar global-header" "sidebar header" "sidebar main"; gap: 16px; }
        #sapView .main-container { grid-template-columns: 260px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "sidebar global-header" "sidebar main"; }
        
        /* Barra Lateral */
        .sidebar {
            grid-area: sidebar;
            background-color: transparent;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: sticky;
            align-self: start;

            /* === AJUSTE DE POSICIÓN VERTICAL === */
            /* Modifica el valor de 'top' para mover el panel hacia arriba o abajo. */
            /* Un valor más pequeño (ej. 180px) lo subirá; un valor más grande (ej. 200px) lo bajará. */
            top: 70px;

            /* La altura se ajusta automáticamente según el valor de 'top'. No es necesario cambiarla. */
            height: calc(100vh - 208px); /* Se calcula como (valor de top + padding inferior del body) */
        }
        /* Se oculta el H2 redundante en desktop para permitir la alineación de las tarjetas */
        .sidebar > h2 { display: none; }
        .sidebar .card h3 { text-align: center; }
        #sapView .sidebar > h2 { text-align: center; }
        #sapView .sidebar { height: calc(100vh - 208px); }
        #orderListCard, #sap-orderListCard { display: flex; flex-direction: column; overflow: hidden; }
        #orderList, #sapOrderList { flex-grow: 1; overflow-y: auto; }
        
        /* Layout General */
        .global-header { grid-area: global-header; }
        .header { grid-area: header; }
        .main-content { grid-area: main; display: flex; flex-direction: column; gap: 16px; }
        
        /* Estilo Glass para Cards y Modales */
        .card, .modal-content {
            background-color: var(--surface-color);
            background-image: linear-gradient(160deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.0) 100%);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        h2, h3 { margin-top: 0; margin-bottom: 12px; color: var(--text-secondary); font-weight: 600; font-size: 1rem; }
        h3 { font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        
        /* Área de Carga de Archivos */
        .file-drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .file-drop-area.disabled { cursor: not-allowed; background-color: rgba(0,0,0,0.2); border-color: #475569; }
        .file-drop-area.disabled p, .file-drop-area.disabled span { color: var(--text-dark); }
        .file-drop-area.dragover { background-color: var(--surface-hover-color); border-color: var(--primary-color); }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area span { color: var(--primary-color); font-weight: 500; }

        /* Estilo Botones */
        .btn, .filter-btn, .order-item .order-btn {
            padding: 8px 14px; border-radius: 8px; cursor: pointer;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
            color: var(--text-secondary); font-weight: 500;
            text-align: center; transition: all 0.2s; font-size: 0.9rem;
        }
        .btn:hover, .filter-btn:hover, .order-item .order-btn:hover { background-color: var(--surface-hover-color); color: var(--text-primary); border-color: rgba(255, 255, 255, 0.2); }
        .filter-btn.active { color: var(--primary-text-color); font-weight: 700; background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn { width: 100%; padding: 10px; background-color: var(--primary-color); color: var(--primary-text-color); font-weight: 700;}
        .btn.btn-danger { background-color: var(--danger-color); color: var(--text-primary); }
        .btn.btn-danger:hover { background-color: #f8516d; }
        .btn:disabled { background-color: var(--surface-color); opacity: 0.5; color: var(--text-dark); cursor: not-allowed; border-color: var(--border-color);}
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .light-theme .btn:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* Lista de Órdenes */
        .order-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .order-item .order-btn { flex-grow: 1; text-align: center; padding: 10px; white-space: nowrap; }
        .order-item .order-btn.active { background-color: var(--primary-color); color: var(--primary-text-color); }
        .order-item .order-btn.is-complete {
            background-color: rgba(52, 211, 153, 0.1);
            color: var(--success-color);
            border-color: var(--success-color);
            position: relative;
            overflow: hidden;
        }
        .order-item .order-btn.is-complete::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0) 80%);
            transform: translateX(-100%);
            animation: shine-green 4s infinite linear;
        }
        .order-item .order-btn.is-complete:hover { background-color: rgba(52, 211, 153, 0.2); }
        .order-item .order-btn.is-complete.active { box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.4); }
        .order-item .icon-btn { background: none; border: none; color: var(--text-dark); cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 1.2rem; filter: grayscale(1) opacity(0.6); }
        .order-item .icon-btn:hover { color: var(--text-primary); filter: grayscale(0) opacity(1); }
        
        /* Switchers */
        .mode-switcher { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 4px; background-color: rgba(0,0,0,0.1); border-radius: 10px; }
        .light-theme .mode-switcher { background-color: rgba(0,0,0,0.05); }
        #mainModeSwitcher { grid-template-columns: 1fr 1fr; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto; }
        .mode-switcher button { padding: 8px; border: none; background-color: transparent; color: var(--text-secondary); font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .mode-switcher button.active { background-color: var(--surface-color); color: var(--text-primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
        .light-theme .mode-switcher button.active { color: var(--primary-color); }
        .header > .mode-switcher { margin-bottom: 20px; }
        
        /* Stats */
        .summary-card, .global-dashboard-card { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; text-align: center; }
        .stat-item { display: flex; flex-direction: column; justify-content: flex-start; }
        .stat-item h3 { margin-bottom: 8px; font-size: 0.9rem; font-weight: 500; }
        .stat-item .stat-value-wrapper { margin-top: auto; }
        .stat-item p { margin: 0; font-size: 1.75rem; font-weight: 700; }
        #statOrderNumber { color: var(--text-secondary); }
        #statCatalogNumber { font-size: 1rem; color: var(--text-primary); font-weight: 500; margin-top: 4px; height: auto; }
        #statPackedQty, #sapCompletedOrdersStat, #completedOrdersStat { color: var(--success-color); }
        #statRemainingQty, #sapTotalOrdersStat, #totalOrdersStat { color: var(--warning-color); } 
        #statScrapQty { color: var(--danger-color); }

        /* Tabla y Contenido de Empaque */
        .table-wrapper { overflow: auto; flex-grow: 1; transition: opacity 0.3s ease-in-out; }
        #tableCard { display: flex; flex-direction: column; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem;}
        thead { position: sticky; top: 0; background-color: var(--thead-bg); backdrop-filter: blur(5px); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; }
        #lineCountsContainer { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .line-badge { background-color: var(--surface-hover-color); padding: 4px 12px; border-radius: 16px; font-size: 0.8rem; font-weight: 500; color: var(--text-dark); }
        .line-badge span { font-weight: 700; color: var(--text-secondary); }
        .box-row { cursor: pointer; }
        .box-row:hover { background-color: var(--surface-hover-color); }
        .box-row td:first-child::before { content: '►'; display: inline-block; margin-right: 10px; font-size: 0.7rem; transition: transform 0.2s; }
        .box-row.expanded td:first-child::before { transform: rotate(90deg); }
        .serial-row { display: none; }
        .box-row.expanded + .serial-row { display: table-row; }
        .serial-row td { background-color: transparent; padding: 12px 20px 12px 40px; border-color: #2a3a5e; }
        .box-summary-info { padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        
        tbody tr.is-scrap { background-color: rgba(251, 113, 133, 0.1) !important; }
        tbody tr.is-scrap td { color: var(--danger-color) !important; }
        tbody tr.is-very_delayed { background-color: rgba(249, 115, 22, 0.1) !important; position: relative; overflow: hidden; }
        tbody tr.is-very_delayed::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(249, 115, 22, 0.15) 50%, rgba(255,255,255,0) 80%); transform: translateX(100%); animation: shine-orange-reverse 3s infinite linear; }
        tbody tr.is-very_delayed td { color: var(--orange-color) !important; }
        tbody tr.is-delayed { background-color: rgba(251, 191, 36, 0.1) !important; }
        tbody tr.is-delayed td { color: var(--warning-color) !important; }
        tbody tr.is-today, tbody tr.is-complete-sap { background-color: rgba(52, 211, 153, 0.1) !important; position: relative; overflow: hidden; }
        tbody tr.is-today::after, tbody tr.is-complete-sap::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0) 80%); transform: translateX(-100%); animation: shine-green 4s infinite linear; animation-delay: 1.5s; }
        tbody tr.is-today td, tbody tr.is-complete-sap td { color: var(--success-color) !important; }
        tbody tr.is-incomplete-sap { background-color: rgba(251, 191, 36, 0.1) !important; }
        tbody tr.is-incomplete-sap td { color: var(--warning-color) !important; }
        tbody tr.is-late-sap { background-color: rgba(251, 113, 133, 0.1) !important; }
        tbody tr.is-late-sap td { color: var(--danger-color) !important; }
        
        /* Modales */
        #loader, #placeholderText, #sapPlaceholderText { text-align: center; padding: 60px; color: var(--text-dark); font-size: 1.1rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
        #modalBody .status-report { font-family: 'Inter', sans-serif; font-size: 0.95rem; white-space: pre-wrap; color: var(--text-primary); }
        #modalBody .status-report h4 { font-size: 1.1rem; color: var(--primary-color); margin: 16px 0 8px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        #modalBody .status-report p { margin: 4px 0; }
        #modalBody .status-report strong { color: var(--text-secondary); }
        #modalBody input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-primary); margin-top: 10px; box-sizing: border-box;}
        #modalBody .area-list { list-style: none; padding: 0; margin-top: 16px; }
        #modalBody .area-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); gap: 10px;}
        #modalBody .area-list li input { flex-grow: 1; margin: 0; }

        /* Transiciones de Vista */
        #fwdView, #sapView { transition: opacity 0.3s ease-in-out; }
        body.mode-fwd #sapView, body.mode-sap #fwdView { display: none; }
        #empaqueView { display: none; }
        
        .date-group { margin-bottom: 8px; }
        .date-header { width: 100%; background-color: transparent; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .date-header:hover { background-color: var(--surface-hover-color); }
        .date-header.active { background-color: var(--surface-hover-color); color: var(--text-primary); }
        .date-header .status-indicator { font-weight: 400; font-size: 0.8rem; color: var(--success-color); }
        .date-header .collapse-icon { transition: transform 0.2s; }
        .date-group.expanded .date-header .collapse-icon { transform: rotate(90deg); }
        .orders-for-date { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-left: 12px; border-left: 2px solid var(--border-color); margin-top: 0; }
        .date-group.expanded .orders-for-date { max-height: 1000px; margin-top: 8px; }
        
        /* Media Queries */
        @media (max-width: 992px) {
            body { padding: 8px; }
            .main-container { display: flex; flex-direction: column; gap: 12px; }
            .sidebar { position: static; height: auto; }
            .sidebar, .main-content { display: contents !important; }
            #sap-uploadCard { display: none; }
            .sidebar > h2 { display: none; }
            #adminBtn { display: none; }
            #areaSelectBtn { flex-grow: 1 !important; }
            .card-row { grid-template-columns: 1fr; }
            #desktop-controls-container { display: none; }
            .global-header { order: 1; }
            .header { order: 2; }
            #uploadCard { order: 3; }
            #orderListCard, #sap-orderListCard { order: 4; }
            #rastreoView, #empaqueView { order: 5; }
            #sap-tableCard { order: 6; }
            .global-dashboard-card { grid-template-columns: 1fr 1fr; }
            .summary-card { grid-template-columns: 1fr 1fr; & > .stat-item:has(.stat-value-wrapper > #statOrderNumber) { grid-column: 1 / -1; } }
            .stat-item p { font-size: 1.5rem; }
            .card.mobile-collapsible .card-content { display: none; padding-top: 16px; }
            .card.mobile-collapsible.expanded .card-content { display: block; }
            .card.mobile-collapsible h3.mobile-trigger { margin-bottom: 0; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
            .card.mobile-collapsible:not(.expanded) h3.mobile-trigger { border-bottom: 1px solid var(--border-color); }
            .card.mobile-collapsible h3.mobile-trigger::after { content: '►'; display: inline-block; font-size: 0.7rem; transition: transform 0.2s; color: var(--text-secondary); }
            .card.mobile-collapsible.expanded h3.mobile-trigger::after { transform: rotate(90deg); }
            #rastreoTable thead, #empaqueTable thead, #sapTable thead { display: none; }
            #rastreoTable tr, #sapTable tr { display: block; margin-bottom: 1rem; border-radius: 8px; border: 1px solid var(--border-color); padding: 1rem; }
            #rastreoTable td, #sapTable td { display: flex; justify-content: space-between; text-align: right; border: none; padding: 0.5rem 0; white-space: normal; border-bottom: 1px solid rgba(15, 23, 42, 0.5); }
            #rastreoTable tr td:last-child, #sapTable tr td:last-child { border-bottom: none; }
            #rastreoTable td::before, #sapTable td::before { content: attr(data-label); float: left; font-weight: bold; text-align: left; margin-right: 1rem; color: var(--text-secondary); }
            #empaqueTableContainer { display: none; }
            .mobile-packing-list details { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
            .mobile-packing-list summary { padding: 1rem; cursor: pointer; list-style: none; }
            .mobile-packing-list summary::-webkit-details-marker { display: none; }
            .summary-content { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
            .summary-content div:first-child::before { content: '►'; display: inline-block; margin-right: 10px; font-size: 0.7rem; transition: transform 0.2s; }
            details[open] > summary .summary-content div:first-child::before { transform: rotate(90deg); }
            .box-id-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
            .box-details-summary { text-align: right; }
            .mobile-packing-list .serial-details-container { padding: 0 1rem 1rem 1rem; }
        }
        
        @media (min-width: 993px) {
            #mainModeSwitcher { margin-left: auto; margin-right: auto; }
            #mobile-controls-row { display: none; }
            #desktop-controls-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
            .desktop-filters-group { display: flex; align-items: center; flex-wrap: wrap; gap: 16px; flex-grow: 1; }
            .desktop-actions-group { display: flex; flex-shrink: 0; }
            .filter-group-inline { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
            .filter-label { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
            #desktop-controls-container .btn, #desktop-controls-container .filter-btn { width: auto; padding: 4px 10px; font-size: 0.8rem; margin: 0; }
            #desktop-controls-container .btn { padding: 5px 10px; font-size: 0.75rem; }
            #empaqueMobileContainer { display: none; }
        }
    </style>
</head>
<body class="dark-theme">
    <div class="app-container">
        <header class="app-header animated-startup" style="animation-delay: 0s;">
            <h1 class="app-branding">CORNING</h1>
            <h2 id="app-title" class="app-title">Centro de Rastreo de Órdenes</h2>
        </header>

        <div id="mainModeSwitcher" class="mode-switcher card animated-startup" style="animation-delay: 0.1s;">
            <button id="modeFwd" class="active">FWD</button>
            <button id="modeSap">SAP</button>
        </div>

        <div id="fwdView">
            <div class="main-container">
                <header class="global-header card animated-startup" style="animation-delay: 0.3s;">
                    <div class="global-dashboard-card">
                            <div class="stat-item"><h3>Órdenes del Día</h3><p id="totalOrdersStat">0</p></div>
                            <div class="stat-item"><h3>Órdenes Terminadas</h3><p id="completedOrdersStat">0</p></div>
                    </div>
                </header>
                <aside class="sidebar animated-startup" style="animation-delay: 0.2s;">
                    <h2>Panel de Control</h2>
                    <div class="card" id="uploadCard">
                        <h3>Panel de Control</h3>
                        <div class="card-content">
                             <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                                 <button id="areaSelectBtn" class="btn" style="flex: 1; align-self: stretch;">Área: MULTIPORT</button>
                                 <div style="display: flex; flex-direction: column; gap: 8px;">
                                     <button id="adminBtn" class="btn" style="padding: 6px 12px; line-height: 1;">⚙️</button>
                                     <button id="themeToggleBtn" class="btn" style="padding: 6px 12px; font-size: 1.2rem; line-height: 1;">☀️</button>
                                 </div>
                             </div>
                            <div id="fileDropArea" class="file-drop-area disabled">
                                <p>Arrastra archivos (.xlsx) para cargar/actualizar</p>
                                <p><span>o haz clic para seleccionar</span></p>
                            </div>
                            <input type="file" id="fileInput" accept=".xlsx, .xls" multiple style="display: none;">
                            <input type="file" id="updateFileInput" accept=".xlsx, .xls" style="display: none;">
                        </div>
                    </div>
                    <div class="card" style="flex-grow: 1;" id="orderListCard">
                        <h3>Órdenes Cargadas</h3>
                        <div id="orderList" class="card-content">
                            <p class="text-dark" style="font-size:0.9rem;">Cargando órdenes desde la base de datos...</p>
                        </div>
                    </div>
                </aside>
        
                <section class="header card animated-startup" style="animation-delay: 0.4s;">
                        <div class="mode-switcher">
                            <button id="modeRastreo" class="active">Rastreo</button>
                            <button id="modeEmpaque">Empaque</button>
                        </div>
                    <div id="summaryCard" class="summary-card">
                           <div class="stat-item">
                                <h3>Orden</h3>
                                <div class="stat-value-wrapper">
                                    <p id="statOrderNumber">N/A</p>
                                    <p id="statCatalogNumber"></p>
                                </div>
                           </div>
                           <div class="stat-item">
                               <h3>Cant. Orden</h3>
                               <div class="stat-value-wrapper">
                                   <p id="statOrderQty">0</p>
                               </div>
                           </div>
                           <div class="stat-item">
                               <h3>Cant. Empacada</h3>
                               <div class="stat-value-wrapper">
                                   <p id="statPackedQty">0</p>
                               </div>
                            </div>
                           <div class="stat-item">
                               <h3>Restante</h3>
                               <div class="stat-value-wrapper">
                                   <p id="statRemainingQty">0</p>
                               </div>
                            </div>
                           <div class="stat-item">
                               <h3>Cant. en Scrap</h3>
                               <div class="stat-value-wrapper">
                                   <p id="statScrapQty">0</p>
                               </div>
                           </div>
                    </div>
                </section>
        
                <main class="main-content animated-startup" style="animation-delay: 0.5s;">
                    <div id="rastreoView">
                        <div class="card-row" id="mobile-controls-row">
                            <div class="card mobile-collapsible" id="filtersCard">
                                <h3 class="mobile-trigger">Filtros</h3>
                                <div class="card-content">
                                    <div class="filter-container">
                                        <div>
                                            <h3>Filtrar por Estado</h3>
                                            <div id="rastreoStatusFilters" class="filter-group"></div>
                                        </div>
                                        <div>
                                            <h3>Filtrar por Línea</h3>
                                            <div id="rastreoLineFilters" class="filter-group"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mobile-collapsible" id="actionsCard">
                                <h3 class="mobile-trigger">Acciones</h3>
                                <div class="card-content">
                                    <div class="actions-container"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card" id="tableCard">
                            <div id="desktop-controls-container">
                                <div class="desktop-filters-group">
                                    <div class="filter-group-inline">
                                        <span class="filter-label">Estado:</span>
                                        <div id="rastreoStatusFiltersDesktop" class="filter-group"></div>
                                    </div>
                                    <div class="filter-group-inline">
                                        <span class="filter-label">Línea:</span>
                                        <div id="rastreoLineFiltersDesktop" class="filter-group"></div>
                                    </div>
                                </div>
                                <div class="desktop-actions-group">
                                    <div id="desktop-actions-wrapper" class="filter-group"></div>
                                </div>
                            </div>
                            <input type="text" id="rastreoFilterInput" placeholder="Buscar en la tabla por serial, status, etc..." style="margin-bottom: 16px;">
                            <div id="lineCountsContainer"></div>
                            <div class="table-wrapper">
                                <table id="rastreoTable"></table>
                                <p id="placeholderText">Cargando datos...</p>
                            </div>
                        </div>
                    </div>
                    <div id="empaqueView">
                        <div class="card" style="height:100%;">
                            <input type="text" id="empaqueFilterInput" placeholder="Buscar por Serial o BoxID..." style="margin-bottom:16px">
                            <div id="empaqueTableContainer" class="table-wrapper">
                                <table id="empaqueTable"></table>
                            </div>
                            <div id="empaqueMobileContainer"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="sapView">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.2s;">
                    <h2>Panel SAP</h2>
                    <div class="card" id="sap-uploadCard">
                        <h3>Panel de Control</h3>
                         <div id="sapFileDropArea" class="file-drop-area disabled">
                             <p>Arrastra un archivo de SAP (.xlsx)</p>
                             <p><span>o haz clic para seleccionar</span></p>
                         </div>
                        <input type="file" id="sapFileInput" accept=".xlsx, .xls" style="display: none;">
                    </div>
                    <div class="card" style="flex-grow: 1;" id="sap-orderListCard">
                        <h3>Órdenes Cargadas</h3>
                        <div id="sapOrderList" class="card-content">
                           <p class="text-dark" style="font-size:0.9rem;">Cargue un archivo para ver las órdenes.</p>
                        </div>
                    </div>
                </aside>
                <header class="global-header card animated-startup" style="animation-delay: 0.3s;">
                     <div class="global-dashboard-card">
                            <div class="stat-item"><h3>Órdenes del Día</h3><p id="sapTotalOrdersStat">0</p></div>
                            <div class="stat-item"><h3>Órdenes Confirmadas</h3><p id="sapCompletedOrdersStat">0</p></div>
                     </div>
                </header>
                <main class="main-content animated-startup" style="animation-delay: 0.4s;">
                     <div class="card" id="sap-tableCard">
                         <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem;">
                             <h3>Detalle de Órdenes SAP</h3>
                             <button id="sapResetFilter" class="filter-btn" style="display: none;">Mostrar Hoy/Tarde</button>
                         </div>
                         <div class="table-wrapper">
                             <table id="sapTable"></table>
                             <p id="sapPlaceholderText">Cargue un archivo para ver los datos de SAP.</p>
                         </div>
                     </div>
                </main>
            </div>
        </div>

    </div>
    
    <div id="modalOverlay" class="modal-overlay">
        <div id="modalContent" class="modal-content">
             <span id="modalClose" class="modal-close">&times;</span>
             <h2 id="modalTitle" class="modal-title"></h2>
             <div id="modalBody" style="margin-top:16px; color: var(--text-secondary); max-height: 70vh; overflow-y: auto;"></div>
             <button id="copyReportBtn" class="btn" style="margin-top: 20px; display:none;">Copiar al Portapapeles</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0",
            authDomain: "rastreador-de-ordenes.firebaseapp.com",
            projectId: "rastreador-de-ordenes",
            storageBucket: "rastreador-de-ordenes.appspot.com",
            messagingSenderId: "956052823395",
            appId: "1:956052823395:web:2ba74d9591d2b24c3cc756"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            // State variables
            let loadedOrders = new Map();
            let sapData = [];
            let sapDateFilter = 'default';
            let activeOrderKey = 'all';
            let currentMode = 'rastreo';
            let mainMode = 'fwd';
            let currentVisibleData = []; 
            let orderToUpdateKey = null;
            let rastreoStatusFilter = 'all';
            let rastreoLineFilter = 'all';
            let isAdminAuthenticated = false;
            let currentArea = 'MULTIPORT';
            let fwdListener = null;
            let sapListener = null;


            // Key Maps
            const TRACKING_KEYS = { SERIAL: 'Product Serial Number', IS_SCRAP: 'Is Scrap', NOT_PACKED: 'Not Packed', CREATED_BY: 'Created By', DATE_REGISTERED: 'Date Registered', LINE: 'Line', STATION: 'Station' };
            const PACKING_KEYS = { SERIAL: 'Serial Number', EMPLOYEE_ID: 'Employee ID', PACKED_DATE: 'Finish Packed Date', BOX_ID: 'BoxID' };
            
            // Element cache
            const doc = (id) => document.getElementById(id);
            const appTitle = doc('app-title');
            const fileDropArea = doc('fileDropArea');
            const fileInput = doc('fileInput');
            const updateFileInput = doc('updateFileInput');
            const orderList = doc('orderList');
            const statOrderNumber = doc('statOrderNumber');
            const statCatalogNumber = doc('statCatalogNumber');
            const statOrderQty = doc('statOrderQty');
            const statPackedQty = doc('statPackedQty');
            const statRemainingQty = doc('statRemainingQty');
            const statScrapQty = doc('statScrapQty');
            const totalOrdersStat = doc('totalOrdersStat');
            const completedOrdersStat = doc('completedOrdersStat');
            const modeRastreo = doc('modeRastreo');
            const modeEmpaque = doc('modeEmpaque');
            const rastreoFilterInput = doc('rastreoFilterInput');
            const areaSelectBtn = doc('areaSelectBtn');
            const adminBtn = doc('adminBtn');
            const themeToggleBtn = doc('themeToggleBtn');
            
            // Control Containers
            const mobileControls = {
                status: doc('rastreoStatusFilters'),
                line: doc('rastreoLineFilters'),
                actions: doc('actionsCard').querySelector('.actions-container')
            };
            const desktopControls = {
                status: doc('rastreoStatusFiltersDesktop'),
                line: doc('rastreoLineFiltersDesktop'),
                actions: doc('desktop-actions-wrapper')
            };

            const placeholderText = doc('placeholderText');
            const empaqueFilterInput = doc('empaqueFilterInput');
            const sapFileDropArea = doc('sapFileDropArea');
            const sapFileInput = doc('sapFileInput');
            const sapPlaceholderText = doc('sapPlaceholderText');
            const sapOrderList = doc('sapOrderList');
            const sapTotalOrdersStat = doc('sapTotalOrdersStat');
            const sapCompletedOrdersStat = doc('sapCompletedOrdersStat');
            const sapResetFilterBtn = doc('sapResetFilter');
            const modeFwd = doc('modeFwd');
            const modeSap = doc('modeSap');
            const modalOverlay = doc('modalOverlay');
            const modalTitle = doc('modalTitle');
            const modalBody = doc('modalBody');
            const modalClose = doc('modalClose');
            const copyReportBtn = doc('copyReportBtn');

            // === EVENT LISTENERS ===
            modeFwd.addEventListener('click', () => switchMainMode('fwd'));
            modeSap.addEventListener('click', () => switchMainMode('sap'));
            fileDropArea.addEventListener('click', () => { if(!fileDropArea.classList.contains('disabled')) fileInput.click(); });
            fileDropArea.addEventListener('dragover', (e) => { if(!fileDropArea.classList.contains('disabled')) { e.preventDefault(); fileDropArea.classList.add('dragover'); }});
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => {
                if(!fileDropArea.classList.contains('disabled')) {
                    e.preventDefault(); fileDropArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
                }
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files); });
            updateFileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files, true); });
            modeRastreo.addEventListener('click', () => switchMode('rastreo'));
            modeEmpaque.addEventListener('click', () => switchMode('empaque'));
            rastreoFilterInput.addEventListener('input', () => renderRastreoView(activeOrderKey));
            empaqueFilterInput.addEventListener('input', () => renderEmpaqueView(activeOrderKey));

            const handleFilterClick = (e) => {
                if (e.target.matches('.filter-btn')) {
                    const group = e.target.closest('.filter-group');
                    const filterType = group.id.includes('Status') ? 'status' : 'line';
                    
                    document.querySelectorAll(`#${group.id}`).forEach(g => {
                        const active = g.querySelector('.active');
                        if(active) active.classList.remove('active');
                        const btnToActivate = g.querySelector(`[data-filter="${e.target.dataset.filter}"]`);
                        if(btnToActivate) btnToActivate.classList.add('active');
                    });

                    if (filterType === 'status') {
                        rastreoStatusFilter = e.target.dataset.filter;
                    } else {
                        rastreoLineFilter = e.target.dataset.filter;
                    }
                    renderRastreoView(activeOrderKey);
                }
            };
            
            mobileControls.status.addEventListener('click', handleFilterClick);
            desktopControls.status.addEventListener('click', handleFilterClick);
            mobileControls.line.addEventListener('click', handleFilterClick);
            desktopControls.line.addEventListener('click', handleFilterClick);

            sapFileDropArea.addEventListener('click', () => { if (!sapFileDropArea.classList.contains('disabled')) sapFileInput.click(); });
            sapFileDropArea.addEventListener('dragover', (e) => { if (!sapFileDropArea.classList.contains('disabled')) { e.preventDefault(); sapFileDropArea.classList.add('dragover'); }});
            sapFileDropArea.addEventListener('dragleave', () => sapFileDropArea.classList.remove('dragover'));
            sapFileDropArea.addEventListener('drop', (e) => {
                if (!sapFileDropArea.classList.contains('disabled')) {
                    e.preventDefault(); sapFileDropArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) handleSapFile(e.dataTransfer.files[0]);
                }
            });
            sapFileInput.addEventListener('change', (e) => { if (e.target.files.length) handleSapFile(e.target.files[0]); });
            sapResetFilterBtn.addEventListener('click', () => {
                sapDateFilter = 'default';
                renderSapView();
            });
            modalClose.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });
            adminBtn.addEventListener('click', () => {
                if (isAdminAuthenticated) {
                    showAdminPanel();
                } else {
                    showAdminLogin();
                }
            });
            areaSelectBtn.addEventListener('click', showAreaSelector);

            // ===================================
            // === CORE APP CONTROL & UTILITIES ===
            // ===================================
            function switchMainMode(mode) {
                if (mainMode === mode) return;

                const oldView = doc(`${mainMode}View`);
                const newView = doc(`${mode}View`);

                oldView.style.opacity = 0;

                setTimeout(() => {
                    oldView.style.display = 'none';
                    document.body.classList.remove('mode-fwd', 'mode-sap');
                    
                    newView.style.display = 'block';
                    document.body.classList.add(`mode-${mode}`);
                    
                    requestAnimationFrame(() => {
                        newView.style.opacity = 1;
                    });

                    mainMode = mode;
                    localStorage.setItem('mainMode', mode);
                    modeFwd.classList.toggle('active', mode === 'fwd');
                    modeSap.classList.toggle('active', mode === 'sap');
                    appTitle.textContent = mode === 'fwd' ? 'Centro de Rastreo de Órdenes' : 'Análisis de Órdenes SAP';
                    render();
                }, 300);
            }
            
            function showModal(title, content, type = 'info', showCopyBtn = false) {
                 modalOverlay.querySelector('.modal-content').className = `modal-content ${type}`;
                 modalTitle.textContent = title;
                 modalBody.innerHTML = content;
                 copyReportBtn.textContent = 'Copiar al Portapapeles';
                 copyReportBtn.style.display = showCopyBtn ? 'block' : 'none';
                 if (showCopyBtn) {
                     copyReportBtn.onclick = () => {
                         const reportContent = modalBody.querySelector('.status-report')?.innerText || modalBody.innerText;
                         navigator.clipboard.writeText(reportContent).then(() => {
                             copyReportBtn.textContent = '¡Copiado!';
                             setTimeout(() => copyReportBtn.textContent = 'Copiar al Portapapeles', 2000);
                         }, () => {
                           showModal('Error', 'No se pudo copiar el reporte.', 'error');
                         });
                     };
                 }
                 modalOverlay.classList.add('visible');
            }

            function showConfirmationModal(message, onConfirmCallback) {
                const content = `
                    <p>${message}</p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="confirmBtn" class="btn btn-danger" style="flex: 1;">Confirmar</button>
                        <button id="cancelBtn" class="btn" style="flex: 1; background-color: var(--border-color);">Cancelar</button>
                    </div>
                `;
                showModal('Confirmar Acción', content);
                doc('confirmBtn').onclick = () => {
                    onConfirmCallback();
                    hideModal();
                };
                doc('cancelBtn').onclick = hideModal;
            }


            function hideModal() { modalOverlay.classList.remove('visible'); }

            function excelSerialToDate(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                try {
                    const decoded = XLSX.SSF.parse_date_code(serial);
                    if (decoded) return new Date(Date.UTC(decoded.y, decoded.m - 1, decoded.d, decoded.H, decoded.M, decoded.S));
                } catch(e) { console.error("Error al parsear la fecha serial de Excel:", e); }
                return null;
            }

            function formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                return date.toLocaleDateString('es-ES', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            function formatDateTime(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                 const day = String(date.getUTCDate()).padStart(2, '0');
                 const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                 const year = date.getUTCFullYear();
                 const hours = String(date.getUTCHours()).padStart(2, '0');
                 const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }
            function findHeader(headers, keyText) { return headers && headers.find(h => h && h.toLowerCase() === keyText.toLowerCase()); }
            
            // =========================
            // === FWD VIEW FUNCTIONS ===
            // =========================
            async function saveOrderToFirebase(orderKey, orderData) {
                try {
                    const empaqueDataForDB = Array.from(orderData.empaqueData.entries()).map(([boxId, serials]) => ({ boxId, serials }));
                    const dataToSave = { ...orderData, empaqueData: empaqueDataForDB, lastUpdated: new Date() };
                    await db.collection('areas').doc(currentArea).collection('orders').doc(orderKey).set(dataToSave, { merge: true });
                } catch (e) {
                    console.error("Error al guardar en Firebase: ", e);
                    showModal('Error al Guardar', `No se pudo guardar la orden ${orderKey}.`, 'error');
                }
            }

            async function deleteOrderFromFirebase(orderKey) {
                try {
                    await db.collection('areas').doc(currentArea).collection('orders').doc(orderKey).delete();
                } catch (e) {
                     console.error("Error al eliminar en Firebase: ", e);
                    showModal('Error al Eliminar', `No se pudo eliminar la orden ${orderKey}.`, 'error');
                }
            }

            function handleFiles(files, isUpdate = false) {
                const excelFiles = Array.from(files).filter(f => f.name.endsWith('.xlsx') || f.name.endsWith('.xls'));
                const filePromises = excelFiles.map(file => processFile(file, isUpdate));

                Promise.all(filePromises)
                    .then(results => {
                        let lastKey = activeOrderKey;
                        const updatePromises = [];
                        results.forEach(result => {
                            if (result) {
                                loadedOrders.set(result.key, result.data);
                                updatePromises.push(saveOrderToFirebase(result.key, result.data));
                                lastKey = result.key;
                            }
                        });
                        
                        Promise.all(updatePromises).then(() => {
                            showModal('Éxito', `${results.length} orden(es) cargada(s) y guardada(s).`, 'success');
                        });
                    })
                    .catch(err => {
                        showModal('Error al Cargar', 'Uno o más archivos no pudieron ser procesados.', 'error');
                        console.error("Error detallado en handleFiles:", err);
                    });
            }

            function processFile(file, isUpdate) {
                 return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const orderNumber = String(worksheet['B3']?.v || `Archivo_${file.name.slice(0,10)}`);
                            const keyToUse = isUpdate ? orderToUpdateKey : orderNumber;
                            const TRACKING_COLS = ['B', 'C', 'G', 'K', 'M', 'P', 'V', 'Y', 'Z', 'AA', 'AB'];
                            const PACKING_COLS = ['AE', 'AF', 'AK', 'AO'];
                            const rastreoRawData = extractTableData(worksheet, TRACKING_COLS, 20);
                            const packingRawData = extractTableData(worksheet, PACKING_COLS, 20);
                            
                            const orderData = {
                                orderQty: parseInt(worksheet['O3']?.v || 0),
                                packedQty: parseInt(worksheet['U3']?.v || 0),
                                catalogNumber: worksheet['I3']?.v || 'N/A',
                                orderDate: excelSerialToDate(worksheet['E6']?.v) || new Date(),
                                rastreoData: processRastreoData(rastreoRawData),
                                empaqueData: groupEmpaqueData(packingRawData),
                                headers: {
                                    rastreo: Object.keys(rastreoRawData[0] || {}),
                                    empaque: Object.keys(packingRawData[0] || {})
                                }
                            };
                            resolve({ key: keyToUse, data: orderData });
                        } catch(err) { reject(err); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }

            function extractTableData(worksheet, cols, startRow) {
                const headers = {};
                cols.forEach(col => {
                    const cell = worksheet[col + startRow];
                    if(cell && cell.v) headers[col] = cell.v.toString().trim();
                });

                if (Object.keys(headers).length === 0) return [];
                
                const jsonData = [];
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let rowNum = startRow + 1; rowNum <= range.e.r + 1; ++rowNum) {
                    const row = {};
                    let hasData = false;
                    for(const col in headers) {
                        const headerName = headers[col];
                        const cellAddress = col + rowNum;
                        const cell = worksheet[cellAddress];
                        if(cell && cell.v !== undefined) {
                            row[headerName] = cell.v;
                            hasData = true;
                        } else {
                            row[headerName] = '';
                        }
                    }
                    if (hasData) jsonData.push(row);
                }
                return jsonData;
            }
            
            function processRastreoData(data) {
                if (!data || data.length === 0) return [];
                const now = new Date();
                const headers = Object.keys(data[0] || {});
                const scrapHeader = findHeader(headers, TRACKING_KEYS.IS_SCRAP);
                const dateHeader = findHeader(headers, TRACKING_KEYS.DATE_REGISTERED);

                return data.map(row => {
                    let status = 'normal';
                    const isScrap = String(row[scrapHeader]).trim().toUpperCase() === 'X';

                    if (isScrap) {
                        status = 'scrap';
                    } else {
                        const dateSerial = row[dateHeader];
                        const registeredDate = excelSerialToDate(dateSerial);
                        if (registeredDate) {
                            const ageInMillis = now.getTime() - registeredDate.getTime();
                            const ageInHours = ageInMillis / (1000 * 60 * 60);

                            if (ageInHours > 25) {
                                status = 'very_delayed';
                            } else if (ageInHours > 8) {
                                status = 'delayed';
                            } else {
                                status = 'today';
                            }
                        }
                    }
                    return { ...row, status };
                });
            }

            function groupEmpaqueData(data) {
                if (!data || data.length === 0) return new Map();
                const boxIdHeader = findHeader(Object.keys(data[0]), PACKING_KEYS.BOX_ID);
                if (!boxIdHeader) return new Map();

                return data.reduce((acc, row) => {
                    const boxId = row[boxIdHeader];
                    if (boxId && String(boxId).trim() !== '') {
                        if (!acc.has(boxId)) acc.set(boxId, []);
                        acc.get(boxId).push(row);
                    }
                    return acc;
                }, new Map());
            }
            
            function switchMode(mode) {
                currentMode = mode;
                doc('rastreoView').style.display = mode === 'rastreo' ? 'block' : 'none';
                doc('empaqueView').style.display = mode === 'empaque' ? 'block' : 'none';

                modeRastreo.classList.toggle('active', mode === 'rastreo');
                modeEmpaque.classList.toggle('active', mode === 'empaque');
                render();
            }

            function updateOrderList() {
                orderList.innerHTML = '';
                if (loadedOrders.size === 0) {
                    orderList.innerHTML = '<p class="text-dark" style="font-size:0.9rem;">No hay órdenes cargadas.</p>';
                    return;
                }
                const groupedByDate = new Map();
                for (const [key, order] of loadedOrders.entries()) {
                    const date = order.orderDate || new Date(0);
                    const dateString = formatDate(date);
                    if (!groupedByDate.has(dateString)) groupedByDate.set(dateString, []);
                    groupedByDate.get(dateString).push({ key, ...order });
                }
                const sortedDates = Array.from(groupedByDate.keys()).sort((a, b) => {
                    const dateA = new Date(a.split('/').reverse().join('-'));
                    const dateB = new Date(b.split('/').reverse().join('-'));
                    return dateB - dateA;
                });
                const todayString = new Date().toLocaleDateString('es-ES', { 
                    timeZone: 'America/Matamoros', day: '2-digit', month: '2-digit', year: 'numeric' 
                });
                sortedDates.forEach(dateString => {
                    const orders = groupedByDate.get(dateString);
                    const isToday = dateString === todayString;
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'date-group';
                    const headerBtn = document.createElement('button');
                    headerBtn.className = 'date-header';
                    headerBtn.innerHTML = `<span>📅 ${dateString}</span> ${isToday ? '<span class="status-indicator">(Órdenes del Día)</span>' : ''} <span class="collapse-icon">►</span>`;
                    const ordersContainer = document.createElement('div');
                    ordersContainer.className = 'orders-for-date';
                    orders.forEach(order => ordersContainer.appendChild(createOrderButton(order.key, order.key)));
                    groupDiv.appendChild(headerBtn);
                    groupDiv.appendChild(ordersContainer);
                    orderList.appendChild(groupDiv);
                    headerBtn.addEventListener('click', () => groupDiv.classList.toggle('expanded'));
                });
                setActiveOrder(activeOrderKey);
            }

            function createOrderButton(key, text) {
                const item = document.createElement('div'); item.className = 'order-item';
                const btn = document.createElement('button');
                btn.className = 'order-btn'; btn.textContent = text; btn.dataset.key = key;
                btn.onclick = () => setActiveOrder(key);
                const orderData = loadedOrders.get(key);
                if (orderData && orderData.orderQty > 0 && orderData.orderQty <= orderData.packedQty) {
                    btn.classList.add('is-complete');
                }
                item.appendChild(btn);
                if (key !== 'all' && isAdminAuthenticated) {
                    const updateBtn = document.createElement('button');
                    updateBtn.className = 'icon-btn'; updateBtn.title = 'Actualizar orden';
                    updateBtn.innerHTML = `✏️`;
                    updateBtn.onclick = () => { orderToUpdateKey = key; updateFileInput.value = ''; updateFileInput.click(); };
                    item.appendChild(updateBtn);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-btn'; deleteBtn.title = 'Eliminar orden';
                    deleteBtn.innerHTML = `🗑️`;
                    deleteBtn.onclick = () => {
                        showConfirmationModal(`¿Estás seguro de que quieres eliminar la orden ${key}?`, async () => {
                            await deleteOrderFromFirebase(key);
                            loadedOrders.delete(key);
                            if (activeOrderKey === key) activeOrderKey = 'all';
                        });
                    };
                    item.appendChild(deleteBtn);
                }
                return item;
            }

            function setActiveOrder(key) {
                activeOrderKey = key;
                document.querySelectorAll('.order-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.key === key);
                });
                render();
            }

            function render() {
                if (mainMode === 'fwd') {
                    renderControls();
                    renderSummary();
                    updateGlobalDashboard();
                    if (currentMode === 'rastreo') {
                        renderRastreoView(activeOrderKey);
                    } else {
                        renderEmpaqueView(activeOrderKey);
                    }
                } else if (mainMode === 'sap') {
                    renderSapView();
                }
            }

            function renderSummary() {
                let orderQty = 0, packedQty = 0, scrapCount = 0; let ordersToProcess = [];
                
                if (activeOrderKey === 'all') {
                    const todayString = new Date().toLocaleDateString('es-ES', { 
                        timeZone: 'America/Matamoros', day: '2-digit', month: '2-digit', year: 'numeric' 
                    });
                    ordersToProcess = Array.from(loadedOrders.values()).filter(order => formatDate(order.orderDate) === todayString);
                    
                    if (ordersToProcess.length > 0) {
                        statOrderNumber.textContent = 'Órdenes del Día';
                        const firstCatalog = ordersToProcess[0].catalogNumber;
                        const allSameCatalog = ordersToProcess.every(o => o.catalogNumber === firstCatalog);
                        statCatalogNumber.textContent = allSameCatalog ? firstCatalog : 'Múltiples Catálogos';
                    } else {
                        statOrderNumber.textContent = 'N/A';
                        statCatalogNumber.textContent = 'No hay órdenes para hoy';
                    }
                
                } else if (loadedOrders.has(activeOrderKey)) {
                    ordersToProcess = [loadedOrders.get(activeOrderKey)];
                    statOrderNumber.textContent = activeOrderKey;
                    statCatalogNumber.textContent = ordersToProcess[0].catalogNumber;
                } else if (loadedOrders.size > 0) {
                    setActiveOrder('all');
                    return; 
                } else {
                    statOrderNumber.textContent = 'N/A';
                    statCatalogNumber.textContent = '';
                }
                
                ordersToProcess.forEach(order => {
                    orderQty += order.orderQty || 0;
                    packedQty += order.packedQty || 0;
                    if(order.rastreoData) {
                       scrapCount += order.rastreoData.filter(row => row.status === 'scrap').length;
                    }
                });

                statOrderQty.textContent = orderQty;
                statPackedQty.textContent = packedQty;
                statRemainingQty.textContent = orderQty - packedQty;
                statScrapQty.textContent = scrapCount;
            }

            function updateGlobalDashboard() {
                const todayString = new Date().toLocaleDateString('es-ES', { 
                    timeZone: 'America/Matamoros', day: '2-digit', month: '2-digit', year: 'numeric' 
                });
                let todaysOrdersCount = 0; let completedOrdersToday = 0;
                for (const order of loadedOrders.values()) {
                    const orderDateString = formatDate(order.orderDate || new Date());
                    if (orderDateString === todayString) {
                        todaysOrdersCount++;
                        if (order.orderQty > 0 && order.orderQty <= order.packedQty) completedOrdersToday++;
                    }
                }
                totalOrdersStat.textContent = todaysOrdersCount;
                completedOrdersStat.textContent = completedOrdersToday;
            }
            
            function renderControls() {
                 const hasOrders = loadedOrders.size > 0;
                 const statusHTML = `
                    <button class="filter-btn ${rastreoStatusFilter === 'all' ? 'active' : ''}" data-filter="all">Todos</button>
                    <button class="filter-btn ${rastreoStatusFilter === 'today' ? 'active' : ''}" data-filter="today">En Movimiento</button>
                    <button class="filter-btn ${rastreoStatusFilter === 'delayed' ? 'active' : ''}" data-filter="delayed">Sin Movimiento</button>
                    <button class="filter-btn ${rastreoStatusFilter === 'scrap' ? 'active' : ''}" data-filter="scrap">Scrap</button>
                `;
                mobileControls.status.innerHTML = statusHTML;
                desktopControls.status.innerHTML = statusHTML;

                const actionsHTML = `
                    <button class="btn" id="exportViewButtonMobile" ${!hasOrders ? 'disabled' : ''}>Exportar reimpresión</button>
                    <button class="btn" id="exportImageButtonMobile" ${!hasOrders ? 'disabled' : ''}>Exportar Captura</button>
                    <button class="btn" id="exportStatusButtonMobile" ${!hasOrders ? 'disabled' : ''}>Reporte de Estatus</button>
                `;
                 const desktopActionsHTML = `
                    <button class="btn" id="exportViewButtonDesktop" ${!hasOrders ? 'disabled' : ''}>Reimpresión</button>
                    <button class="btn" id="exportImageButtonDesktop" ${!hasOrders ? 'disabled' : ''}>Captura</button>
                    <button class="btn" id="exportStatusButtonDesktop" ${!hasOrders ? 'disabled' : ''}>Reporte</button>
                `;
                mobileControls.actions.innerHTML = actionsHTML;
                desktopControls.actions.innerHTML = desktopActionsHTML;

                doc('exportViewButtonMobile').addEventListener('click', handleReprintExport);
                doc('exportViewButtonDesktop').addEventListener('click', handleReprintExport);
                doc('exportImageButtonMobile').addEventListener('click', handleImageExport);
                doc('exportImageButtonDesktop').addEventListener('click', handleImageExport);
                doc('exportStatusButtonMobile').addEventListener('click', handleStatusReport);
                doc('exportStatusButtonDesktop').addEventListener('click', handleStatusReport);
            }

            async function renderRastreoView(key) {
                const tableWrapper = doc('rastreoTable').parentElement;
                tableWrapper.style.opacity = '0';
                await new Promise(res => setTimeout(res, 150));
                
                let dataToShow = []; let headers = [];
                if (key === 'all') {
                    loadedOrders.forEach(order => { if(order.rastreoData) dataToShow.push(...order.rastreoData) });
                    if (loadedOrders.size > 0) headers = Array.from(loadedOrders.values()).find(o => o.headers.rastreo)?.headers.rastreo;
                } else if (loadedOrders.has(key)) {
                    const order = loadedOrders.get(key);
                    dataToShow = order.rastreoData || []; headers = order.headers.rastreo || [];
                }
                
                createRastreoLineFilters(dataToShow, headers);

                let filteredData = dataToShow;
                if (rastreoStatusFilter !== 'all') {
                    if (rastreoStatusFilter === 'delayed') {
                        filteredData = dataToShow.filter(row => row.status === 'delayed' || row.status === 'very_delayed');
                    } else {
                        filteredData = dataToShow.filter(row => row.status === rastreoStatusFilter);
                    }
                }
                
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (rastreoLineFilter !== 'all' && lineHeader) filteredData = filteredData.filter(row => row[lineHeader] === rastreoLineFilter);
                const searchText = rastreoFilterInput.value.toLowerCase();
                if (searchText) filteredData = filteredData.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(searchText)));
                currentVisibleData = filteredData;
                
                placeholderText.style.display = (dataToShow.length > 0) ? 'none' : 'block';

                updateRastreoTable(filteredData, headers);
                updateLineCounts(filteredData, headers);
                
                tableWrapper.style.opacity = '1';
            }

            function createRastreoLineFilters(data, headers) {
                if (!headers) headers = [];
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                
                let lineHTML = '';
                if (!lineHeader || !data || data.length === 0) {
                    lineHTML = `<p class="text-dark" style="font-size: 0.9rem; margin: 0;">N/A</p>`;
                } else {
                    const uniqueLines = [...new Set(data.map(row => row[lineHeader]).filter(Boolean))].sort();
                    lineHTML += `<button class="filter-btn ${rastreoLineFilter === 'all' ? 'active' : ''}" data-filter="all">Todas</button>`;
                    uniqueLines.forEach(line => {
                        lineHTML += `<button class="filter-btn ${rastreoLineFilter === line ? 'active' : ''}" data-filter="${line}">${line}</button>`;
                    });
                }
                
                mobileControls.line.innerHTML = lineHTML;
                desktopControls.line.innerHTML = lineHTML;
            }
            
            function updateRastreoTable(data, headers) {
                const table = doc('rastreoTable');
                if (!table) return;
                const isMobile = window.innerWidth <= 992;
                let headersToRender;

                if (isMobile) {
                    headersToRender = [
                        findHeader(headers, TRACKING_KEYS.SERIAL), findHeader(headers, TRACKING_KEYS.LINE),
                        findHeader(headers, TRACKING_KEYS.STATION), findHeader(headers, TRACKING_KEYS.DATE_REGISTERED)
                    ].filter(Boolean);
                } else {
                    const headersToHide = [TRACKING_KEYS.CREATED_BY, TRACKING_KEYS.NOT_PACKED, TRACKING_KEYS.IS_SCRAP].map(h => findHeader(headers, h)).filter(Boolean);
                    headersToRender = headers ? headers.filter(h => !headersToHide.includes(h) && h !== 'status') : [];
                }

                if (!data || data.length === 0 || !headersToRender || headersToRender.length === 0) {
                    table.innerHTML = `<thead><tr><th>No se encontraron resultados.</th></tr></thead>`; return;
                }
                table.innerHTML = `
                    <thead><tr>${headersToRender.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>
                        ${data.map(row => `
                            <tr class="is-${row.status}">
                                ${headersToRender.map(h => `<td data-label="${h}">${formatCell(row[h], h, h === findHeader(headers, TRACKING_KEYS.DATE_REGISTERED))}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>`;
            }

            function updateLineCounts(data, headers) {
                if (!headers) headers = [];
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (!lineHeader) { lineCountsContainer.innerHTML = ''; return; }
                const counts = data.reduce((acc, row) => {
                    const line = row[lineHeader];
                    if (line) acc[line] = (acc[line] || 0) + 1;
                    return acc;
                }, {});
                
                lineCountsContainer.innerHTML = Object.entries(counts).sort().map(([line, count]) =>
                    `<div class="line-badge">${line}: <span>${count}</span></div>`
                ).join('');
            }
            
            async function renderEmpaqueView(key) {
                const tableWrapper = doc('empaqueTableContainer');
                tableWrapper.style.opacity = '0';
                await new Promise(res => setTimeout(res, 150));
                
                let dataToShow = new Map(); let headers = [];
                if (key === 'all') {
                    loadedOrders.forEach(order => {
                        if(order.empaqueData) order.empaqueData.forEach((serials, boxId) => {
                            if (!dataToShow.has(boxId)) dataToShow.set(boxId, []);
                            if(serials && serials.length > 0) dataToShow.get(boxId).push(...serials);
                        });
                    });
                    if (loadedOrders.size > 0) {
                        const orderWithHeaders = Array.from(loadedOrders.values()).find(o => o.headers && o.headers.empaque && o.headers.empaque.length > 0);
                        if (orderWithHeaders) headers = orderWithHeaders.headers.empaque;
                    }
                } else if (loadedOrders.has(key)) {
                    const order = loadedOrders.get(key);
                    dataToShow = order.empaqueData || new Map(); headers = order.headers.empaque || [];
                }

                const mobileContainer = doc('empaqueMobileContainer');
                const noDataMsg = `<p class="text-dark" style="padding: 20px; text-align: center;">No hay datos de empaque disponibles.</p>`;
                if (!dataToShow || dataToShow.size === 0 || !headers || headers.length === 0) {
                    tableWrapper.innerHTML = `<table id="empaqueTable"><thead><tr><th>No hay datos de empaque disponibles.</th></tr></thead></table>`;
                    mobileContainer.innerHTML = noDataMsg;
                    tableWrapper.style.opacity = '1';
                    return;
                }

                const boxIdHeader = findHeader(headers, PACKING_KEYS.BOX_ID);
                const serialHeader = findHeader(headers, PACKING_KEYS.SERIAL);
                const packedDateHeader = findHeader(headers, PACKING_KEYS.PACKED_DATE);
                const employeeIdHeader = findHeader(headers, PACKING_KEYS.EMPLOYEE_ID);
                
                if (!boxIdHeader || !serialHeader || !packedDateHeader || !employeeIdHeader) {
                    const errorMsg = `Error: Columnas de empaque no encontradas. Verifique el archivo de Excel.`;
                    tableWrapper.innerHTML = `<table id="empaqueTable"><thead><tr><th style="color: var(--warning-color);">${errorMsg}</th></tr></thead></table>`;
                    mobileContainer.innerHTML = `<p class="text-dark" style="color: var(--warning-color); padding: 20px; text-align: center;">${errorMsg}</p>`;
                    tableWrapper.style.opacity = '1';
                    return;
                }

                const filterText = empaqueFilterInput.value.toLowerCase();
                let desktopHTML = `<thead><tr><th>BoxID</th><th>Cantidad</th><th>Último Empaque</th></tr></thead><tbody>`;
                let mobileHTML = `<div class="mobile-packing-list">`;
                let entriesFound = 0;

                const reversedEntries = Array.from(dataToShow.entries()).reverse();

                for (const [boxId, serials] of reversedEntries) {
                    if(!serials || serials.length === 0) continue;
                    
                    const serialsMatchFilter = serials.some(s => 
                        String(s[serialHeader]).toLowerCase().includes(filterText) || 
                        String(s[boxIdHeader]).toLowerCase().includes(filterText)
                    );
                    
                    if (!serialsMatchFilter) continue;
                    
                    entriesFound++;
                    const latestSerial = serials.reduce((latest, current) => {
                        return (current[packedDateHeader] > latest[packedDateHeader]) ? current : latest;
                    }, serials[0]);
                    const latestDate = latestSerial[packedDateHeader];
                    const latestPacker = latestSerial[employeeIdHeader];

                    let serialsDetailsHTML = `<div class="serial-details-container">`;
                    serialsDetailsHTML += `<div class="box-summary-info">
                        <span class="detail-label">Empacador: ${latestPacker}</span>
                        <span class="detail-value">Fecha: ${formatDateTime(excelSerialToDate(latestDate))}</span>
                    </div>`;

                    serials.forEach(serial => {
                        serialsDetailsHTML += `
                            <div class="serial-detail-item">
                                <div class="serial-info">
                                    <span class="detail-label">Serial Number</span>
                                    <span class="detail-value">${serial[serialHeader]}</span>
                                </div>
                            </div>`;
                    });
                    serialsDetailsHTML += '</div>';

                    desktopHTML += `
                        <tr class="box-row" data-boxid="${boxId}">
                            <td>${boxId}</td>
                            <td>${serials.length}</td>
                            <td>${formatDateTime(excelSerialToDate(latestDate))}</td>
                        </tr>
                        <tr class="serial-row" data-parentbox="${boxId}"><td colspan="3">${serialsDetailsHTML}</td></tr>`;
                    
                    mobileHTML += `
                        <details>
                            <summary>
                                <div class="summary-content">
                                    <div><span class="box-id-title">${boxId}</span></div>
                                    <div class="box-details-summary">
                                        <span class="detail-label">Seriales: ${serials.length}</span><br>
                                        <span class="detail-value">${formatDateTime(excelSerialToDate(latestDate))}</span>
                                    </div>
                                </div>
                            </summary>
                            ${serialsDetailsHTML}
                        </details>`;
                }

                if (entriesFound === 0) {
                    tableWrapper.innerHTML = `<table id="empaqueTable"><thead><tr><th>No se encontraron resultados para "${filterText}".</th></tr></thead></table>`;
                    mobileContainer.innerHTML = `<p class="text-dark" style="padding: 20px; text-align: center;">No se encontraron resultados.</p>`;
                    tableWrapper.style.opacity = '1';
                    return;
                }

                desktopHTML += `</tbody>`;
                mobileHTML += `</div>`;
                tableWrapper.innerHTML = `<table id="empaqueTable">${desktopHTML}</table>`;
                mobileContainer.innerHTML = mobileHTML;

                tableWrapper.querySelectorAll('.box-row').forEach(row => {
                    row.addEventListener('click', () => row.classList.toggle('expanded'));
                });
                tableWrapper.style.opacity = '1';
            }

            function handleReprintExport() {
                if (!currentVisibleData || currentVisibleData.length === 0) {
                    showModal('Exportar Reimpresión', 'No hay datos en la vista actual para exportar.', 'warning');
                    return;
                }
                try {
                    const lineHeader = findHeader(Object.keys(currentVisibleData[0]), TRACKING_KEYS.LINE);
                    const lineInfo = lineHeader && rastreoLineFilter !== 'all' ? rastreoLineFilter : 'Multiples_Lineas';
                    
                    const dataToExport = currentVisibleData.map(row => {
                        const serial = row[TRACKING_KEYS.SERIAL] || '';
                        return {
                            'Product Serial Number': serial.startsWith('S#') ? serial.substring(2) : serial,
                            'Line': row[TRACKING_KEYS.LINE],
                            'Station': row[TRACKING_KEYS.STATION],
                            'Status': row.status,
                            'Date Registered': formatDateTime(excelSerialToDate(row[TRACKING_KEYS.DATE_REGISTERED]))
                        };
                    });
                    
                    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Reimpresión');
                    
                    const orderName = (activeOrderKey && activeOrderKey !== 'all') ? activeOrderKey : 'Multiples_Ordenes';
                    const dateStamp = new Date().toLocaleDateString('es-ES').replace(/\//g, '-');
                    XLSX.writeFile(workbook, `Reimpresion_${orderName}_Linea_${lineInfo}_${dateStamp}.xlsx`);
                } catch(e) {
                    console.error("Error al exportar para reimpresión:", e);
                    showModal('Error', 'Ocurrió un error al generar el archivo de reimpresión.', 'error');
                }
            }
            
            async function handleImageExport(event) {
                 if (!currentVisibleData || currentVisibleData.length === 0) {
                    showModal('Exportar Captura', 'No hay datos en la vista actual para exportar.', 'warning');
                    return;
                }

                const button = event.target.closest('button');
                const originalButtonText = button.textContent;
                button.textContent = 'Generando...';
                button.disabled = true;

                const cloneContainer = document.createElement('div');
                cloneContainer.style.position = 'absolute';
                cloneContainer.style.left = '-9999px';
                cloneContainer.style.top = '0';
                cloneContainer.style.width = 'auto'; 
                cloneContainer.style.minWidth = '1200px';
                cloneContainer.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim();
                cloneContainer.style.padding = '1px';

                const tableToClone = doc('rastreoTable');
                const clonedTable = tableToClone.cloneNode(true);
                
                const style = document.createElement('style');
                style.innerHTML = `
                    :root { --surface-color: #1E293B; --border-color: #334155; --danger-color: #FB7185; --warning-color: #FBBF24; --orange-color: #F97316; --success-color: #34D399; --text-primary: #F8FAFC; --text-secondary: #94A3B8; }
                    table { color: var(--text-primary); background-color: var(--surface-color); border-collapse: collapse; font-family: 'Inter', sans-serif; font-size: 14px; table-layout: auto; width: auto; }
                    th, td { padding: 12px 24px; text-align: center !important; border: 1px solid var(--border-color); white-space: nowrap; }
                    thead { display: table-header-group !important; background-color: #1a2436; position: static !important; }
                    th { font-weight: 600; color: var(--text-secondary); font-size: 12px; }
                    tr { display: table-row !important; }
                    td { display: table-cell !important; background-color: inherit !important; }
                    td::before { display: none !important; }
                    tr.is-scrap { background-color: rgba(251, 113, 133, 0.1) !important; }
                    tr.is-scrap td { color: var(--danger-color) !important; }
                    tr.is-very_delayed { background-color: rgba(249, 115, 22, 0.1) !important; }
                    tr.is-very_delayed td { color: var(--orange-color) !important; }
                    tr.is-delayed { background-color: rgba(251, 191, 36, 0.1) !important; }
                    tr.is-delayed td { color: var(--warning-color) !important; }
                    tr.is-today { background-color: rgba(52, 211, 153, 0.1) !important; }
                    tr.is-today td { color: var(--success-color) !important; }
                `;
                
                cloneContainer.appendChild(style);
                cloneContainer.appendChild(clonedTable);
                document.body.appendChild(cloneContainer);

                await new Promise(resolve => setTimeout(resolve, 100));

                try {
                    const canvas = await html2canvas(clonedTable, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--surface-color').trim(),
                        scrollY: -window.scrollY
                    });

                    const a = document.createElement('a');
                    a.href = canvas.toDataURL('image/jpeg', 0.95);
                    const orderName = (activeOrderKey && activeOrderKey !== 'all') ? activeOrderKey : 'Multiples_Ordenes';
                    const dateStamp = new Date().toLocaleDateString('es-ES').replace(/\//g, '-');
                    a.download = `Captura_Rastreo_${orderName}_${dateStamp}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                } catch (e) {
                    console.error("Error al generar la imagen:", e);
                    showModal('Error', 'Ocurrió un error al generar el archivo de imagen.', 'error');
                } finally {
                    document.body.removeChild(cloneContainer);
                    button.textContent = originalButtonText;
                    button.disabled = false;
                }
            }

            function handleStatusReport() {
                const incompleteOrders = Array.from(loadedOrders.entries())
                    .filter(([key, order]) => (order.orderQty > order.packedQty))
                    .map(([key, order]) => ({ key, ...order }));

                if (incompleteOrders.length === 0) {
                    showModal('Reporte de Estatus', '✅ ¡Felicidades! Todas las órdenes han sido completadas.', 'success');
                    return;
                }

                let reportHTML = `<div class="status-report">`;
                reportHTML += `<p><strong>Fecha del Reporte:</strong> ${new Date().toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' })}</p>`;

                incompleteOrders.forEach(order => {
                    const data = order.rastreoData || [];
                    const remaining = (order.orderQty || 0) - (order.packedQty || 0);
                    const today = data.filter(r => r.status === 'today').length;
                    const delayed = data.filter(r => r.status === 'delayed' || r.status === 'very_delayed').length;
                    const scrap = data.filter(r => r.status === 'scrap').length;

                    reportHTML += `
                        <h4>📦 Orden: ${order.key}</h4>
                        <p><strong>📝 Catálogo:</strong> ${order.catalogNumber || 'N/A'}</p>
                        <p><strong>📊 Progreso:</strong> ${order.packedQty || 0} / ${order.orderQty || 0} Unidades</p>
                        <p><strong>📉 Restantes:</strong> ${remaining} Unidades</p>
                        <p style="margin-top: 10px;"><strong>✅ En Movimiento (Hoy):</strong> ${today}</p>
                        <p><strong>⚠️ Sin Movimiento (Retraso):</strong> ${delayed}</p>
                        <p><strong>🗑️ En Scrap:</strong> ${scrap}</p>
                    `;
                });
                reportHTML += `</div>`;
                showModal(`Reporte de Órdenes Incompletas`, reportHTML, 'info', true);
            }
            
            // ========================
            // === SAP VIEW FUNCTIONS ===
            // ========================
            async function saveSapDataToFirebase(data) {
                try {
                    const dataToSave = { orders: data, lastUpdated: new Date() };
                    await db.collection('areas').doc(currentArea).collection('sap_data').doc('current_data').set(dataToSave);
                } catch (e) {
                    console.error("Error al guardar datos SAP en Firebase: ", e);
                    showModal('Error', 'No se pudieron guardar los datos de SAP en la nube.', 'error');
                }
            }

            async function handleSapFile(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const processed = processSapFile(workbook);
                        await saveSapDataToFirebase(processed); 
                        sapDateFilter = 'default';
                        showModal('Éxito', 'Archivo SAP cargado y guardado. Los datos se actualizarán en todos los dispositivos.', 'success');
                    } catch (err) {
                        console.error("Error procesando archivo SAP:", err);
                        showModal('Error', `No se pudo procesar el archivo SAP. <br><small>${err.message}</small>`, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function processSapFile(workbook) {
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                if (!worksheet) throw new Error("No se encontró una hoja de cálculo en el archivo.");
                const getCellValue = (cellAddress) => (worksheet[cellAddress] ? worksheet[cellAddress].v : null);
                
                const processedData = [];
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                const reynosaTodayString = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Matamoros' });
                const reynosaTodayDateString = new Date().toLocaleDateString('es-ES', { timeZone: 'America/Matamoros', day: '2-digit', month: '2-digit', year: 'numeric' });

                for (let i = range.s.r + 1; i <= range.e.r; i++) {
                    const rowNum = i + 1;
                    const orderId = getCellValue('A' + rowNum);
                    if (!orderId) continue;

                    const total = parseFloat(getCellValue('I' + rowNum)) || 0;
                    const confirmed = parseFloat(getCellValue('J' + rowNum)) || 0;
                    const faltante = total - confirmed;
                    const stock1 = getCellValue('B' + rowNum) || '';
                    const stock2 = getCellValue('L' + rowNum) || '';
                    let status = 'incomplete';
                    const finishDateSerial = getCellValue('G' + rowNum);
                    const finishDate = excelSerialToDate(finishDateSerial);
                    const finishDateStringCA = finishDate ? finishDate.toISOString().slice(0, 10) : '';
                    
                    if (faltante <= 0) {
                        status = 'complete';
                    } else if (finishDateStringCA && finishDateStringCA < reynosaTodayString) {
                        status = 'late';
                    }

                    processedData.push({
                        'Orden': orderId,
                        'Catalogo': getCellValue('D' + rowNum) || null,
                        'Special Stock': [stock1, stock2].filter(Boolean).join(' / ') || null,
                        'Finish': finishDateSerial,
                        'Total orden': total,
                        'Total confirmado': confirmed,
                        'Faltante': faltante,
                        'status': status,
                        'isToday': finishDate && formatDate(finishDate) === reynosaTodayDateString
                    });
                }
                return processedData;
            }

            function renderSapView() {
                sapFileDropArea.classList.toggle('disabled', !isAdminAuthenticated);
                sapFileDropArea.querySelector('p').textContent = isAdminAuthenticated ? 'Arrastra un archivo de SAP (.xlsx)' : 'Autentícate para cargar archivos';

                sapPlaceholderText.style.display = sapData.length > 0 ? 'none' : 'block';
                updateSapDashboard();
                updateSapOrderList();
                updateSapTable();
                sapResetFilterBtn.style.display = (sapDateFilter !== 'default' && sapData.length > 0) ? 'inline-block' : 'none';
            }

            function updateSapDashboard() {
                if(sapData.length === 0) {
                    sapTotalOrdersStat.textContent = '0';
                    sapCompletedOrdersStat.textContent = '0';
                    return;
                }
                const ordersToday = sapData.filter(row => row.isToday).length;
                const ordersCompletedToday = sapData.filter(row => row.status === 'complete' && row.isToday).length;

                sapTotalOrdersStat.textContent = ordersToday;
                sapCompletedOrdersStat.textContent = ordersCompletedToday;
            }

            function updateSapOrderList() {
                 if (sapData.length === 0) {
                     sapOrderList.innerHTML = `<p class="text-dark" style="font-size:0.9rem;">Cargue un archivo para ver las órdenes.</p>`;
                     return;
                 }
                
                const groupedByDate = new Map();
                sapData.forEach(order => {
                    const date = excelSerialToDate(order['Finish']) || new Date(0);
                    const dateString = formatDate(date);
                    if (!groupedByDate.has(dateString)) groupedByDate.set(dateString, []);
                    groupedByDate.get(dateString).push(order);
                });

                const sortedDates = Array.from(groupedByDate.keys()).sort((a, b) => {
                    const dateA = new Date(a.split('/').reverse().join('-'));
                    const dateB = new Date(b.split('/').reverse().join('-'));
                    return dateB - dateA;
                });

                const todayString = new Date().toLocaleDateString('es-ES', { 
                    timeZone: 'America/Matamoros', day: '2-digit', month: '2-digit', year: 'numeric' 
                });
                
                let html = '';
                sortedDates.forEach(dateString => {
                    const orders = groupedByDate.get(dateString);
                    const isToday = dateString === todayString;
                    html += `<div class="date-group">`;
                    html += `<button class="date-header" data-date="${dateString}">
                                 <span>📅 ${dateString}</span> 
                                 ${isToday ? '<span class="status-indicator">(Órdenes del Día)</span>' : ''}
                                 <span class="collapse-icon">►</span>
                               </button>`;
                    html += `<div class="orders-for-date">`;
                    orders.forEach(order => {
                        const itemClass = order.status === 'complete' ? 'is-complete' : '';
                        html += `<div class="order-item"><button class="order-btn ${itemClass}" disabled>${order['Orden']}</button></div>`;
                    });
                    html += `</div></div>`;
                });
                
                sapOrderList.innerHTML = html;
                sapOrderList.querySelectorAll('.date-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.parentElement.classList.toggle('expanded');
                        sapDateFilter = header.dataset.date;
                        renderSapView();
                        sapOrderList.querySelectorAll('.date-header').forEach(h => h.classList.remove('active'));
                        header.classList.add('active');
                    });
                });
            }
            
            function updateSapTable() {
                const table = doc('sapTable');
                if (sapData.length === 0) {
                    table.innerHTML = '';
                    return;
                }

                let dataToDisplay = sapData;
                if (sapDateFilter === 'default') {
                    dataToDisplay = sapData.filter(row => row.status === 'late' || row.isToday);
                } else if (sapDateFilter) {
                    dataToDisplay = sapData.filter(row => formatDate(excelSerialToDate(row['Finish'])) === sapDateFilter);
                }

                if (dataToDisplay.length === 0) {
                    table.innerHTML = `<thead><tr><th>No hay órdenes para la selección actual.</th></tr></thead>`;
                    return;
                }

                const headers = ['Orden', 'Catalogo', 'Special Stock', 'Finish', 'Total orden', 'Total confirmado', 'Faltante'];
                table.innerHTML = `
                    <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>
                        ${dataToDisplay.map(row => `
                            <tr class="is-${row.status}-sap">
                                <td data-label="Orden">${row['Orden']}</td>
                                <td data-label="Catalogo">${row['Catalogo']}</td>
                                <td data-label="Special Stock">${row['Special Stock']}</td>
                                <td data-label="Finish">${formatDate(excelSerialToDate(row['Finish']))}</td>
                                <td data-label="Total orden">${row['Total orden']}</td>
                                <td data-label="Total confirmado">${row['Total confirmado']}</td>
                                <td data-label="Faltante">${row['Faltante']}</td>
                            </tr>
                        `).join('')}
                    </tbody>`;
            }

            function formatCell(value, header, isDateTime = false) {
                 if (isDateTime) return formatDateTime(excelSerialToDate(value));
                 if (header && header.toLowerCase().includes('date')) return formatDate(excelSerialToDate(value));
                 return value === undefined || value === null ? '' : value;
            }
            
            function syncFwdAndSapDates() {
                if (loadedOrders.size === 0 || sapData.length === 0) return;

                const sapDateMap = new Map(sapData.map(order => [String(order.Orden), order.Finish]));
                
                loadedOrders.forEach((orderData, orderKey) => {
                    if (sapDateMap.has(orderKey)) {
                        const sapFinishDateSerial = sapDateMap.get(orderKey);
                        const sapFinishDate = excelSerialToDate(sapFinishDateSerial);
                        if(sapFinishDate) {
                            orderData.orderDate = sapFinishDate;
                        }
                    }
                });
            }

            // ===================================
            // === AUTH & AREA FUNCTIONS ===
            // ===================================

            function showAdminLogin() {
                let content = `
                    <p>Introduce la contraseña de administrador para habilitar la carga y edición de archivos.</p>
                    <input type="password" id="adminPasswordInput" placeholder="Contraseña">
                    <button id="adminLoginBtn" class="btn" style="margin-top: 16px;">Autenticar</button>
                `;
                showModal('Acceso de Administrador', content);
                doc('adminLoginBtn').addEventListener('click', checkAdminPassword);
                doc('adminPasswordInput').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') checkAdminPassword();
                });
            }

            function checkAdminPassword() {
                const input = doc('adminPasswordInput');
                if (input.value === 'CORNING25') {
                    isAdminAuthenticated = true;
                    hideModal();
                    updateUIAfterAuth();
                    showAdminPanel();
                } else {
                    showModal('Error', 'Contraseña incorrecta. Inténtalo de nuevo.', 'error');
                }
            }
            
            function updateUIAfterAuth() {
                fileDropArea.classList.toggle('disabled', !isAdminAuthenticated);
                fileDropArea.querySelector('p').textContent = isAdminAuthenticated ? 'Arrastra archivos (.xlsx) para cargar/actualizar' : 'Autentícate para cargar archivos';
                
                sapFileDropArea.classList.toggle('disabled', !isAdminAuthenticated);
                sapFileDropArea.querySelector('p').textContent = isAdminAuthenticated ? 'Arrastra un archivo de SAP (.xlsx)' : 'Autentícate para cargar archivos';

                updateOrderList();
            }

            async function showAreaSelector() {
                const areasSnapshot = await db.collection('areas').get();
                let areas = [];
                areasSnapshot.forEach(doc => areas.push({ id: doc.id, ...doc.data() }));

                let content = '<h3>Selecciona un Área</h3><ul class="area-list">';
                areas.forEach(area => {
                    content += `<li><span>${area.name}</span> <button class="btn select-area-btn" data-area="${area.id}" style="width: auto; padding: 5px 10px;">Seleccionar</button></li>`;
                });
                content += '</ul>';
                showModal('Selector de Área', content);

                doc('modalBody').querySelectorAll('.select-area-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newArea = e.target.dataset.area;
                        if (newArea !== currentArea) {
                            currentArea = newArea;
                            localStorage.setItem('currentArea', currentArea);
                            areaSelectBtn.textContent = `Área: ${currentArea}`;
                            setupListenersForArea(currentArea);
                        }
                        hideModal();
                    });
                });
            }

            async function showAdminPanel() {
                const areasSnapshot = await db.collection('areas').get();
                let areas = [];
                areasSnapshot.forEach(doc => areas.push({ id: doc.id, ...doc.data() }));

                let content = '<h3>Gestionar Áreas</h3><ul class="area-list">';
                areas.forEach(area => {
                    content += `<li><input type="text" class="area-name-input" data-id="${area.id}" value="${area.name}"> 
                        <div>
                           <button class="btn save-area-btn" data-id="${area.id}" style="width: auto; padding: 5px 10px;">Guardar</button>
                           <button class="btn btn-danger delete-area-btn" data-id="${area.id}" style="width: auto; padding: 5px 10px; margin-left: 5px;">Eliminar</button>
                        </div>
                    </li>`;
                });
                content += `</ul>
                    <h3 style="margin-top: 20px;">Crear Nueva Área</h3>
                    <input type="text" id="newAreaInput" placeholder="Nombre de la nueva área">
                    <button id="createAreaBtn" class="btn" style="margin-top: 10px;">Crear Área</button>`;

                showModal('Panel de Administrador', content);

                doc('createAreaBtn').addEventListener('click', async () => {
                    const input = doc('newAreaInput');
                    const newAreaName = input.value.trim().toUpperCase();
                    if (newAreaName) {
                        await db.collection('areas').doc(newAreaName).set({ name: newAreaName, createdAt: new Date() });
                        input.value = '';
                        showAdminPanel(); // Refresh panel
                    }
                });

                doc('modalBody').querySelectorAll('.save-area-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const areaId = e.target.dataset.id;
                        const newName = doc('modalBody').querySelector(`.area-name-input[data-id="${areaId}"]`).value.trim().toUpperCase();
                        if (newName && newName !== areaId) {
                            await db.collection('areas').doc(areaId).update({ name: newName });
                            if(currentArea === areaId) {
                                areaSelectBtn.textContent = `Área: ${newName}`;
                            }
                            showAdminPanel(); // Refresh
                        }
                    });
                });

                doc('modalBody').querySelectorAll('.delete-area-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                         const areaId = e.target.dataset.id;
                         if (areas.length <= 1) {
                            showModal('Acción no permitida', 'No puedes eliminar la última área.', 'warning');
                            return;
                         }
                         
                         showConfirmationModal(`¿Estás seguro de que quieres eliminar el área "${areaId}" y todos sus datos? Esta acción no se puede deshacer.`, async () => {
                            await deleteAreaAndSubcollections(areaId);
                            if (currentArea === areaId) {
                                const remainingArea = areas.find(a => a.id !== areaId);
                                currentArea = remainingArea.id;
                                localStorage.setItem('currentArea', currentArea);
                                areaSelectBtn.textContent = `Área: ${currentArea}`;
                                setupListenersForArea(currentArea);
                            }
                            showAdminPanel();
                         });
                    });
                });
            }
            
            async function deleteAreaAndSubcollections(areaId) {
                const subcollections = ['orders', 'sap_data'];
                for (const subcollection of subcollections) {
                    const snapshot = await db.collection('areas').doc(areaId).collection(subcollection).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
                await db.collection('areas').doc(areaId).delete();
            }

            // ===================================
            // === THEME & INITIALIZATION ===
            // ===================================
            let currentTheme = localStorage.getItem('theme') || 'dark';

            function applyTheme(theme) {
                document.body.className = `${theme}-theme`;
                themeToggleBtn.textContent = theme === 'light' ? '🌙' : '☀️';
            }

            themeToggleBtn.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', currentTheme);
                applyTheme(currentTheme);
            });

            function setupListenersForArea(area) {
                if (fwdListener) fwdListener(); 
                if (sapListener) sapListener(); 

                fwdListener = db.collection('areas').doc(area).collection('orders').onSnapshot(snapshot => {
                    const ordersFromDB = new Map();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.orderDate && data.orderDate.toDate) { data.orderDate = data.orderDate.toDate(); }
                        const empaqueDataMap = new Map();
                        if (data.empaqueData && Array.isArray(data.empaqueData)) {
                            data.empaqueData.forEach(item => { empaqueDataMap.set(item.boxId, item.serials); });
                        }
                        data.empaqueData = empaqueDataMap;
                        ordersFromDB.set(doc.id, data);
                    });
                    loadedOrders = ordersFromDB;
                    syncFwdAndSapDates();
                    updateOrderList();
                    if (mainMode === 'fwd') render();
                }, err => {
                    console.error("Error escuchando datos de FWD: ", err);
                    showModal('Error de Conexión', 'No se pudo conectar a la base de datos de FWD en tiempo real.', 'error');
                });

                sapListener = db.collection('areas').doc(area).collection('sap_data').doc('current_data').onSnapshot(docRef => {
                    if (docRef.exists) {
                        const data = docRef.data();
                        sapData = data.orders || [];
                    } else {
                        sapData = [];
                    }
                    syncFwdAndSapDates();
                    updateOrderList();
                    if (mainMode === 'sap') render();
                }, err => {
                    console.error("Error escuchando datos de SAP: ", err);
                    showModal('Error de Conexión', 'No se pudo conectar a la base de datos de SAP en tiempo real.', 'error');
                });
            }

            let isMobile = window.innerWidth <= 992;
            const mobileCollapsibleCardIds = ['uploadCard', 'orderListCard', 'filtersCard', 'actionsCard', 'sap-uploadCard', 'sap-orderListCard'];
            function setupMobileMode() {
                mobileCollapsibleCardIds.forEach(id => {
                    const cardElement = doc(id);
                    if (!cardElement) return;
                    cardElement.classList.add('mobile-collapsible');
                    const trigger = cardElement.querySelector('h3');
                    if (trigger) {
                        trigger.classList.add('mobile-trigger');
                        if (!trigger.dataset.mobileListener) {
                            trigger.addEventListener('click', (e) => {
                                if(window.innerWidth <= 992) {
                                   e.currentTarget.closest('.card').classList.toggle('expanded');
                                }
                            });
                            trigger.dataset.mobileListener = 'true';
                        }
                    }
                });
            }
            function teardownMobileMode() {
                 mobileCollapsibleCardIds.forEach(id => {
                    const cardElement = doc(id);
                    if (!cardElement) return;
                    cardElement.classList.remove('mobile-collapsible', 'expanded');
                    const trigger = cardElement.querySelector('h3');
                    if(trigger) trigger.classList.remove('mobile-trigger');
                 });
            }
            window.addEventListener('resize', () => {
                const newIsMobile = window.innerWidth <= 992;
                if (newIsMobile !== isMobile) {
                    isMobile = newIsMobile;
                    if (isMobile) setupMobileMode(); else teardownMobileMode();
                    render();
                }
            });

            async function migrateOldData() {
                const oldOrders = await db.collection('production_orders').get();
                if (!oldOrders.empty) {
                    const batch = db.batch();
                    const areaRef = db.collection('areas').doc('MULTIPORT');
                    batch.set(areaRef, { name: 'MULTIPORT', createdAt: new Date() });

                    oldOrders.forEach(doc => {
                        const newDocRef = areaRef.collection('orders').doc(doc.id);
                        batch.set(newDocRef, doc.data());
                        batch.delete(doc.ref);
                    });
                    
                    const oldSap = await db.collection('sap_data').doc('current_data').get();
                    if(oldSap.exists){
                        const newSapRef = areaRef.collection('sap_data').doc('current_data');
                        batch.set(newSapRef, oldSap.data());
                        batch.delete(oldSap.ref);
                    }

                    await batch.commit();
                    console.log("Migración completada.");
                }
            }


            // === INITIALIZATION ===
            mainMode = localStorage.getItem('mainMode') || 'fwd';
            currentArea = localStorage.getItem('currentArea') || 'MULTIPORT';
            areaSelectBtn.textContent = `Área: ${currentArea}`;
            applyTheme(currentTheme);

            // Set initial view display property
            doc('fwdView').style.display = mainMode === 'fwd' ? 'block' : 'none';
            doc('sapView').style.display = mainMode === 'sap' ? 'block' : 'none';
            doc('fwdView').style.opacity = mainMode === 'fwd' ? '1' : '0';
            doc('sapView').style.opacity = mainMode === 'sap' ? '1' : '0';

            if (isMobile) setupMobileMode();
            
            migrateOldData().then(() => {
                setupListenersForArea(currentArea);
            }).catch(err => {
                console.error("Error en la migración, cargando datos normalmente.", err);
                setupListenersForArea(currentArea);
            });
            updateUIAfterAuth();
        });
    </script>
</body>
</html>
