<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Control de Producción (Versión Definitiva)</title>
    <!-- SheetJS (xlsx) Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        :root {
            --bg-color: #0F172A; --surface-color: #1E293B; --border-color: #334155;
            --primary-color: #38BDF8; --danger-color: #FB7185; --warning-color: #FBBF24;
            --success-color: #34D399; --text-primary: #F8FAFC; --text-secondary: #94A3B8;
            --text-dark: #64748B;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color);
            color: var(--text-primary); margin: 0; padding: 24px;
            display: flex; justify-content: center;
        }
        .main-container {
            width: 100%; max-width: 1800px; display: grid;
            grid-template-columns: 280px 1fr; grid-template-rows: auto 1fr;
            grid-template-areas: "sidebar header" "sidebar main"; gap: 24px;
        }
        .sidebar {
            grid-area: sidebar; background-color: var(--surface-color); border-radius: 12px;
            padding: 24px; display: flex; flex-direction: column; gap: 16px;
        }
        .header { grid-area: header; }
        .main-content { grid-area: main; display: flex; flex-direction: column; gap: 24px; }
        .card {
            background-color: var(--surface-color); border-radius: 12px;
            padding: 24px; border: 1px solid var(--border-color);
        }
        h2, h3 {
            margin-top: 0; margin-bottom: 16px; color: var(--text-secondary);
            font-weight: 600; font-size: 1.1rem;
        }
        h3 { font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        .file-drop-area {
            border: 2px dashed var(--border-color); border-radius: 8px; padding: 30px 20px;
            text-align: center; cursor: pointer; transition: all 0.2s ease;
        }
        .file-drop-area.dragover { background-color: #334155; border-color: var(--primary-color); }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area span { color: var(--primary-color); font-weight: 500; }
        .order-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .order-item .order-btn { flex-grow: 1; text-align: left; padding: 12px; border-radius: 6px; border: 1px solid var(--border-color); background-color: #334155; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .order-item .order-btn:hover { background-color: #475569; color: var(--text-primary); }
        .order-item .order-btn.active { background-color: var(--primary-color); color: var(--bg-color); font-weight: 700; border-color: var(--primary-color); }
        .order-item .order-btn.is-complete { background-color: var(--success-color); color: var(--bg-color); border-color: var(--success-color); font-weight: 700;}
        .order-item .order-btn.is-complete:hover { background-color: #4ade80;}
        .order-item .order-btn.is-complete.active { box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.4); }
        .order-item .icon-btn {
            background: none; border: none; color: var(--text-dark); cursor: pointer; padding: 4px;
            display: flex; align-items: center; justify-content: center; transition: color 0.2s;
        }
        .order-item .icon-btn:hover { color: var(--text-primary); }
        .order-item .icon-btn svg { width: 20px; height: 20px; }

        .mode-switcher {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 4px;
            background-color: var(--bg-color); border-radius: 8px; margin-bottom: 16px;
        }
        .mode-switcher button {
            padding: 8px; border: none; background-color: transparent; color: var(--text-secondary);
            font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .mode-switcher button.active { background-color: var(--surface-color); color: var(--primary-color); }
        
        .summary-card {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 24px; text-align: center;
        }
        .stat-item h3 { margin: 0 0 8px 0; font-size: 1rem; font-weight: 500; }
        .stat-item p { margin: 0; font-size: 2rem; font-weight: 700; }
        #statOrderNumber { color: var(--primary-color); } #statPackedQty { color: var(--success-color); }
        #statRemainingQty { color: var(--warning-color); } #statScrapQty { color: var(--danger-color); }

        .table-wrapper { overflow: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        thead { position: sticky; top: 0; background-color: var(--surface-color); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.8rem; }
        
        /* Rastreo View specific */
        .rastreo-controls { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;}
        .filter-container { display: flex; flex-direction: column; gap: 16px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .btn, .filter-btn {
            padding: 8px 16px; border-radius: 6px; cursor: pointer; background-color: #334155;
            border: 1px solid #475569; color: var(--text-secondary); font-weight: 500;
            text-align: center; transition: all 0.2s;
        }
        .btn:hover, .filter-btn:hover { background-color: #475569; color: var(--text-primary); }
        .filter-btn.active { color: var(--bg-color); font-weight: 700; background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn { width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--bg-color); font-weight: 700;}
        .btn:disabled { background-color: #334155; color: var(--text-dark); cursor: not-allowed; border-color: #475569;}
        .btn:hover:not(:disabled) { background-color: #67CFFB;}
        #lineCountsContainer { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .line-badge { background-color: #334155; padding: 4px 12px; border-radius: 16px; font-size: 0.8rem; font-weight: 500; color: var(--text-dark); }
        .line-badge span { font-weight: 700; color: var(--text-secondary); }

        /* Packing Table Specific Styles */
        .box-row { cursor: pointer; }
        .box-row:hover { background-color: #334155; }
        .box-row td:first-child::before {
            content: '►'; display: inline-block; margin-right: 10px;
            font-size: 0.7rem; transition: transform 0.2s;
        }
        .box-row.expanded td:first-child::before { transform: rotate(90deg); }
        .serial-row { display: none; background-color: var(--bg-color); }
        .serial-row td { padding-left: 40px; border-color: #2a3a5e; }

        tbody tr.is-scrap { background-color: rgba(251, 113, 133, 0.1); }
        tbody tr.is-scrap td { color: var(--danger-color); }
        tbody tr.is-delayed { background-color: rgba(251, 191, 36, 0.1); }
        tbody tr.is-delayed td { color: var(--warning-color); }
        tbody tr.is-today { background-color: rgba(52, 211, 153, 0.1); }
        tbody tr.is-today td { color: var(--success-color); }
        
        #loader, #placeholderText { text-align: center; padding: 60px; color: var(--text-dark); font-size: 1.1rem; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--surface-color); border-radius: 12px; padding: 24px;
            border: 1px solid var(--border-color); width: 90%; max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
    </style>
</head>
<body>

    <div class="main-container">
        <aside class="sidebar">
            <h2>Panel de Control</h2>
            <div class="card">
                <h3>Cargar Órdenes</h3>
                <div id="fileDropArea" class="file-drop-area">
                    <p>Arrastra archivos aquí</p>
                    <p><span>o haz clic para seleccionar</span></p>
                </div>
                <input type="file" id="fileInput" accept=".xlsx, .xls" multiple style="display: none;">
                <input type="file" id="updateFileInput" accept=".xlsx, .xls" style="display: none;">
            </div>
            <div class="card" style="flex-grow: 1;">
                <h3>Órdenes Cargadas</h3>
                <div id="orderList">
                    <p class="text-dark" style="font-size:0.9rem;">Cargue uno o más archivos para comenzar.</p>
                </div>
            </div>
        </aside>

        <header class="header card">
             <div class="mode-switcher">
                <button id="modeRastreo" class="active">Rastreo</button>
                <button id="modeEmpaque">Empaque</button>
            </div>
            <div id="summaryCard" class="summary-card">
                 <div class="stat-item"><h3># de Orden</h3><p id="statOrderNumber">N/A</p></div>
                 <div class="stat-item"><h3>Cant. Orden</h3><p id="statOrderQty">0</p></div>
                 <div class="stat-item"><h3>Cant. Empacada</h3><p id="statPackedQty">0</p></div>
                 <div class="stat-item"><h3>Restante</h3><p id="statRemainingQty">0</p></div>
                 <div class="stat-item"><h3>Cant. en Scrap</h3><p id="statScrapQty">0</p></div>
            </div>
        </header>

        <main class="main-content">
            <div id="rastreoView" style="display:flex; flex-direction:column; gap:24px;">
                <div class="card rastreo-controls">
                    <div class="filter-container">
                        <div>
                            <h3>Filtrar por Estado</h3>
                            <div id="rastreoStatusFilters" class="filter-group">
                                <button class="filter-btn active" data-filter="all">Todos</button>
                                <button class="filter-btn" data-filter="today">En Movimiento</button>
                                <button class="filter-btn" data-filter="delayed">Sin Movimiento</button>
                                <button class="filter-btn" data-filter="scrap">Scrap</button>
                            </div>
                        </div>
                        <div>
                            <h3>Filtrar por Línea</h3>
                            <div id="rastreoLineFilters" class="filter-group">
                                <p id="rastreoLineFiltersPlaceholder" class="text-dark" style="font-size: 0.9rem;">Cargue un archivo para ver los filtros.</p>
                            </div>
                        </div>
                    </div>
                    <div>
                         <h3>Exportar Reportes</h3>
                         <p class="text-dark" style="font-size: 0.9rem; margin-top: 0; margin-bottom: 16px;">Exporta los datos que se muestran actualmente en la tabla.</p>
                         <button id="exportButton" class="btn" disabled>Exportar Vista Actual</button>
                    </div>
                </div>
                <div class="card" style="flex-grow:1; display:flex; flex-direction:column;">
                    <input type="text" id="rastreoFilterInput" placeholder="Buscar en la tabla por serial, status, etc..." style="margin-bottom: 16px;">
                    <div id="lineCountsContainer"></div>
                    <div class="table-wrapper">
                         <table id="rastreoTable"></table>
                         <p id="placeholderText">Cargue archivos para ver los datos de rastreo.</p>
                    </div>
                </div>
            </div>
            <div id="empaqueView" style="display: none;">
                <div class="card" style="height:100%; display:flex; flex-direction:column;">
                    <input type="text" id="empaqueFilterInput" placeholder="Buscar por Serial o BoxID..." style="margin-bottom:16px">
                    <div class="table-wrapper">
                         <table id="empaqueTable"></table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal HTML -->
    <div id="modalOverlay" class="modal-overlay">
        <div id="modalContent" class="modal-content">
             <span id="modalClose" class="modal-close">&times;</span>
             <h2 id="modalTitle" class="modal-title"></h2>
             <p id="modalMessage" style="margin-top:16px; color: var(--text-secondary);"></p>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let loadedOrders = new Map();
            let activeOrderKey = 'all';
            let currentMode = 'rastreo';
            let currentVisibleData = []; 
            let orderToUpdateKey = null;
            
            // --- RASTREO STATE ---
            let rastreoStatusFilter = 'all';
            let rastreoLineFilter = 'all';

            // --- KEY COLUMN NAMES ---
            const TRACKING_KEYS = { SERIAL: 'Product Serial Number', IS_SCRAP: 'Is Scrap', NOT_PACKED: 'Not Packed', CREATED_BY: 'Created By', DATE_REGISTERED: 'Date Registered', LINE: 'Line', STATION: 'Station' };
            const PACKING_KEYS = { SERIAL: 'Serial Number', EMPLOYEE_ID: 'Employee ID', PACKED_DATE: 'Finish Packed Date', BOX_ID: 'BoxID' };
            const TRACKING_COLS = ['B', 'C', 'G', 'K', 'M', 'P', 'V', 'Y', 'Z', 'AA', 'AB'];
            const PACKING_COLS = { SERIAL: 'AE', EMPLOYEE_ID: 'AF', PACKED_DATE: 'AK', BOX_ID: 'AO' };
            
            // --- DOM ELEMENTS ---
            const fileDropArea = document.getElementById('fileDropArea');
            const fileInput = document.getElementById('fileInput');
            const updateFileInput = document.getElementById('updateFileInput');
            const orderList = document.getElementById('orderList');
            const statOrderNumber = document.getElementById('statOrderNumber');
            const statOrderQty = document.getElementById('statOrderQty');
            const statPackedQty = document.getElementById('statPackedQty');
            const statRemainingQty = document.getElementById('statRemainingQty');
            const statScrapQty = document.getElementById('statScrapQty');
            const modeRastreo = document.getElementById('modeRastreo');
            const modeEmpaque = document.getElementById('modeEmpaque');
            const rastreoView = document.getElementById('rastreoView');
            const empaqueView = document.getElementById('empaqueView');
            const rastreoFilterInput = document.getElementById('rastreoFilterInput');
            const rastreoStatusFilters = document.getElementById('rastreoStatusFilters');
            const rastreoLineFilters = document.getElementById('rastreoLineFilters');
            const rastreoLineFiltersPlaceholder = document.getElementById('rastreoLineFiltersPlaceholder');
            const exportButton = document.getElementById('exportButton');
            const lineCountsContainer = document.getElementById('lineCountsContainer');
            const placeholderText = document.getElementById('placeholderText');
            const empaqueFilterInput = document.getElementById('empaqueFilterInput');
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalClose = document.getElementById('modalClose');

            // --- EVENT LISTENERS ---
            fileDropArea.addEventListener('click', () => fileInput.click());
            fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault(); fileDropArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files); });
            updateFileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files, true); });
            
            modeRastreo.addEventListener('click', () => switchMode('rastreo'));
            modeEmpaque.addEventListener('click', () => switchMode('empaque'));

            rastreoFilterInput.addEventListener('input', () => renderRastreoView(activeOrderKey));
            rastreoStatusFilters.addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    rastreoStatusFilters.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    rastreoStatusFilter = e.target.dataset.filter;
                    renderRastreoView(activeOrderKey);
                }
            });
             rastreoLineFilters.addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    if (rastreoLineFilters.querySelector('.active')) {
                        rastreoLineFilters.querySelector('.active').classList.remove('active');
                    }
                    e.target.classList.add('active');
                    rastreoLineFilter = e.target.dataset.filter;
                    renderRastreoView(activeOrderKey);
                }
            });

            empaqueFilterInput.addEventListener('input', () => renderEmpaqueView(activeOrderKey));
            exportButton.addEventListener('click', handleExport);

            modalClose.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });

            // --- MODAL FUNCTIONS ---
            function showModal(title, message, type = 'info') {
                 modalOverlay.querySelector('.modal-content').className = `modal-content ${type}`;
                 modalTitle.textContent = title;
                 modalMessage.textContent = message;
                 modalOverlay.classList.add('visible');
            }
            function hideModal() { modalOverlay.classList.remove('visible'); }

            // --- HELPER FUNCTIONS ---
            function excelSerialToDate(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                try {
                    const decoded = XLSX.SSF.parse_date_code(serial);
                    if (decoded) return new Date(decoded.y, decoded.m - 1, decoded.d, decoded.H, decoded.M, decoded.S);
                } catch(e) { console.error(e); }
                return null;
            }
            function formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }
             function findHeader(headers, keyText) { return headers.find(h => h.toLowerCase() === keyText.toLowerCase()); }

            // --- LOCALSTORAGE ---
            function saveOrdersToLocalStorage() {
                const dataToSave = JSON.stringify(Array.from(loadedOrders.entries()));
                localStorage.setItem('loadedOrdersData', dataToSave);
            }
            function loadOrdersFromLocalStorage() {
                const savedData = localStorage.getItem('loadedOrdersData');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        loadedOrders = new Map(parsedData);
                        if (loadedOrders.size > 0) {
                            updateOrderList();
                            render();
                        }
                    } catch(e) {
                        console.error("Failed to load data from localStorage", e);
                        localStorage.removeItem('loadedOrdersData');
                    }
                }
            }


            // --- FILE HANDLING & DATA PROCESSING ---
            function handleFiles(files, isUpdate = false) {
                const filePromises = Array.from(files).map(file => processFile(file, isUpdate));

                Promise.all(filePromises)
                    .then(results => {
                        let lastKey = activeOrderKey;
                        results.forEach(result => {
                            if (result) {
                                loadedOrders.set(result.key, result.data);
                                lastKey = result.key;
                            }
                        });
                        saveOrdersToLocalStorage();
                        updateOrderList();
                        setActiveOrder(lastKey);
                    })
                    .catch(err => {
                        showModal('Error al Cargar', 'Uno o más archivos no pudieron ser procesados.', 'error');
                        console.error(err);
                    });
            }

            function processFile(file, isUpdate) {
                 return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const orderNumber = worksheet['B3']?.v || `Archivo_${file.name.slice(0,10)}`;
                            
                            const keyToUpdate = isUpdate ? orderToUpdateKey : orderNumber;
                            
                            const rastreoRawData = extractTableData(worksheet, TRACKING_COLS, 20);
                            const packingRawData = extractTableData(worksheet, Object.values(PACKING_COLS), 20, true);

                            const orderData = {
                                orderQty: parseInt(worksheet['O3']?.v || 0),
                                packedQty: parseInt(worksheet['U3']?.v || 0),
                                rastreoData: processRastreoData(rastreoRawData),
                                empaqueData: groupEmpaqueData(packingRawData),
                                headers: {
                                    rastreo: Object.keys(rastreoRawData[0] || {}),
                                    empaque: Object.keys(packingRawData[0] || {})
                                }
                            };
                            resolve({ key: keyToUpdate, data: orderData });
                        } catch(err) { reject(err); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }


            function extractTableData(worksheet, targetCols, startRow, isPacking = false) {
                 const headers = {};
                 const colsToUse = isPacking ? Object.keys(PACKING_COLS) : targetCols;
                 colsToUse.forEach(key => {
                     const col = isPacking ? PACKING_COLS[key] : key;
                     const cell = worksheet[col + startRow];
                     if(cell && cell.v) headers[col] = cell.v.toString().trim();
                 });

                 if (Object.keys(headers).length === 0) return [];
                 const jsonData = [];
                 const range = XLSX.utils.decode_range(worksheet['!ref']);
                 for (let rowNum = startRow; rowNum <= range.e.r; ++rowNum) {
                     const row = {};
                     let hasData = false;
                     colsToUse.forEach(key => {
                         const col = isPacking ? PACKING_COLS[key] : key;
                         const headerName = headers[col];
                         if (headerName) {
                            const cellAddress = col + (rowNum + 1);
                            const cell = worksheet[cellAddress];
                            if(cell && cell.v !== undefined) {
                                row[headerName] = cell.v;
                                hasData = true;
                            }
                         }
                     });
                     if (hasData) jsonData.push(row);
                 }
                 return jsonData;
            }
            
            function processRastreoData(data) {
                if (data.length === 0) return [];
                const today = new Date();
                const headers = Object.keys(data[0]);
                const scrapHeader = findHeader(headers, TRACKING_KEYS.IS_SCRAP);
                const dateHeader = findHeader(headers, TRACKING_KEYS.DATE_REGISTERED);
                
                return data.map(row => {
                    let status = 'normal';
                    const isScrap = String(row[scrapHeader]).trim().toUpperCase() === 'X';
                     if (isScrap) {
                        status = 'scrap';
                    } else {
                        const registeredDate = excelSerialToDate(row[dateHeader]);
                        if (registeredDate instanceof Date) {
                            if (registeredDate.toDateString() === today.toDateString()) status = 'today';
                            else if (registeredDate < today) status = 'delayed';
                        }
                    }
                    return { ...row, status };
                });
            }

            function groupEmpaqueData(data) {
                if (!data || data.length === 0) return new Map();
                const headers = Object.keys(data[0]);
                const boxIdHeader = findHeader(headers, PACKING_KEYS.BOX_ID);
                
                return data.reduce((acc, row) => {
                    const boxId = row[boxIdHeader];
                    if (boxId) {
                        if (!acc.has(boxId)) acc.set(boxId, []);
                        acc.get(boxId).push(row);
                    }
                    return acc;
                }, new Map());
            }
            
            function handleExport() {
                const headers = (activeOrderKey === 'all' ? loadedOrders.values().next().value?.headers.rastreo : loadedOrders.get(activeOrderKey)?.headers.rastreo) || [];
                const serialHeader = findHeader(headers, TRACKING_KEYS.SERIAL);
                const stationHeader = findHeader(headers, TRACKING_KEYS.STATION);
                const dateRegisteredHeader = findHeader(headers, TRACKING_KEYS.DATE_REGISTERED);
                
                if (!serialHeader || !stationHeader || !dateRegisteredHeader) {
                    showModal('Error de Exportación', `No se pudo identificar una columna clave ("${TRACKING_KEYS.SERIAL}", "${TRACKING_KEYS.STATION}", o "${TRACKING_KEYS.DATE_REGISTERED}"). Verifique el archivo.`, 'error');
                    return;
                }
                
                if (currentVisibleData.length === 0) {
                     showModal('Información', 'No hay datos visibles en la tabla para exportar.', 'info');
                    return;
                }

                const orderNumber = statOrderNumber.textContent;
                const finalData = currentVisibleData.map(row => {
                    const serial = String(row[serialHeader] || '');
                    const cleanedSerial = serial.replace(/S#/i, '');
                    return {
                        'Numero_de_Orden': orderNumber,
                        'Serial_Para_Reimpresion': cleanedSerial,
                        'Estacion': row[stationHeader],
                        'Fecha_y_Hora_Ultimo_Movimiento': formatDate(excelSerialToDate(row[dateRegisteredHeader]))
                    };
                });

                const worksheet = XLSX.utils.json_to_sheet([]);
                const lineFilterText = rastreoLineFilter === 'all' ? 'Todas las Líneas' : `Línea: ${rastreoLineFilter}`;
                const headerText = `Reporte de Exportación para ${lineFilterText}`;

                XLSX.utils.sheet_add_aoa(worksheet, [[headerText]], { origin: "A1"});
                XLSX.utils.sheet_add_json(worksheet, finalData, { origin: "A2", skipHeader: false });
                
                const merge = { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } };
                if (!worksheet['!merges']) worksheet['!merges'] = [];
                worksheet['!merges'].push(merge);

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Exportación");
                
                const linePart = rastreoLineFilter === 'all' ? 'Todas_Lineas' : `Linea_${rastreoLineFilter}`;
                const fileName = `Exportacion_Orden_${orderNumber}_${linePart}.xlsx`;
                XLSX.writeFile(workbook, fileName);

                showModal('Exportación Exitosa', `Se ha generado el archivo "${fileName}" con ${finalData.length} seriales.`, 'success');
            }


            // --- UI & RENDERING ---
            function switchMode(mode) {
                currentMode = mode;
                modeRastreo.classList.toggle('active', mode === 'rastreo');
                modeEmpaque.classList.toggle('active', mode === 'empaque');
                rastreoView.style.display = mode === 'rastreo' ? 'flex' : 'none';
                empaqueView.style.display = mode === 'empaque' ? 'block' : 'none';
                render();
            }

            function updateOrderList() {
                orderList.innerHTML = '';
                const allBtn = createOrderButton('all', 'Vista General');
                orderList.appendChild(allBtn);

                for (const key of loadedOrders.keys()) {
                    const orderItem = createOrderButton(key, key);
                    orderList.appendChild(orderItem);
                }
                setActiveOrder(activeOrderKey);
                saveOrdersToLocalStorage();
            }
            
            function createOrderButton(key, text) {
                const item = document.createElement('div');
                item.className = 'order-item';
                
                const btn = document.createElement('button');
                btn.className = 'order-btn';
                btn.textContent = text;
                btn.dataset.key = key;
                btn.onclick = () => setActiveOrder(key);
                
                if (key !== 'all') {
                    const orderData = loadedOrders.get(key);
                    if (orderData.orderQty > 0 && orderData.orderQty <= orderData.packedQty) {
                        btn.classList.add('is-complete');
                    }
                }
                item.appendChild(btn);

                if (key !== 'all') {
                    const updateBtn = document.createElement('button');
                    updateBtn.className = 'icon-btn';
                    updateBtn.title = 'Actualizar orden';
                    updateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 2ZM10 15a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 15ZM10 7a3 3 0 1 0 0 6 3 3 0 0 0 0-6ZM15.39 12.34a.75.75 0 0 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 1.06l-1.06 1.06ZM4.66 6.39a.75.75 0 0 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 1.06l-1.06 1.06ZM17.25 10a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 .75.75ZM5.25 10a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 .75.75ZM13.61 6.39a.75.75 0 0 1 1.06-1.06l1.06 1.06a.75.75 0 0 1-1.06 1.06l-1.06-1.06ZM6.39 13.61a.75.75 0 0 1 1.06-1.06l-1.06-1.06a.75.75 0 0 1-1.06 1.06l1.06 1.06Z"/></svg>`;
                    updateBtn.onclick = () => {
                        orderToUpdateKey = key;
                        updateFileInput.click();
                    };
                    item.appendChild(updateBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-btn';
                    deleteBtn.title = 'Eliminar orden';
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75V4.5h8V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 6a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5A.75.75 0 0 1 10 6ZM4.5 6a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1h-11Z" clip-rule="evenodd" /></svg>`;
                    deleteBtn.onclick = () => {
                        loadedOrders.delete(key);
                        if (activeOrderKey === key) activeOrderKey = 'all';
                        updateOrderList();
                        render();
                    };
                    item.appendChild(deleteBtn);
                }

                return item;
            }

            function setActiveOrder(key) {
                activeOrderKey = key;
                orderList.querySelectorAll('.order-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.key === key);
                });
                render();
            }

            function render() {
                if (loadedOrders.size === 0) {
                    placeholderText.style.display = 'block';
                    document.getElementById('rastreoTable').innerHTML = '';
                    document.getElementById('empaqueTable').innerHTML = '';
                    exportButton.disabled = true;
                    rastreoLineFiltersPlaceholder.textContent = 'Cargue un archivo para ver los filtros.';
                    rastreoLineFilters.innerHTML = '';
                    lineCountsContainer.innerHTML = '';
                    return;
                }
                placeholderText.style.display = 'none';
                renderSummary();
                if (currentMode === 'rastreo') {
                    renderRastreoView(activeOrderKey);
                } else {
                    renderEmpaqueView(activeOrderKey);
                }
            }

            function renderSummary() {
                let orderQty = 0, packedQty = 0, scrapCount = 0;
                let ordersToProcess = [];

                if (activeOrderKey === 'all') {
                    ordersToProcess = Array.from(loadedOrders.values());
                    statOrderNumber.textContent = 'Múltiples';
                } else if (loadedOrders.has(activeOrderKey)) {
                    ordersToProcess = [loadedOrders.get(activeOrderKey)];
                    statOrderNumber.textContent = activeOrderKey;
                }

                ordersToProcess.forEach(order => {
                    orderQty += order.orderQty;
                    packedQty += order.packedQty;
                    const scrapHeader = findHeader(order.headers.rastreo, TRACKING_KEYS.IS_SCRAP);
                    scrapCount += order.rastreoData.filter(row => String(row[scrapHeader]).trim().toUpperCase() === 'X').length;
                });

                statOrderQty.textContent = orderQty;
                statPackedQty.textContent = packedQty;
                statRemainingQty.textContent = orderQty - packedQty;
                statScrapQty.textContent = scrapCount;
            }
            
            function renderRastreoView(key) {
                let dataToShow = [];
                let headers = [];
                if (key === 'all') {
                    loadedOrders.forEach(order => dataToShow.push(...order.rastreoData));
                    if (loadedOrders.size > 0) headers = loadedOrders.values().next().value.headers.rastreo;
                } else if (loadedOrders.has(key)) {
                    const order = loadedOrders.get(key);
                    dataToShow = order.rastreoData;
                    headers = order.headers.rastreo;
                }
                
                createRastreoLineFilters(dataToShow, headers);

                // Apply filters
                let filteredData = dataToShow;
                if (rastreoStatusFilter !== 'all') {
                    filteredData = filteredData.filter(row => row.status === rastreoStatusFilter);
                }
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (rastreoLineFilter !== 'all' && lineHeader) {
                    filteredData = filteredData.filter(row => row[lineHeader] === rastreoLineFilter);
                }
                const searchText = rastreoFilterInput.value.toLowerCase();
                if (searchText) {
                    filteredData = filteredData.filter(row =>
                        Object.entries(row).some(([k, val]) => k !== 'status' && String(val).toLowerCase().includes(searchText))
                    );
                }

                currentVisibleData = filteredData;
                exportButton.disabled = false;

                updateRastreoTable(filteredData, headers);
                updateLineCounts(filteredData, headers);
            }

             function createRastreoLineFilters(data, headers) {
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (!lineHeader) {
                    rastreoLineFiltersPlaceholder.textContent = "No se encontró la columna 'Line'.";
                    rastreoLineFiltersPlaceholder.style.display = 'block';
                    rastreoLineFilters.innerHTML = '';
                    return;
                }

                const uniqueLines = [...new Set(data.map(row => row[lineHeader]).filter(Boolean))].sort();
                rastreoLineFilters.innerHTML = '';
                rastreoLineFiltersPlaceholder.style.display = 'none';

                const allBtn = document.createElement('button');
                allBtn.className = 'filter-btn';
                allBtn.textContent = 'Todas';
                allBtn.dataset.filter = 'all';
                rastreoLineFilters.appendChild(allBtn);

                uniqueLines.forEach(line => {
                    const lineBtn = document.createElement('button');
                    lineBtn.className = 'filter-btn';
                    lineBtn.textContent = line;
                    lineBtn.dataset.filter = line;
                    rastreoLineFilters.appendChild(lineBtn);
                });
                
                const activeBtn = rastreoLineFilters.querySelector(`[data-filter="${rastreoLineFilter}"]`) || rastreoLineFilters.querySelector('[data-filter="all"]');
                if(activeBtn) activeBtn.classList.add('active');
            }
            
            function updateRastreoTable(data, headers) {
                const table = document.getElementById('rastreoTable');
                if (!table) return;

                const headersToHide = [TRACKING_KEYS.CREATED_BY, TRACKING_KEYS.NOT_PACKED, TRACKING_KEYS.IS_SCRAP].map(h => findHeader(headers, h)).filter(Boolean);
                const displayHeaders = headers.filter(h => !headersToHide.includes(h) && h !== 'status');

                if (data.length === 0) {
                    table.innerHTML = `<thead><tr><th>No se encontraron resultados para los filtros aplicados.</th></tr></thead>`;
                    return;
                }
                
                table.innerHTML = `
                    <thead><tr>${displayHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>
                        ${data.map(row => `
                            <tr class="is-${row.status}">
                                ${displayHeaders.map(h => `<td>${formatCell(row[h], h)}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>`;
            }

            function updateLineCounts(data, headers) {
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (!lineHeader) {
                    lineCountsContainer.innerHTML = ''; return;
                }
                const counts = data.reduce((acc, row) => {
                    const line = row[lineHeader];
                    if (line) acc[line] = (acc[line] || 0) + 1;
                    return acc;
                }, {});
                
                lineCountsContainer.innerHTML = Object.entries(counts).sort().map(([line, count]) =>
                    `<div class="line-badge">${line}: <span>${count}</span></div>`
                ).join('');
            }
            
            function renderEmpaqueView(key) {
                let dataToShow = new Map();
                let headers = [];

                if (key === 'all') {
                    loadedOrders.forEach(order => {
                        order.empaqueData.forEach((serials, boxId) => {
                            if (!dataToShow.has(boxId)) dataToShow.set(boxId, []);
                            dataToShow.get(boxId).push(...serials);
                        });
                    });
                    if (loadedOrders.size > 0) headers = loadedOrders.values().next().value.headers.empaque;
                } else if (loadedOrders.has(key)) {
                    const order = loadedOrders.get(key);
                    dataToShow = order.empaqueData;
                    headers = order.headers.empaque;
                }
                
                const table = document.getElementById('empaqueTable');
                if (dataToShow.size === 0 || headers.length === 0) {
                     table.innerHTML = `<thead><tr><th>No hay datos de empaque para mostrar.</th></tr></thead>`;
                    return;
                }
                
                const boxIdHeader = findHeader(headers, PACKING_KEYS.BOX_ID);
                const serialHeader = findHeader(headers, PACKING_KEYS.SERIAL);
                const packedDateHeader = findHeader(headers, PACKING_KEYS.PACKED_DATE);
                const employeeIdHeader = findHeader(headers, PACKING_KEYS.EMPLOYEE_ID);

                const filterText = empaqueFilterInput.value.toLowerCase();
                let tableHTML = `
                    <thead>
                        <tr>
                            <th>${boxIdHeader}</th>
                            <th>Cantidad</th>
                            <th>Último Empaque</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                for (const [boxId, serials] of dataToShow.entries()) {
                    const latestDate = Math.max(...serials.map(s => s[packedDateHeader]));
                    const serialsMatchFilter = serials.some(s => String(s[serialHeader]).toLowerCase().includes(filterText));
                    if (!String(boxId).toLowerCase().includes(filterText) && !serialsMatchFilter) continue;

                    tableHTML += `
                        <tr class="box-row" data-boxid="${boxId}">
                            <td>${boxId}</td>
                            <td>${serials.length}</td>
                            <td>${formatDate(excelSerialToDate(latestDate))}</td>
                        </tr>`;

                    serials.forEach(serial => {
                         tableHTML += `
                            <tr class="serial-row" data-parentbox="${boxId}">
                                <td colspan="3">
                                    <strong>Serial:</strong> ${serial[serialHeader]} | 
                                    <strong>Empacador:</strong> ${serial[employeeIdHeader] || 'N/A'} | 
                                    <strong>Fecha:</strong> ${formatDate(excelSerialToDate(serial[packedDateHeader]))}
                                </td>
                            </tr>`;
                    });
                }
                tableHTML += `</tbody>`;
                table.innerHTML = tableHTML;

                table.querySelectorAll('.box-row').forEach(row => {
                    row.addEventListener('click', () => {
                        row.classList.toggle('expanded');
                        const boxId = row.dataset.boxid;
                        table.querySelectorAll(`.serial-row[data-parentbox="${boxId}"]`).forEach(serialRow => {
                            serialRow.style.display = row.classList.contains('expanded') ? 'table-row' : 'none';
                        });
                    });
                });
            }

            function formatCell(value, header) {
                 if (header.toLowerCase().includes('date')) return formatDate(excelSerialToDate(value));
                 return value === undefined ? '' : value;
            }

            function resetView() {
                activeOrderKey = 'all';
                currentMode = 'rastreo';
                updateOrderList();
                render();
            }

             // Initialize view
            loadOrdersFromLocalStorage();

        });
    </script>
</body>
</html>