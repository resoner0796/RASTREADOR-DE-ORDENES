<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Control de Producción (Versión Final)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0F172A; --surface-color: #1E293B; --border-color: #334155;
            --primary-color: #38BDF8; --danger-color: #FB7185; --warning-color: #FBBF24;
            --success-color: #34D399; --text-primary: #F8FAFC; --text-secondary: #94A3B8;
            --text-dark: #64748B;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color);
            color: var(--text-primary); margin: 0; padding: 16px;
            display: flex; justify-content: center;
        }
        .app-header {
            text-align: center;
            margin-bottom: 16px;
        }
        .app-branding {
            font-family: 'Tinos', 'Times New Roman', serif;
            font-weight: 400;
            font-size: 2.2rem;
            color: var(--text-primary);
            letter-spacing: 2px;
            margin: 0;
        }
        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 4px 0 0 0;
        }
        .main-container {
            width: 100%; max-width: 1600px; display: grid;
            grid-template-columns: 260px 1fr;
            grid-template-rows: auto auto 1fr;
            grid-template-areas: "sidebar global-header" "sidebar header" "sidebar main"; 
            gap: 16px;
        }
        .sidebar {
            grid-area: sidebar; background-color: var(--surface-color); border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column; gap: 16px;
        }
        .global-header { grid-area: global-header; }
        .header { grid-area: header; }
        .main-content { grid-area: main; display: flex; flex-direction: column; gap: 16px; }
        .card {
            background-color: var(--surface-color); border-radius: 12px;
            padding: 20px; border: 1px solid var(--border-color);
        }
        h2, h3 {
            margin-top: 0; margin-bottom: 12px; color: var(--text-secondary);
            font-weight: 600; font-size: 1rem;
        }
        h3 { font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        .file-drop-area {
            border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px;
            text-align: center; cursor: pointer; transition: all 0.2s ease;
        }
        .file-drop-area.dragover { background-color: #334155; border-color: var(--primary-color); }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area span { color: var(--primary-color); font-weight: 500; }
        .order-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .order-item .order-btn { flex-grow: 1; text-align: left; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background-color: #334155; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .order-item .order-btn:hover { background-color: #475569; color: var(--text-primary); }
        .order-item .order-btn.active { background-color: var(--primary-color); color: var(--bg-color); font-weight: 700; border-color: var(--primary-color); }
        .order-item .order-btn.is-complete { background-color: var(--success-color); color: var(--bg-color); border-color: var(--success-color); font-weight: 700;}
        .order-item .order-btn.is-complete:hover { background-color: #4ade80;}
        .order-item .order-btn.is-complete.active { box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.4); }
        .order-item .icon-btn {
            background: none; border: none; color: var(--text-dark); cursor: pointer; padding: 4px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
            font-size: 1.2rem;
            filter: grayscale(1) opacity(0.6);
        }
        .order-item .icon-btn:hover { color: var(--text-primary); filter: grayscale(0) opacity(1); }
        
        .mode-switcher {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 4px;
            background-color: var(--bg-color); border-radius: 8px; margin-bottom: 16px;
        }
        .mode-switcher button {
            padding: 8px; border: none; background-color: transparent; color: var(--text-secondary);
            font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .mode-switcher button.active { background-color: var(--surface-color); color: var(--primary-color); }
        
        .summary-card, .global-dashboard-card {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px; text-align: center;
        }
        .stat-item { display: flex; flex-direction: column; justify-content: center; }
        .stat-item h3 { margin: 0 0 8px 0; font-size: 0.9rem; font-weight: 500; }
        .stat-item p { margin: 0; font-size: 1.75rem; font-weight: 700; }
        #statOrderNumber, #statCatalogNumber { color: var(--primary-color); }
        #statCatalogNumber { font-size: 1rem; color: var(--text-primary); font-weight: 500; margin-top: 4px; height: 1.2em; }
        #statPackedQty { color: var(--success-color); }
        #statRemainingQty { color: var(--warning-color); } #statScrapQty { color: var(--danger-color); }

        .table-wrapper { overflow: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem;}
        thead { position: sticky; top: 0; background-color: var(--surface-color); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; }
        
        .rastreo-controls { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;}
        .filter-container { display: flex; flex-direction: column; gap: 16px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .btn, .filter-btn {
            padding: 8px 14px; border-radius: 6px; cursor: pointer; background-color: #334155;
            border: 1px solid #475569; color: var(--text-secondary); font-weight: 500;
            text-align: center; transition: all 0.2s; font-size: 0.9rem;
        }
        .btn:hover, .filter-btn:hover { background-color: #475569; color: var(--text-primary); }
        .filter-btn.active { color: var(--bg-color); font-weight: 700; background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn { width: 100%; padding: 10px; background-color: var(--primary-color); color: var(--bg-color); font-weight: 700;}
        .btn:disabled { background-color: #334155; color: var(--text-dark); cursor: not-allowed; border-color: #475569;}
        .btn:hover:not(:disabled) { background-color: #67CFFB;}
        #lineCountsContainer { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .line-badge { background-color: #334155; padding: 4px 12px; border-radius: 16px; font-size: 0.8rem; font-weight: 500; color: var(--text-dark); }
        .line-badge span { font-weight: 700; color: var(--text-secondary); }

        .box-row { cursor: pointer; }
        .box-row:hover { background-color: #334155; }
        .box-row td:first-child::before {
            content: '►'; display: inline-block; margin-right: 10px;
            font-size: 0.7rem; transition: transform 0.2s;
        }
        .box-row.expanded td:first-child::before { transform: rotate(90deg); }
        .serial-row { display: none; background-color: var(--bg-color); }
        .serial-row td { padding-left: 40px; border-color: #2a3a5e; }

        tbody tr.is-scrap { background-color: rgba(251, 113, 133, 0.1); }
        tbody tr.is-scrap td { color: var(--danger-color); }
        tbody tr.is-delayed { background-color: rgba(251, 191, 36, 0.1); }
        tbody tr.is-delayed td { color: var(--warning-color); }
        tbody tr.is-today { background-color: rgba(52, 211, 153, 0.1); }
        tbody tr.is-today td { color: var(--success-color); }
        
        #loader, #placeholderText { text-align: center; padding: 60px; color: var(--text-dark); font-size: 1.1rem; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--surface-color); border-radius: 12px; padding: 24px;
            border: 1px solid var(--border-color); width: 90%; max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
        #modalBody textarea { width: 100%; height: 100px; resize: none; background-color: var(--bg-color); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px;}


        /* --- NUEVO: Estilos responsivos y layout móvil --- */
        @media (max-width: 992px) {
            body { padding: 8px; }
            .main-container {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            /* Reordenar elementos para la vista móvil */
            .app-header { order: 1; margin-bottom: 8px;}
            .global-header { order: 2; }
            .header { order: 3; }
            .sidebar { order: 4; }
            .main-content { order: 5; }

            /* Ocultar elementos de escritorio y simplificar contenedores */
            .sidebar {
                display: contents; /* Hace que los hijos del sidebar se comporten como hijos directos del flex container */
            }
            .sidebar > h2 { display: none; } /* Oculta el "Panel de Control" general */
            .main-content {
                display: contents; /* Idem para el contenido principal */
            }
            
            /* Ajustar tarjetas de estadísticas según el nuevo diseño */
            .global-dashboard-card { grid-template-columns: 1fr 1fr; }
            .summary-card { 
                grid-template-columns: 1fr 1fr; 
                /* Busca el stat-item que contiene #statOrderNumber y lo hace abarcar 2 columnas */
                & > .stat-item:has(#statOrderNumber) {
                    grid-column: 1 / -1;
                }
            }
            .stat-item p { font-size: 1.5rem; }

            /* Lógica para tarjetas desplegables en MÓVIL */
            .card.mobile-collapsible > *:not(.mobile-trigger) {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-out, opacity 0.2s ease-out, padding 0.3s ease-out;
                opacity: 0;
                padding-top: 0 !important;
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }
             .card.mobile-collapsible h3.mobile-trigger {
                margin-bottom: 0; /* Quitar margen inferior del h3 cuando es un trigger */
                cursor: pointer;
                user-select: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
             }
             .card.mobile-collapsible h3.mobile-trigger::after {
                content: '►';
                display: inline-block;
                font-size: 0.7rem;
                transition: transform 0.2s;
                color: var(--text-secondary);
             }

            /* Estilos cuando la tarjeta está expandida */
            .card.mobile-collapsible.expanded > *:not(.mobile-trigger) {
                max-height: 1500px; /* Un valor suficientemente grande */
                opacity: 1;
                margin-top: 16px !important;
            }
             .card.mobile-collapsible.expanded h3.mobile-trigger::after {
                transform: rotate(90deg);
             }
            
             /* Agrupar filtros y acciones en el móvil */
            .rastreo-controls .filter-container > div:last-of-type,
            .rastreo-controls > div:last-of-type {
                 border-top: 1px solid var(--border-color);
                 padding-top: 16px;
                 margin-top: 6px;
            }
        }
    </style>
</head>
<body>
    <div style="width: 100%; max-width: 1800px;">
        <header class="app-header">
            <h1 class="app-branding">CORNING</h1>
            <h2 class="app-title">Centro de Rastreo de Órdenes</h2>
        </header>
        <div class="main-container">
            <aside class="sidebar">
                <h2>Panel de Control</h2>
                <div class="card" id="uploadCard">
                    <h3>Cargar Órdenes</h3>
                    <div id="fileDropArea" class="file-drop-area">
                        <p>Arrastra archivos (.xlsx, .json)</p>
                        <p><span>o haz clic para seleccionar</span></p>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .json" multiple style="display: none;">
                    <input type="file" id="updateFileInput" accept=".xlsx, .xls" style="display: none;">
                </div>
                <div class="card" style="flex-grow: 1;" id="orderListCard">
                    <h3>Órdenes Cargadas</h3>
                    <div id="orderList">
                        <p class="text-dark" style="font-size:0.9rem;">Cargue uno o más archivos para comenzar.</p>
                    </div>
                </div>
            </aside>
    
            <header class="global-header card">
                <div class="global-dashboard-card">
                     <div class="stat-item">
                        <h3>Órdenes del Día</h3>
                        <p id="totalOrdersStat">0</p>
                    </div>
                     <div class="stat-item">
                        <h3>Órdenes Terminadas</h3>
                        <p id="completedOrdersStat">0</p>
                    </div>
                </div>
            </header>
    
            <section class="header card">
                 <div class="mode-switcher">
                    <button id="modeRastreo" class="active">Rastreo</button>
                    <button id="modeEmpaque">Empaque</button>
                </div>
                <div id="summaryCard" class="summary-card">
                     <div class="stat-item">
                         <h3># de Orden</h3>
                         <p id="statOrderNumber">N/A</p>
                         <p id="statCatalogNumber"></p>
                     </div>
                     <div class="stat-item"><h3>Cant. Orden</h3><p id="statOrderQty">0</p></div>
                     <div class="stat-item"><h3>Cant. Empacada</h3><p id="statPackedQty">0</p></div>
                     <div class="stat-item"><h3>Restante</h3><p id="statRemainingQty">0</p></div>
                     <div class="stat-item"><h3>Cant. en Scrap</h3><p id="statScrapQty">0</p></div>
                </div>
            </section>
    
            <main class="main-content">
                <div id="rastreoView" style="display:flex; flex-direction:column; gap:16px;">
                    <div class="card rastreo-controls" id="filtersCard">
                        <div class="filter-container">
                            <div>
                                <h3>Filtrar por Estado</h3>
                                <div id="rastreoStatusFilters" class="filter-group">
                                    <button class="filter-btn active" data-filter="all">Todos</button>
                                    <button class="filter-btn" data-filter="today">En Movimiento</button>
                                    <button class="filter-btn" data-filter="delayed">Sin Movimiento</button>
                                    <button class="filter-btn" data-filter="scrap">Scrap</button>
                                </div>
                            </div>
                            <div>
                                <h3>Filtrar por Línea</h3>
                                <div id="rastreoLineFilters" class="filter-group">
                                    <p id="rastreoLineFiltersPlaceholder" class="text-dark" style="font-size: 0.9rem;">Cargue un archivo para ver los filtros.</p>
                                </div>
                            </div>
                        </div>
                        <div>
                             <h3>Acciones y Reportes</h3>
                             <div style="display: flex; flex-direction: column; gap: 10px;">
                                 <button id="exportViewButton" class="btn" disabled>Exportar Vista a Excel</button>
                                 <button id="exportStatusButton" class="btn" disabled>Generar Reporte de Estatus</button>
                                 <button id="shareSessionButton" class="btn" disabled>Guardar Sesión para Compartir</button>
                             </div>
                        </div>
                    </div>
                    <div class="card" style="flex-grow:1; display:flex; flex-direction:column;">
                        <input type="text" id="rastreoFilterInput" placeholder="Buscar en la tabla por serial, status, etc..." style="margin-bottom: 16px;">
                        <div id="lineCountsContainer"></div>
                        <div class="table-wrapper">
                             <table id="rastreoTable"></table>
                             <p id="placeholderText">Cargue archivos para ver los datos de rastreo.</p>
                        </div>
                    </div>
                </div>
                <div id="empaqueView" style="display: none;">
                    <div class="card" style="height:100%; display:flex; flex-direction:column;">
                        <input type="text" id="empaqueFilterInput" placeholder="Buscar por Serial o BoxID..." style="margin-bottom:16px">
                        <div class="table-wrapper">
                             <table id="empaqueTable"></table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="modalOverlay" class="modal-overlay">
        <div id="modalContent" class="modal-content">
             <span id="modalClose" class="modal-close">&times;</span>
             <h2 id="modalTitle" class="modal-title"></h2>
             <div id="modalBody" style="margin-top:16px; color: var(--text-secondary);"></div>
             <button id="copyReportBtn" class="btn" style="margin-top: 20px; display:none;">Copiar al Portapapeles</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let loadedOrders = new Map();
            let activeOrderKey = 'all';
            let currentMode = 'rastreo';
            let currentVisibleData = []; 
            let orderToUpdateKey = null;
            
            // --- RASTREO STATE ---
            let rastreoStatusFilter = 'all';
            let rastreoLineFilter = 'all';

            // --- KEY COLUMN NAMES ---
            const TRACKING_KEYS = { SERIAL: 'Product Serial Number', IS_SCRAP: 'Is Scrap', NOT_PACKED: 'Not Packed', CREATED_BY: 'Created By', DATE_REGISTERED: 'Date Registered', LINE: 'Line', STATION: 'Station' };
            const PACKING_KEYS = { SERIAL: 'Serial Number', EMPLOYEE_ID: 'Employee ID', PACKED_DATE: 'Finish Packed Date', BOX_ID: 'BoxID' };
            const TRACKING_COLS = ['B', 'C', 'G', 'K', 'M', 'P', 'V', 'Y', 'Z', 'AA', 'AB'];
            const PACKING_COLS = { SERIAL: 'AE', EMPLOYEE_ID: 'AF', PACKED_DATE: 'AK', BOX_ID: 'AO' };
            
            // --- DOM ELEMENTS ---
            const fileDropArea = document.getElementById('fileDropArea');
            const fileInput = document.getElementById('fileInput');
            const updateFileInput = document.getElementById('updateFileInput');
            const orderList = document.getElementById('orderList');
            const statOrderNumber = document.getElementById('statOrderNumber');
            const statCatalogNumber = document.getElementById('statCatalogNumber');
            const statOrderQty = document.getElementById('statOrderQty');
            const statPackedQty = document.getElementById('statPackedQty');
            const statRemainingQty = document.getElementById('statRemainingQty');
            const statScrapQty = document.getElementById('statScrapQty');
            const totalOrdersStat = document.getElementById('totalOrdersStat');
            const completedOrdersStat = document.getElementById('completedOrdersStat');
            const modeRastreo = document.getElementById('modeRastreo');
            const modeEmpaque = document.getElementById('modeEmpaque');
            const rastreoView = document.getElementById('rastreoView');
            const empaqueView = document.getElementById('empaqueView');
            const rastreoFilterInput = document.getElementById('rastreoFilterInput');
            const rastreoStatusFilters = document.getElementById('rastreoStatusFilters');
            const rastreoLineFilters = document.getElementById('rastreoLineFilters');
            const rastreoLineFiltersPlaceholder = document.getElementById('rastreoLineFiltersPlaceholder');
            const exportViewButton = document.getElementById('exportViewButton');
            const exportStatusButton = document.getElementById('exportStatusButton');
            const shareSessionButton = document.getElementById('shareSessionButton');
            const lineCountsContainer = document.getElementById('lineCountsContainer');
            const placeholderText = document.getElementById('placeholderText');
            const empaqueFilterInput = document.getElementById('empaqueFilterInput');
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalClose = document.getElementById('modalClose');
            const copyReportBtn = document.getElementById('copyReportBtn');

            // --- EVENT LISTENERS ---
            fileDropArea.addEventListener('click', () => fileInput.click());
            fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault(); fileDropArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files); });
            updateFileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files, true); });
            
            modeRastreo.addEventListener('click', () => switchMode('rastreo'));
            modeEmpaque.addEventListener('click', () => switchMode('empaque'));

            rastreoFilterInput.addEventListener('input', () => renderRastreoView(activeOrderKey));
            rastreoStatusFilters.addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    rastreoStatusFilters.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    rastreoStatusFilter = e.target.dataset.filter;
                    renderRastreoView(activeOrderKey);
                }
            });
             rastreoLineFilters.addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    if (rastreoLineFilters.querySelector('.active')) {
                        rastreoLineFilters.querySelector('.active').classList.remove('active');
                    }
                    e.target.classList.add('active');
                    rastreoLineFilter = e.target.dataset.filter;
                    renderRastreoView(activeOrderKey);
                }
            });

            empaqueFilterInput.addEventListener('input', () => renderEmpaqueView(activeOrderKey));
            exportViewButton.addEventListener('click', handleExport);
            exportStatusButton.addEventListener('click', handleStatusReport);
            shareSessionButton.addEventListener('click', generateShareFile);

            modalClose.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });

            // --- MODAL FUNCTIONS ---
            function showModal(title, message, type = 'info', showCopyBtn = false) {
                 modalOverlay.querySelector('.modal-content').className = `modal-content ${type}`;
                 modalTitle.textContent = title;
                 modalBody.innerHTML = message; // Use innerHTML to render report table
                 copyReportBtn.style.display = showCopyBtn ? 'block' : 'none';
                 modalOverlay.classList.add('visible');
            }
            function hideModal() { modalOverlay.classList.remove('visible'); }

            // --- HELPER FUNCTIONS ---
            function excelSerialToDate(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                try {
                    const decoded = XLSX.SSF.parse_date_code(serial);
                    if (decoded) return new Date(decoded.y, decoded.m - 1, decoded.d, decoded.H, decoded.M, decoded.S);
                } catch(e) { console.error(e); }
                return null;
            }
            function formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }
             function findHeader(headers, keyText) { return headers.find(h => h.toLowerCase() === keyText.toLowerCase()); }
            
            // --- LOCALSTORAGE & SHARING ---
            function saveOrdersToLocalStorage() {
                const dataToSave = JSON.stringify(Array.from(loadedOrders.entries()));
                localStorage.setItem('productionControlCenterData', dataToSave);
            }
            function loadOrdersFromLocalStorage() {
                const savedData = localStorage.getItem('productionControlCenterData');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        loadedOrders = new Map(parsedData);
                        if (loadedOrders.size > 0) {
                            updateOrderList();
                            render();
                        }
                    } catch(e) { console.error("LS Load Error", e); localStorage.removeItem('productionControlCenterData');}
                }
            }
            
            function generateShareFile() {
                if (loadedOrders.size === 0) {
                    showModal('Información', 'No hay órdenes cargadas para generar un archivo de sesión.', 'info');
                    return;
                }
                const dataString = JSON.stringify(Array.from(loadedOrders.entries()));
                const blob = new Blob([dataString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const now = new Date();
                const dateStamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
                a.href = url;
                a.download = `Sesion_Centro_de_Control_${dateStamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showModal('Éxito', 'Se ha guardado el archivo de sesión. Puedes enviarlo a un compañero para que lo cargue aquí.', 'success');
            }

            function loadFromSessionFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const dataString = e.target.result;
                        const parsedData = JSON.parse(dataString);
                        loadedOrders = new Map(parsedData);
                        saveOrdersToLocalStorage();
                        updateOrderList();
                        render();
                        showModal('Éxito', `${loadedOrders.size} órdenes cargadas correctamente desde el archivo de sesión.`, 'success');
                    } catch (e) {
                        console.error("Failed to load data from session file", e);
                        showModal('Error', 'El archivo de sesión parece estar corrupto o es inválido.', 'error');
                    }
                };
                reader.readAsText(file);
            }

            // --- FILE HANDLING & DATA PROCESSING ---
            function handleFiles(files, isUpdate = false) {
                const fileList = Array.from(files);
                const sessionFile = fileList.find(f => f.name.endsWith('.json'));

                if(sessionFile) {
                    loadFromSessionFile(sessionFile);
                    return;
                }

                const excelFiles = fileList.filter(f => f.name.endsWith('.xlsx') || f.name.endsWith('.xls'));
                const filePromises = excelFiles.map(file => processFile(file, isUpdate));

                Promise.all(filePromises)
                    .then(results => {
                        let lastKey = activeOrderKey;
                        results.forEach(result => {
                            if (result) {
                                loadedOrders.set(result.key, result.data);
                                lastKey = result.key;
                            }
                        });
                        saveOrdersToLocalStorage();
                        updateOrderList();
                        setActiveOrder(isUpdate ? orderToUpdateKey : lastKey);
                    })
                    .catch(err => {
                        showModal('Error al Cargar', 'Uno o más archivos no pudieron ser procesados.', 'error');
                        console.error(err);
                    });
            }

            function processFile(file, isUpdate) {
                 return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const orderNumber = worksheet['B3']?.v || `Archivo_${file.name.slice(0,10)}`;
                            
                            const keyToUse = isUpdate ? orderToUpdateKey : orderNumber;
                            
                            const rastreoRawData = extractTableData(worksheet, TRACKING_COLS, 20);
                            const packingRawData = extractTableData(worksheet, Object.values(PACKING_COLS), 20, true);

                            const orderData = {
                                orderQty: parseInt(worksheet['O3']?.v || 0),
                                packedQty: parseInt(worksheet['U3']?.v || 0),
                                catalogNumber: worksheet['I3']?.v || 'N/A', // Corrected cell
                                rastreoData: processRastreoData(rastreoRawData),
                                empaqueData: groupEmpaqueData(packingRawData),
                                headers: {
                                    rastreo: Object.keys(rastreoRawData[0] || {}),
                                    empaque: Object.keys(packingRawData[0] || {})
                                }
                            };
                            resolve({ key: keyToUse, data: orderData });
                        } catch(err) { reject(err); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }


            function extractTableData(worksheet, targetCols, startRow, isPacking = false) {
                 const headers = {};
                 const colsToUse = isPacking ? Object.keys(PACKING_COLS) : targetCols;
                 colsToUse.forEach(key => {
                     const col = isPacking ? PACKING_COLS[key] : key;
                     const cell = worksheet[col + startRow];
                     if(cell && cell.v) headers[col] = cell.v.toString().trim();
                 });

                 if (Object.keys(headers).length === 0) return [];
                 const jsonData = [];
                 const range = XLSX.utils.decode_range(worksheet['!ref']);
                 for (let rowNum = startRow; rowNum <= range.e.r; ++rowNum) {
                     const row = {};
                     let hasData = false;
                     colsToUse.forEach(key => {
                         const col = isPacking ? PACKING_COLS[key] : key;
                         const headerName = headers[col];
                         if (headerName) {
                            const cellAddress = col + (rowNum + 1);
                            const cell = worksheet[cellAddress];
                            if(cell && cell.v !== undefined) {
                                row[headerName] = cell.v;
                                hasData = true;
                            } else {
                                row[headerName] = ''; // Ensure key exists
                            }
                         }
                     });
                     if (hasData) jsonData.push(row);
                 }
                 return jsonData;
            }
            
            function processRastreoData(data) {
                if (data.length === 0) return [];
                const today = new Date();
                const headers = Object.keys(data[0]);
                const scrapHeader = findHeader(headers, TRACKING_KEYS.IS_SCRAP);
                const dateHeader = findHeader(headers, TRACKING_KEYS.DATE_REGISTERED);
                
                return data.map(row => {
                    let status = 'normal';
                    const isScrap = String(row[scrapHeader]).trim().toUpperCase() === 'X';
                     if (isScrap) {
                        status = 'scrap';
                    } else {
                        const registeredDate = excelSerialToDate(row[dateHeader]);
                        if (registeredDate instanceof Date) {
                            if (registeredDate.toDateString() === today.toDateString()) status = 'today';
                            else if (registeredDate < today) status = 'delayed';
                        }
                    }
                    return { ...row, status };
                });
            }

            function groupEmpaqueData(data) {
                if (!data || data.length === 0) return new Map();
                const headers = Object.keys(data[0]);
                const boxIdHeader = findHeader(headers, PACKING_KEYS.BOX_ID);
                
                return data.reduce((acc, row) => {
                    const boxId = row[boxIdHeader];
                    if (boxId) {
                        if (!acc.has(boxId)) acc.set(boxId, []);
                        acc.get(boxId).push(row);
                    }
                    return acc;
                }, new Map());
            }
            
            function handleExport() {
                const headers = (activeOrderKey === 'all' ? loadedOrders.values().next().value?.headers.rastreo : loadedOrders.get(activeOrderKey)?.headers.rastreo) || [];
                const serialHeader = findHeader(headers, TRACKING_KEYS.SERIAL);
                const stationHeader = findHeader(headers, TRACKING_KEYS.STATION);
                const dateRegisteredHeader = findHeader(headers, TRACKING_KEYS.DATE_REGISTERED);
                
                if (!serialHeader || !stationHeader || !dateRegisteredHeader) {
                    showModal('Error de Exportación', `No se pudo identificar una columna clave ("${TRACKING_KEYS.SERIAL}", "${TRACKING_KEYS.STATION}", o "${TRACKING_KEYS.DATE_REGISTERED}"). Verifique el archivo.`, 'error');
                    return;
                }
                
                if (currentVisibleData.length === 0) {
                     showModal('Información', 'No hay datos visibles en la tabla para exportar.', 'info');
                    return;
                }

                const orderNumber = statOrderNumber.textContent;
                const finalData = currentVisibleData.map(row => {
                    const serial = String(row[serialHeader] || '');
                    const cleanedSerial = serial.replace(/S#/i, '');
                    return {
                        'Numero_de_Orden': orderNumber,
                        'Serial_Para_Reimpresion': cleanedSerial,
                        'Estacion': row[stationHeader],
                        'Fecha_y_Hora_Ultimo_Movimiento': formatDate(excelSerialToDate(row[dateRegisteredHeader]))
                    };
                });

                const worksheet = XLSX.utils.json_to_sheet([]);
                const lineFilterText = rastreoLineFilter === 'all' ? 'Todas las Líneas' : `Línea: ${rastreoLineFilter}`;
                const headerText = `Reporte de Exportación para ${lineFilterText}`;

                XLSX.utils.sheet_add_aoa(worksheet, [[headerText]], { origin: "A1"});
                XLSX.utils.sheet_add_json(worksheet, finalData, { origin: "A2", skipHeader: false });
                
                const merge = { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } };
                if (!worksheet['!merges']) worksheet['!merges'] = [];
                worksheet['!merges'].push(merge);

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Exportación");
                
                const linePart = rastreoLineFilter === 'all' ? 'Todas_Lineas' : `Linea_${rastreoLineFilter}`;
                const fileName = `Exportacion_Orden_${orderNumber}_${linePart}.xlsx`;
                XLSX.writeFile(workbook, fileName);

                showModal('Exportación Exitosa', `Se ha generado el archivo "${fileName}" con ${finalData.length} seriales.`, 'success');
            }
            
             function handleStatusReport() {
                if (loadedOrders.size === 0) {
                    showModal('Información', 'No hay órdenes cargadas para generar un reporte.', 'info');
                    return;
                }

                const now = new Date();
                const reportDate = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                const totalOrders = loadedOrders.size;
                const completedOrders = Array.from(loadedOrders.values()).filter(order => order.orderQty > 0 && order.orderQty <= order.packedQty).length;

                let tableRows = '';
                for (const [key, order] of loadedOrders.entries()) {
                    const delayedCount = order.rastreoData.filter(row => row.status === 'delayed').length;
                    const todayCount = order.rastreoData.filter(row => row.status === 'today').length;
                    
                    let status, statusEmoji;
                    if (order.orderQty > 0 && order.orderQty <= order.packedQty) {
                        status = 'Terminada';
                        statusEmoji = '🟢';
                    } else if (delayedCount > 0) {
                        status = 'Con Retrasos';
                        statusEmoji = '🟡';
                    } else {
                        status = 'En Proceso';
                        statusEmoji = '🔵';
                    }
                    
                    const progress = order.orderQty > 0 ? ((order.packedQty / order.orderQty) * 100).toFixed(1) : 0;
                    
                    tableRows += `
                        <tr style="border-bottom: 1px solid #334155;">
                            <td style="padding: 8px; font-weight: bold;">${key}</td>
                            <td style="padding: 8px;">${statusEmoji} ${status}</td>
                            <td style="padding: 8px;">${order.packedQty} / ${order.orderQty} (${progress}%)</td>
                            <td style="padding: 8px; text-align: center;">${todayCount}</td>
                            <td style="padding: 8px; text-align: center;">${delayedCount}</td>
                        </tr>
                    `;
                }

                const reportHTML = `
                    <div id="report-content" style="font-family: Inter, sans-serif; color: #F8FAFC;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">Reporte de Estatus de Jornada - ${reportDate}</h3>
                        <p style="margin: 0 0 16px 0; font-size: 0.9rem;">
                            <strong>Órdenes Totales:</strong> ${totalOrders} | 
                            <strong>Órdenes Terminadas:</strong> ${completedOrders}
                        </p>
                        <hr style="border: none; border-top: 1px solid #334155; margin-bottom: 16px;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem;">
                            <thead style="color: #94A3B8;">
                                <tr>
                                    <th style="padding: 8px;">Orden</th>
                                    <th style="padding: 8px;">Estatus</th>
                                    <th style="padding: 8px;">Progreso</th>
                                    <th style="padding: 8px; text-align: center;">En Mov. (Hoy)</th>
                                    <th style="padding: 8px; text-align: center;">Sin Mov. (Retraso)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;

                showModal('Reporte de Estatus de Jornada', reportHTML, 'info', true);
                
                copyReportBtn.onclick = () => {
                    try {
                        const content = document.getElementById('report-content');
                        const listener = (e) => {
                            e.clipboardData.setData('text/html', content.innerHTML);
                            e.clipboardData.setData('text/plain', content.innerText);
                            e.preventDefault();
                        };
                        document.addEventListener('copy', listener);
                        document.execCommand('copy');
                        document.removeEventListener('copy', listener);
                        showModal('¡Éxito!', 'Reporte copiado. Ya puedes pegarlo en tu correo.', 'success');
                    } catch(e) {
                         showModal('Error', 'No se pudo copiar el reporte.', 'error');
                         console.error("Copy failed:", e);
                    }
                };
            }


            // --- UI & RENDERING ---
            function switchMode(mode) {
                currentMode = mode;
                modeRastreo.classList.toggle('active', mode === 'rastreo');
                modeEmpaque.classList.toggle('active', mode === 'empaque');
                rastreoView.style.display = mode === 'rastreo' ? 'flex' : 'none';
                empaqueView.style.display = mode === 'empaque' ? 'block' : 'none';
                render();
            }

            function updateOrderList() {
                orderList.innerHTML = '';
                const allBtn = createOrderButton('all', 'Vista General');
                orderList.appendChild(allBtn);

                for (const key of loadedOrders.keys()) {
                    const orderItem = createOrderButton(key, key);
                    orderList.appendChild(orderItem);
                }
                setActiveOrder(activeOrderKey);
                updateGlobalDashboard();
            }
            
            function createOrderButton(key, text) {
                const item = document.createElement('div');
                item.className = 'order-item';
                
                const btn = document.createElement('button');
                btn.className = 'order-btn';
                btn.textContent = text;
                btn.dataset.key = key;
                btn.onclick = () => setActiveOrder(key);
                
                if (key !== 'all') {
                    const orderData = loadedOrders.get(key);
                    if (orderData.orderQty > 0 && orderData.orderQty <= orderData.packedQty) {
                        btn.classList.add('is-complete');
                    }
                }
                item.appendChild(btn);

                if (key !== 'all') {
                    const updateBtn = document.createElement('button');
                    updateBtn.className = 'icon-btn';
                    updateBtn.title = 'Actualizar orden';
                    updateBtn.innerHTML = `✏️`;
                    updateBtn.onclick = () => {
                        orderToUpdateKey = key;
                        updateFileInput.value = '';
                        updateFileInput.click();
                    };
                    item.appendChild(updateBtn);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-btn';
                    deleteBtn.title = 'Eliminar orden';
                    deleteBtn.innerHTML = `🗑️`;
                    deleteBtn.onclick = () => {
                        loadedOrders.delete(key);
                        if (activeOrderKey === key) activeOrderKey = 'all';
                        saveOrdersToLocalStorage();
                        updateOrderList();
                        render();
                    };
                    item.appendChild(deleteBtn);
                }

                return item;
            }

            function setActiveOrder(key) {
                activeOrderKey = key;
                orderList.querySelectorAll('.order-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.key === key);
                });
                render();
            }

            function render() {
                if (loadedOrders.size === 0) {
                    placeholderText.style.display = 'block';
                    document.getElementById('rastreoTable').innerHTML = '';
                    document.getElementById('empaqueTable').innerHTML = '';
                    exportViewButton.disabled = true;
                    exportStatusButton.disabled = true;
                    shareSessionButton.disabled = true;
                    rastreoLineFiltersPlaceholder.textContent = 'Cargue un archivo para ver los filtros.';
                    rastreoLineFiltersPlaceholder.style.display = 'block';
                    rastreoLineFilters.innerHTML = '';
                    lineCountsContainer.innerHTML = '';
                    renderSummary();
                    updateGlobalDashboard();
                    return;
                }
                placeholderText.style.display = 'none';
                renderSummary();
                if (currentMode === 'rastreo') {
                    renderRastreoView(activeOrderKey);
                } else {
                    renderEmpaqueView(activeOrderKey);
                }
                 updateGlobalDashboard();
            }

            function renderSummary() {
                let orderQty = 0, packedQty = 0, scrapCount = 0, catalogNumber = 'N/A';
                let ordersToProcess = [];

                if (activeOrderKey === 'all') {
                    ordersToProcess = Array.from(loadedOrders.values());
                    statOrderNumber.textContent = 'Múltiples';
                    statCatalogNumber.textContent = '...';
                } else if (loadedOrders.has(activeOrderKey)) {
                    ordersToProcess = [loadedOrders.get(activeOrderKey)];
                    statOrderNumber.textContent = activeOrderKey;
                    statCatalogNumber.textContent = ordersToProcess[0].catalogNumber;
                } else {
                    activeOrderKey = 'all';
                    ordersToProcess = Array.from(loadedOrders.values());
                    statOrderNumber.textContent = 'Múltiples';
                    statCatalogNumber.textContent = '...';
                    setActiveOrder('all');
                }

                ordersToProcess.forEach(order => {
                    orderQty += order.orderQty;
                    packedQty += order.packedQty;
                    const scrapHeader = findHeader(order.headers.rastreo, TRACKING_KEYS.IS_SCRAP);
                    if(scrapHeader) {
                        scrapCount += order.rastreoData.filter(row => String(row[scrapHeader]).trim().toUpperCase() === 'X').length;
                    }
                });

                statOrderQty.textContent = orderQty;
                statPackedQty.textContent = packedQty;
                statRemainingQty.textContent = orderQty - packedQty;
                statScrapQty.textContent = scrapCount;
            }

             function updateGlobalDashboard() {
                const totalOrders = loadedOrders.size;
                const completedOrders = Array.from(loadedOrders.values()).filter(order => order.orderQty > 0 && order.orderQty <= order.packedQty).length;
                totalOrdersStat.textContent = totalOrders;
                completedOrdersStat.textContent = completedOrders;
            }
            
            function renderRastreoView(key) {
                let dataToShow = [];
                let headers = [];
                if (key === 'all') {
                    loadedOrders.forEach(order => dataToShow.push(...order.rastreoData));
                    if (loadedOrders.size > 0) headers = loadedOrders.values().next().value.headers.rastreo;
                } else if (loadedOrders.has(key)) {
                    const order = loadedOrders.get(key);
                    dataToShow = order.rastreoData;
                    headers = order.headers.rastreo;
                }
                
                createRastreoLineFilters(dataToShow, headers);

                let filteredData = dataToShow;
                if (rastreoStatusFilter !== 'all') {
                    filteredData = filteredData.filter(row => row.status === rastreoStatusFilter);
                }
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (rastreoLineFilter !== 'all' && lineHeader) {
                    filteredData = filteredData.filter(row => row[lineHeader] === rastreoLineFilter);
                }
                const searchText = rastreoFilterInput.value.toLowerCase();
                if (searchText) {
                    filteredData = filteredData.filter(row =>
                        Object.entries(row).some(([k, val]) => k !== 'status' && String(val).toLowerCase().includes(searchText))
                    );
                }

                currentVisibleData = filteredData;
                exportViewButton.disabled = dataToShow.length === 0;
                exportStatusButton.disabled = loadedOrders.size === 0;
                shareSessionButton.disabled = loadedOrders.size === 0;


                updateRastreoTable(filteredData, headers);
                updateLineCounts(filteredData, headers);
            }

             function createRastreoLineFilters(data, headers) {
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (!lineHeader) {
                    rastreoLineFiltersPlaceholder.textContent = "No se encontró la columna 'Line'.";
                    rastreoLineFiltersPlaceholder.style.display = 'block';
                    rastreoLineFilters.innerHTML = '';
                    return;
                }

                const uniqueLines = [...new Set(data.map(row => row[lineHeader]).filter(Boolean))].sort();
                rastreoLineFilters.innerHTML = '';
                rastreoLineFiltersPlaceholder.style.display = 'none';

                const allBtn = document.createElement('button');
                allBtn.className = 'filter-btn';
                allBtn.textContent = 'Todas';
                allBtn.dataset.filter = 'all';
                rastreoLineFilters.appendChild(allBtn);

                uniqueLines.forEach(line => {
                    const lineBtn = document.createElement('button');
                    lineBtn.className = 'filter-btn';
                    lineBtn.textContent = line;
                    lineBtn.dataset.filter = line;
                    rastreoLineFilters.appendChild(lineBtn);
                });
                
                const activeBtn = rastreoLineFilters.querySelector(`[data-filter="${rastreoLineFilter}"]`) || rastreoLineFilters.querySelector('[data-filter="all"]');
                if(activeBtn) activeBtn.classList.add('active');
            }
            
            function updateRastreoTable(data, headers) {
                const table = document.getElementById('rastreoTable');
                if (!table) return;
                
                const isMobile = window.innerWidth <= 992;

                // Definir las columnas a mostrar en cada vista
                let headersToRender;
                if (isMobile) {
                    headersToRender = [
                        findHeader(headers, TRACKING_KEYS.SERIAL),
                        findHeader(headers, TRACKING_KEYS.LINE),
                        findHeader(headers, TRACKING_KEYS.STATION),
                        findHeader(headers, TRACKING_KEYS.DATE_REGISTERED)
                    ].filter(Boolean); // Filtrar por si alguna columna no existe
                } else {
                    const headersToHide = [TRACKING_KEYS.CREATED_BY, TRACKING_KEYS.NOT_PACKED, TRACKING_KEYS.IS_SCRAP].map(h => findHeader(headers, h)).filter(Boolean);
                    headersToRender = headers.filter(h => !headersToHide.includes(h) && h !== 'status');
                }


                if (data.length === 0) {
                    table.innerHTML = `<thead><tr><th>No se encontraron resultados para los filtros aplicados.</th></tr></thead>`;
                    return;
                }
                
                table.innerHTML = `
                    <thead><tr>${headersToRender.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>
                        ${data.map(row => `
                            <tr class="is-${row.status}">
                                ${headersToRender.map(h => `<td>${formatCell(row[h], h)}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>`;
            }

            function updateLineCounts(data, headers) {
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (!lineHeader) {
                    lineCountsContainer.innerHTML = ''; return;
                }
                const counts = data.reduce((acc, row) => {
                    const line = row[lineHeader];
                    if (line) acc[line] = (acc[line] || 0) + 1;
                    return acc;
                }, {});
                
                lineCountsContainer.innerHTML = Object.entries(counts).sort().map(([line, count]) =>
                    `<div class="line-badge">${line}: <span>${count}</span></div>`
                ).join('');
            }
            
            function renderEmpaqueView(key) {
                let dataToShow = new Map();
                let headers = [];

                if (key === 'all') {
                    loadedOrders.forEach(order => {
                        order.empaqueData.forEach((serials, boxId) => {
                            if (!dataToShow.has(boxId)) dataToShow.set(boxId, []);
                            dataToShow.get(boxId).push(...serials);
                        });
                    });
                    if (loadedOrders.size > 0) headers = loadedOrders.values().next().value.headers.empaque;
                } else if (loadedOrders.has(key)) {
                    const order = loadedOrders.get(key);
                    dataToShow = order.empaqueData;
                    headers = order.headers.empaque;
                }
                
                const table = document.getElementById('empaqueTable');
                if (dataToShow.size === 0 || headers.length === 0) {
                     table.innerHTML = `<thead><tr><th>No hay datos de empaque para mostrar.</th></tr></thead>`;
                    return;
                }
                
                const boxIdHeader = findHeader(headers, PACKING_KEYS.BOX_ID);
                const serialHeader = findHeader(headers, PACKING_KEYS.SERIAL);
                const packedDateHeader = findHeader(headers, PACKING_KEYS.PACKED_DATE);
                const employeeIdHeader = findHeader(headers, PACKING_KEYS.EMPLOYEE_ID);

                const filterText = empaqueFilterInput.value.toLowerCase();
                let tableHTML = `
                    <thead>
                        <tr>
                            <th>${boxIdHeader}</th>
                            <th>Cantidad</th>
                            <th>Último Empaque</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                for (const [boxId, serials] of dataToShow.entries()) {
                    const latestDate = Math.max(...serials.map(s => s[packedDateHeader]));
                    const serialsMatchFilter = serials.some(s => String(s[serialHeader]).toLowerCase().includes(filterText));
                    if (!String(boxId).toLowerCase().includes(filterText) && !serialsMatchFilter) continue;

                    tableHTML += `
                        <tr class="box-row" data-boxid="${boxId}">
                            <td>${boxId}</td>
                            <td>${serials.length}</td>
                            <td>${formatDate(excelSerialToDate(latestDate))}</td>
                        </tr>`;

                    serials.forEach(serial => {
                         tableHTML += `
                            <tr class="serial-row" data-parentbox="${boxId}">
                                <td colspan="3">
                                    <strong>Serial:</strong> ${serial[serialHeader]} | 
                                    <strong>Empacador:</strong> ${serial[employeeIdHeader] || 'N/A'} | 
                                    <strong>Fecha:</strong> ${formatDate(excelSerialToDate(serial[packedDateHeader]))}
                                </td>
                            </tr>`;
                    });
                }
                tableHTML += `</tbody>`;
                table.innerHTML = tableHTML;

                table.querySelectorAll('.box-row').forEach(row => {
                    row.addEventListener('click', () => {
                        row.classList.toggle('expanded');
                        const boxId = row.dataset.boxid;
                        table.querySelectorAll(`.serial-row[data-parentbox="${boxId}"]`).forEach(serialRow => {
                            serialRow.style.display = row.classList.contains('expanded') ? 'table-row' : 'none';
                        });
                    });
                });
            }

            function formatCell(value, header) {
                 if (header.toLowerCase().includes('date')) return formatDate(excelSerialToDate(value));
                 return value === undefined ? '' : value;
            }

            // --- NUEVO: Lógica de adaptación a móvil ---
            let isMobile = window.innerWidth <= 992;
            const collapsibleCards = [
                { id: 'uploadCard', title: 'Panel de Control' }, 
                { id: 'orderListCard', title: 'Órdenes Cargadas' },
                { id: 'filtersCard', title: 'Filtros y Acciones' }
            ];

            function setupMobileMode() {
                collapsibleCards.forEach(cardInfo => {
                    const cardElement = document.getElementById(cardInfo.id);
                    if (!cardElement) return;

                    cardElement.classList.add('mobile-collapsible');
                    const trigger = cardElement.querySelector('h3');
                    if (trigger) {
                        trigger.classList.add('mobile-trigger');
                        // Cambiar el título del primer h3 de la tarjeta de filtros
                        if (cardInfo.id === 'filtersCard') {
                            const firstH3 = cardElement.querySelector('.filter-container h3');
                            if(firstH3) firstH3.textContent = cardInfo.title;
                        }
                        // Agregar el evento de clic solo una vez
                        if (!trigger.dataset.mobileListener) {
                            trigger.addEventListener('click', () => {
                                if(window.innerWidth <= 992) { // Solo activar en móvil
                                    cardElement.classList.toggle('expanded');
                                }
                            });
                            trigger.dataset.mobileListener = 'true';
                        }
                    }
                });
            }

            function teardownMobileMode() {
                 collapsibleCards.forEach(cardInfo => {
                    const cardElement = document.getElementById(cardInfo.id);
                    if (!cardElement) return;

                    cardElement.classList.remove('mobile-collapsible', 'expanded');
                    const trigger = cardElement.querySelector('h3');
                    if(trigger) trigger.classList.remove('mobile-trigger');

                    // Restaurar título original
                    if (cardInfo.id === 'filtersCard') {
                         const firstH3 = cardElement.querySelector('.filter-container h3');
                         if(firstH3) firstH3.textContent = 'Filtrar por Estado';
                    }
                 });
            }
            
            // Listener para cambiar de modo al redimensionar la ventana
            window.addEventListener('resize', () => {
                const newIsMobile = window.innerWidth <= 992;
                if (newIsMobile !== isMobile) {
                    isMobile = newIsMobile;
                    if (isMobile) {
                        setupMobileMode();
                    } else {
                        teardownMobileMode();
                    }
                    render(); // Re-renderizar la tabla con las columnas correctas
                }
            });
            
            // Carga inicial
            loadOrdersFromLocalStorage();
            if (isMobile) {
                setupMobileMode();
            }

        });
    </script>
</body>
</html>