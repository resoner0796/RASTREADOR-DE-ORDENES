<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Rastreo de Ordenes</title>
    <meta name="theme-color" content="#22252a">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Control CCP">
    <link rel="apple-touch-icon" href="icon-192x192.PNG">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    <style>
        html {
            min-height: 100%;
            background-color: #0a0a0a;
        }
        body {
            min-height: 100vh;
        }
        :root { }
        body.dark-theme {
            --bg-gradient: radial-gradient(ellipse at center top, #22252a 0%, #0a0a0a 70%);
            --surface-color: rgba(35, 38, 43, 0.6);
            --surface-hover-color: rgba(55, 58, 63, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #E5E7EB;
            --primary-text-color: #0A0A0A;
            --danger-color: #FB7185;
            --warning-color: #FBBF24;
            --orange-color: #F97316;
            --success-color: #34D399;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --text-dark: #64748B;
            --thead-bg: rgba(55, 65, 81, 0.8);
            --sticky-bg: #0a0a0a;
        }
        body.light-theme {
            --bg-gradient: linear-gradient(145deg, #f9fafb, #e5e7eb);
            --surface-color: rgba(255, 255, 255, 0.5);
            --surface-hover-color: rgba(243, 244, 246, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-color: #1F2937;
            --primary-text-color: #FFFFFF;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --orange-color: #EA580C;
            --success-color: #10B981;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --text-dark: #9CA3AF;
            --thead-bg: rgba(229, 231, 235, 0.8);
            --branding-color: #0055A5;
            --sticky-bg: #e5e7eb;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shine-gradient {
            0% { background-position: 150% 0; }
            100% { background-position: -150% 0; }
        }
        @keyframes shine-gradient-reverse {
            0% { background-position: -150% 0; }
            100% { background-position: 150% 0; }
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            justify-content: center;
            transition: background 0.3s ease-in-out;
            background-attachment: fixed;
        }
        #scroll-mask {
            display: none;
        }
        .animated-startup {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .app-container {
            width: 100%;
            max-width: 1800px;
            padding: 32px 16px;
        }
        .top-header-container {
            padding-left: 336px;
        }
        .app-header { text-align: center; margin-bottom: 16px; position: relative; }
        .app-branding { font-family: 'Tinos', 'Times New Roman', serif; font-weight: 400; font-size: 2.2rem; color: var(--text-primary); letter-spacing: 2px; margin: 0; transition: color 0.3s ease-in-out; }
        body.light-theme .app-branding { color: var(--branding-color); }
        .app-title { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); margin: 4px 0 0 0; }
        .main-container { width: 100%; display: grid; grid-template-columns: 320px 1fr; grid-template-rows: auto auto 1fr; grid-template-areas: "sidebar global-header" "sidebar header" "sidebar main"; gap: 16px; }
        #sapView .main-container { grid-template-columns: 320px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "sidebar global-header" "sidebar main"; }
        .sidebar {
            grid-area: sidebar;
            position: sticky;
            align-self: start;
            top: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: calc(100vh - 32px);
            z-index: 25;
        }
        .sidebar > h2 { display: none; }
        .sidebar .card h3 { text-align: center; }
        #sapView .sidebar > h2 { text-align: center; }
        #orderListCard, #sap-orderListCard { display: flex; flex-direction: column; overflow: hidden; flex-grow: 1; }
        #orderList, #sapOrderList { flex-grow: 1; overflow-y: auto; }
        .global-header { grid-area: global-header; }
        .header { grid-area: header; }
        .main-content { grid-area: main; display: flex; flex-direction: column; gap: 16px; }
        #fwdView .header, #sapView .global-header, #table-controls-header, #sap-controls-header {
            position: -webkit-sticky;
            position: sticky;
            z-index: 20;
        }
        #fwdView .header, #sapView .global-header {
            top: 16px;
        }
        #table-controls-header, #sap-controls-header {
            z-index: 19;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin: -20px -20px 0 -20px;
            padding: 16px 20px 0 20px;
        }
        #desktop-controls-container, #sap-controls-header > div:first-child {
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .card, .modal-content {
            background-color: var(--surface-color);
            background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease-in-out;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(0, 0, 0, 0.3);
            border-right: 2px solid rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        body.light-theme .card, body.light-theme .modal-content {
            border-top: 1px solid rgba(255, 255, 255, 0.8);
            border-left: 1px solid rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            border-right: 2px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        h2, h3 { margin-top: 0; margin-bottom: 12px; color: var(--text-secondary); font-weight: 600; font-size: 1rem; }
        h3 { font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        .file-drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .file-drop-area.disabled { cursor: not-allowed; background-color: rgba(0,0,0,0.2); border-color: #475569; }
        .file-drop-area.disabled p, .file-drop-area.disabled span { color: var(--text-dark); }
        .file-drop-area.dragover { background-color: var(--surface-hover-color); border-color: var(--primary-color); }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area span { color: var(--primary-color); font-weight: 500; }
        .btn, .filter-btn, .order-item .order-btn {
            padding: 8px 14px; border-radius: 8px; cursor: pointer;
            background-color: var(--surface-color);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            color: var(--text-secondary); font-weight: 500;
            text-align: center; transition: all 0.2s; font-size: 0.9rem;
            box-shadow: inset 0px 1px 1px rgba(255,255,255,0.05);
        }
        #logoutBtn, #adminBtn, #themeToggleBtn {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover, .filter-btn:hover, .order-item .order-btn:hover { background-color: var(--surface-hover-color); color: var(--text-primary); border-color: rgba(255, 255, 255, 0.2); }
        .filter-btn.active { color: var(--primary-text-color); font-weight: 700; background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn { width: 100%; padding: 10px; background-color: var(--primary-color); color: var(--primary-text-color); font-weight: 700;}
        #uploadCard #areaSelectBtn {
            background-color: var(--surface-color);
            color: var(--text-secondary);
            font-weight: 500;
        }
        #uploadCard #areaSelectBtn:hover {
            background-color: var(--surface-hover-color);
            color: var(--text-primary);
        }
        .btn.btn-danger { background-color: var(--danger-color); color: var(--text-primary); }
        .btn.btn-danger:hover { background-color: #f8516d; }
        .btn:disabled { background-color: var(--surface-color); opacity: 0.5; color: var(--text-dark); cursor: not-allowed; border-color: var(--border-color);}
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .light-theme .btn:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .order-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .order-item .order-btn {
            flex-grow: 1;
            min-width: 0;
            text-align: center;
            padding: 10px 8px 14px 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        .order-progress-bar {
            position: absolute;
            bottom: 4px;
            left: 8px;
            right: 8px;
            height: 4px;
            background-color: var(--surface-hover-color);
            border-radius: 2px;
            overflow: hidden;
        }
        .order-progress-bar-inner {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .order-item .order-btn.active { background-color: var(--primary-color); color: var(--primary-text-color); }
        .order-item .order-btn.is-complete {
            background-color: rgba(52, 211, 153, 0.1); color: var(--success-color); border-color: var(--success-color); position: relative; overflow: hidden;
        }
        .order-item .order-btn.is-complete::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0) 80%);
            background-size: 200% 100%;
            background-position: 150% 0;
            animation: shine-gradient 3s linear 6;
        }
        .order-item .order-btn.is-complete:hover { background-color: rgba(52, 211, 153, 0.2); }
        .order-item .order-btn.is-complete.active { box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.4); }
        .order-item .icon-btn {
            flex-shrink: 0; background: transparent; border: none; backdrop-filter: none; box-shadow: none; color: var(--text-dark); cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 1.2rem; filter: grayscale(1) opacity(0.6);
        }
        .order-item .icon-btn:hover { color: var(--text-primary); filter: grayscale(0) opacity(1); }
        .mode-switcher { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 4px; background-color: rgba(0,0,0,0.1); border-radius: 10px; }
        .light-theme .mode-switcher { background-color: rgba(0,0,0,0.05); }
        #mainModeSwitcher { grid-template-columns: 1fr 1fr; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto; }
        .mode-switcher button { padding: 8px; border: none; background-color: transparent; color: var(--text-secondary); font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .mode-switcher button.active { background-color: var(--surface-color); color: var(--text-primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
        body.light-theme .mode-switcher button.active { color: var(--primary-text-color); background-color: var(--branding-color); border-color: var(--branding-color); }
        .header > .mode-switcher { margin-bottom: 20px; }
        .global-header.card {
            min-height: 120px;
            display: flex;
            align-items: center;
        }
        .header.card {
            min-height: 180px;
        }
        .summary-card { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; text-align: center; }
        .global-dashboard-card {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            text-align: center;
        }
        .stat-item { display: flex; flex-direction: column; justify-content: flex-start; }
        .stat-item h3 { margin-bottom: 8px; font-size: 0.9rem; font-weight: 500; }
        .stat-item .stat-value-wrapper { margin-top: auto; }
        .stat-item p { margin: 0; font-size: 1.75rem; font-weight: 700; }
        .global-dashboard-card .stat-item {
            justify-content: center;
        }
        .global-dashboard-card .stat-item p {
            font-size: 2.5rem;
        }
        #statOrderNumber { color: var(--text-secondary); cursor: pointer; transition: color 0.2s ease-in-out; }
        #statOrderNumber:hover { color: var(--primary-color); }
        #statCatalogNumber { font-size: 1rem; color: var(--text-primary); font-weight: 500; margin-top: 4px; height: auto; }
        #statPackedQty, #sapCompletedOrdersStat, #completedOrdersStat { color: var(--success-color); }
        #statRemainingQty, #sapTotalOrdersStat, #totalOrdersStat { color: var(--warning-color); }
        #statScrapQty { color: var(--danger-color); }
        .daily-plan-container {
            grid-column: 1 / -1;
            margin-top: 16px;
            display: flex;
            justify-content: center;
        }
        #showDailyPlanBtn {
            width: auto;
            padding-left: 24px;
            padding-right: 24px;
        }
        body.light-theme #statOrderNumber,
        body.light-theme #uploadCard h3,
        body.light-theme #orderListCard h3,
        body.light-theme #sap-uploadCard h3,
        body.light-theme #sap-orderListCard h3,
        body.light-theme #sap-tableCard h3,
        body.light-theme .modal-title,
        body.light-theme .mode-switcher button {
            color: var(--branding-color);
        }
        .table-wrapper {
            overflow: auto;
            transition: opacity 0.3s ease-in-out;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        #tableCard, #sap-tableCard {
            display: flex;
            flex-direction: column;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem;}
        thead { position: sticky; top: 0; background-color: var(--thead-bg); backdrop-filter: blur(5px); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; }
        #lineCountsContainer { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .line-badge { background-color: var(--surface-hover-color); padding: 4px 12px; border-radius: 16px; font-size: 0.8rem; font-weight: 500; color: var(--text-dark); }
        .line-badge span { font-weight: 700; color: var(--text-secondary); }
        .box-row { cursor: pointer; }
        .box-row:hover { background-color: var(--surface-hover-color); }
        .serial-cell { cursor: pointer; transition: color 0.2s ease; }
        .serial-cell:hover { color: var(--primary-color); }
        tbody {
            transform: translateZ(0);
        }
        tbody tr.is-scrap { background-color: rgba(251, 113, 133, 0.1) !important; }
        tbody tr.is-scrap td { color: var(--danger-color) !important; }
        tbody tr.is-very_delayed {
            background-color: rgba(249, 115, 22, 0.1) !important;
            position: relative;
            overflow: hidden;
        }
        tbody tr.is-very_delayed::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(249, 115, 22, 0.15) 50%, rgba(255,255,255,0) 80%);
            background-size: 200% 100%;
            background-position: 150% 0;
            animation: shine-gradient-reverse 3s linear infinite;
            pointer-events: none;
        }
        tbody tr.is-very_delayed td { color: var(--orange-color) !important; }
        tbody tr.is-delayed { background-color: rgba(251, 191, 36, 0.1) !important; }
        tbody tr.is-delayed td { color: var(--warning-color) !important; }
        tbody tr.is-today, tbody tr.is-complete-sap {
            background-color: rgba(52, 211, 153, 0.1) !important;
            position: relative;
            overflow: hidden;
        }
        tbody tr.is-today::after, tbody tr.is-complete-sap::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0) 80%);
            background-size: 200% 100%;
            background-position: 150% 0;
            animation: shine-gradient 3s linear 6;
            animation-delay: 1.5s;
        }
        tbody tr.is-today td, tbody tr.is-complete-sap td { color: var(--success-color) !important; }
        body.light-theme .order-item .order-btn.is-complete::after,
        body.light-theme tbody tr.is-today::after,
        body.light-theme tbody tr.is-complete-sap::after {
            background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(16, 185, 129, 0.25) 50%, rgba(255,255,255,0) 80%);
        }
        tbody tr.is-incomplete-sap { background-color: rgba(251, 191, 36, 0.1) !important; }
        tbody tr.is-incomplete-sap td { color: var(--warning-color) !important; }
        tbody tr.is-late-sap { background-color: rgba(251, 113, 133, 0.1) !important; }
        tbody tr.is-late-sap td { color: var(--danger-color) !important; }
        #loader, #placeholderText, #sapPlaceholderText { text-align: center; padding: 60px; color: var(--text-dark); font-size: 1.1rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; text-align: center; width: 100%; }
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
        #modalBody .status-report { font-family: 'Inter', sans-serif; font-size: 0.95rem; white-space: pre-wrap; color: var(--text-primary); }
        #modalBody .status-report h4 { font-size: 1.1rem; color: var(--primary-color); margin: 16px 0 8px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        #modalBody .status-report p { margin: 4px 0; }
        #modalBody .status-report strong { color: var(--text-secondary); }
        #modalBody .status-report ul { list-style-type: none; padding-left: 10px; }
        #modalBody .status-report li { margin-bottom: 4px; }
        #modalBody .status-report .order-progress-bar { position: relative; margin-top: 8px; }
        #modalBody input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-primary); margin-top: 10px; box-sizing: border-box;}
        #modalBody .area-list { list-style: none; padding: 0; margin-top: 16px; max-height: 250px; overflow-y: auto;}
        #modalBody .area-list li { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);}
        #modalBody .user-list li { grid-template-columns: 150px 1fr auto; gap: 16px; }
        #modalBody .user-list .permissions-display { font-size: 0.8rem; color: var(--text-dark); word-break: break-word; }
        #modalBody .permissions-list { list-style: none; padding: 0; margin: 10px 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        #modalBody .permissions-list label { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        #modalBody .permissions-list input { width: auto; margin: 0; }
        #modalBody .area-list li input { flex-grow: 1; margin: 0; }
        #modalBody .config-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #modalBody .config-item label { font-weight: 600; color: var(--text-secondary); }
        #modalBody .config-item input { width: 80px; margin: 0; }
        #modalBody .mapping-item { grid-template-columns: 1fr 1fr auto; }
        #modalBody .mapping-item input { text-transform: uppercase; }
        .admin-section-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
        }
        .admin-section-header:hover { color: var(--text-primary); }
        .admin-section-header::after {
            content: '►';
            font-size: 0.8rem;
            transition: transform 0.2s ease-in-out;
        }
        .admin-section.expanded .admin-section-header::after { transform: rotate(90deg); }
        .admin-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            padding: 0;
        }
        .admin-section.expanded .admin-section-content {
            max-height: 800px;
            padding: 16px 0 0 0;
        }
        .daily-plan-modal { text-align: center; padding: 10px; }
        .plan-header {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        .plan-stat, .plan-date { display: flex; flex-direction: column; align-items: center; }
        .plan-header span { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .plan-header p { margin: 0; font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .plan-stat p { color: var(--warning-color); }
        .plan-date p { font-size: 1.2rem; color: var(--text-primary); }
        .plan-title-separator { font-size: 0.75rem; font-weight: 700; color: var(--text-dark); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 16px; text-align: center; }
        .plan-area-list { list-style: none; padding: 0; margin: 0; }
        .plan-area-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: rgba(255,255,255,0.03);
        }
        .plan-area-item .area-name { font-weight: 600; color: var(--text-primary); }
        .plan-area-item .area-count { font-weight: 700; font-size: 1.2rem; color: var(--success-color); background-color: var(--surface-hover-color); padding: 4px 12px; border-radius: 20px; }
        .plan-area-item-empty { padding: 20px; color: var(--text-dark); text-align: center; }
        .packing-modal-header { text-align: center; margin-bottom: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        .packer-info { font-size: 1.1rem; color: var(--text-secondary); }
        .packer-info strong { color: var(--text-primary); font-weight: 600; }
        #modalBody .packing-details-list { list-style: none; padding: 0; margin: 0; }
        #modalBody .packing-details-list li { display: flex; justify-content: space-between; padding: 10px 8px; border-radius: 6px; transition: background-color 0.2s; }
        #modalBody .packing-details-list li:nth-child(odd) { background-color: rgba(255,255,255,0.03); }
        #modalBody .packing-details-list li span:first-child { font-weight: 600; color: var(--text-primary); }
        #modalBody .packing-details-list li span:last-child { color: var(--text-secondary); }
        #fwdView, #sapView { transition: opacity 0.3s ease-in-out; }
        body.mode-fwd #sapView, body.mode-sap #fwdView { display: none; }
        #empaqueView { display: none; }
        .month-group { margin-bottom: 8px; }
        .month-header {
            width: 100%;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 14px;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            margin-bottom: 8px;
        }
        .month-header:hover { background-color: var(--surface-hover-color); }
        .month-header .collapse-icon { transition: transform 0.2s; }
        .month-group.expanded .month-header .collapse-icon { transform: rotate(90deg); }
        .dates-for-month {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding-left: 16px;
            margin-top: 0;
        }
        .month-group.expanded .dates-for-month { max-height: 10000px; }
        .date-group { margin-bottom: 8px; }
        .date-header { width: 100%; background-color: transparent; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .date-header:hover { background-color: var(--surface-hover-color); }
        .date-header.active { background-color: var(--surface-hover-color); color: var(--text-primary); }
        .date-header .status-indicator { font-weight: 700; font-size: 0.8rem; color: var(--success-color); }
        .date-header .order-count { color: var(--text-dark); font-weight: 500; font-size: 0.8rem; }
        .date-header .collapse-icon { transition: transform 0.2s; }
        .date-group.expanded .date-header .collapse-icon { transform: rotate(90deg); }
        .orders-for-date { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-left: 12px; margin-top: 0; }
        .date-group.expanded .orders-for-date { max-height: 5000px; }
        /* Media Queries */
        @media (max-width: 992px) {
            .app-container { height: auto; padding: 8px; }
            .main-container { display: flex; flex-direction: column; gap: 12px; height: auto; }
            .sidebar { position: static; height: auto; max-height: none; }
            .sidebar, .main-content { display: contents !important; }
            #sap-uploadCard { display: none; }
            .sidebar > h2 { display: none; }
            #areaSelectBtn { flex-grow: 1 !important; }
            .card-row { grid-template-columns: 1fr; }
            #desktop-controls-container { display: none; }
            .global-header { order: 1; }
            .header { order: 2; }
            #uploadCard { order: 3; }
            #orderListCard, #sap-orderListCard { order: 4; }
            #rastreoView, #empaqueView { order: 5; }
            #sap-tableCard { order: 6; }
            .global-dashboard-card { grid-template-columns: 1fr 1fr; }
            .summary-card { grid-template-columns: 1fr 1fr; & > .stat-item:has(.stat-value-wrapper > #statOrderNumber) { grid-column: 1 / -1; } }
            .stat-item p { font-size: 1.5rem; }
            .card.mobile-collapsible .card-content { display: none; padding-top: 16px; }
            .card.mobile-collapsible.expanded .card-content { display: block; }
            .card.mobile-collapsible h3.mobile-trigger { margin-bottom: 0; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
            .card.mobile-collapsible:not(.expanded) h3.mobile-trigger { border-bottom: 1px solid var(--border-color); }
            .card.mobile-collapsible h3.mobile-trigger::after { content: '►'; display: inline-block; font-size: 0.7rem; transition: transform 0.2s; color: var(--text-secondary); }
            .card.mobile-collapsible.expanded h3.mobile-trigger::after { transform: rotate(90deg); }
            .top-header-container { padding-left: 0; }
            #modalBody .user-list li { grid-template-columns: 1fr; gap: 8px; }
            #modalBody .user-list li > div { display: flex; gap: 8px; }
            #fwdView .header, #sapView .global-header, #table-controls-header, #sap-controls-header { position: static; }
            #table-controls-header, #sap-controls-header { margin: 0; padding: 0; }
        }
        
        /* Estilos para la tabla de Empaque */
#empaqueTable {
    table-layout: fixed; /* Forzamos anchos para que no se desmadre */
    width: 100%;
}

#empaqueTable th, 
#empaqueTable td {
    white-space: nowrap; /* Evita que el texto salte de línea */
    overflow: hidden; /* Oculta lo que no quepa */
    text-overflow: ellipsis; /* Pone los "..." si el texto es muy largo */
}

/* Le damos un ancho fijo a las columnas más importantes */
#empaqueTable th:nth-child(1), #empaqueTable td:nth-child(1) { width: 140px; } /* BoxID */
#empaqueTable th:nth-child(5), #empaqueTable td:nth-child(5) { width: 120px; } /* GR */
#empaqueTable th:nth-child(6), #empaqueTable td:nth-child(6) { width: 120px; } /* Orden */
        
        
        /* ... al final de tu bloque de estilos ... */
td.boxid-received {
    color: var(--success-color) !important;
    font-weight: 600;
}

td.boxid-missing {
    color: var(--danger-color) !important;
}
        
        @media (min-width: 993px) {
            #scroll-mask {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 16px;
                background: transparent;
                z-index: 18;
            }
            #mainModeSwitcher { margin-left: auto; margin-right: auto; }
            #mobile-controls-row { display: none; }
            #desktop-controls-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
            .desktop-filters-group { display: flex; align-items: center; flex-wrap: wrap; gap: 16px; flex-grow: 1; }
            .desktop-actions-group { display: flex; flex-shrink: 0; gap: 8px; }
            .filter-group-inline { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
            .filter-label { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
            #desktop-controls-container .btn, #desktop-controls-container .filter-btn { width: auto; padding: 4px 10px; font-size: 0.8rem; margin: 0; }
            #desktop-controls-container .btn { padding: 5px 10px; font-size: 0.75rem; }
        }
    </style>
</head>
<body class="dark-theme">
    <div id="scroll-mask"></div>
    <div class="app-container">
        <div class="top-header-container">
            <header class="app-header animated-startup" style="animation-delay: 0s;">
                <h1 class="app-branding">CORNING</h1>
                <h2 id="app-title" class="app-title">Centro de Rastreo de Órdenes</h2>
            </header>
            <div id="mainModeSwitcher" class="mode-switcher card animated-startup" style="animation-delay: 0.1s;">
                <button id="modeFwd">FWD</button>
                <button id="modeSap">SAP</button>
            </div>
        </div>
        <div id="fwdView">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.2s;">
                    <div class="card" id="uploadCard">
                        <h3>Panel de Control</h3>
                        <div class="card-content">
                            <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                                <button id="areaSelectBtn" class="btn" style="flex: 1; align-self: stretch;">Área: MULTIPORT</button>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <button id="logoutBtn" class="btn" title="Cerrar Sesión" style="padding: 6px 12px; line-height: 1; display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                                    <button id="adminBtn" class="btn" title="Panel de Administrador" style="padding: 6px 12px; line-height: 1; gap: 6px;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg></button>
                                    <button id="themeToggleBtn" class="btn" title="Cambiar Tema" style="padding: 6px 12px; line-height: 1;"></button>
                                </div>
                            </div>
                            <div id="fileDropArea" class="file-drop-area disabled">
                                <p>Autentícate para cargar archivos</p>
                                <p><span>o haz clic en el ícono de ajustes</span></p>
                            </div>
                            <input type="file" id="fileInput" accept=".xlsx, .xls" multiple style="display: none;">
                            <input type="file" id="updateFileInput" accept=".xlsx, .xls" style="display: none;">
                        </div>
                    </div>
                    <div class="card" id="orderListCard">
    <h3>Órdenes Cargadas</h3>
    <div style="padding: 0 10px 10px 10px; border-bottom: 1px solid var(--border-color);">
        <input type="text" id="orderSearchInput" placeholder="Buscar por número de orden..." style="width: 100%; margin: 0; padding: 8px;">
    </div>
    <div id="orderList" class="card-content">
        <p class="text-dark" style="font-size:0.9rem;">Cargando órdenes...</p>
    </div>
</div>
                </aside>
                <header class="global-header card animated-startup" style="animation-delay: 0.3s;">
                    <div class="global-dashboard-card">
                        <div class="stat-item"><h3>Órdenes del Día</h3><p id="totalOrdersStat">0</p></div>
                        <div class="stat-item"><h3>Órdenes Terminadas</h3><p id="completedOrdersStat">0</p></div>
                        <div class="daily-plan-container" id="dailyPlanContainer" style="display: none;">
                            <button id="showDailyPlanBtn" class="btn">Ver Plan del Día</button>
                        </div>
                    </div>
                </header>
                <section class="header card animated-startup" style="animation-delay: 0.4s;">
                    <div class="mode-switcher">
                        <button id="modeRastreo" class="active">Rastreo</button>
                        <button id="modeEmpaque">Empaque</button>
                    </div>
                    <div id="summaryCard" class="summary-card">
                        <div class="stat-item">
                            <h3>Orden</h3>
                            <div class="stat-value-wrapper">
                                <p id="statOrderNumber">N/A</p>
                                <p id="statCatalogNumber"></p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <h3>Cant. Orden</h3>
                            <div class="stat-value-wrapper">
                                <p id="statOrderQty">0</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <h3>Cant. Empacada</h3>
                            <div class="stat-value-wrapper">
                                <p id="statPackedQty">0</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <h3>Restante</h3>
                            <div class="stat-value-wrapper">
                                <p id="statRemainingQty">0</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <h3>Cant. en Scrap</h3>
                            <div class="stat-value-wrapper">
                                <p id="statScrapQty">0</p>
                            </div>
                        </div>
                    </div>
                    <div id="lastUpdatedContainer" style="text-align: right; font-size: 0.75rem; color: var(--text-dark); margin-top: 12px; height: 1em;"></div>
                </section>
                <main class="main-content animated-startup" style="animation-delay: 0.5s;">
                    <div id="rastreoView">
                        <div class="card-row" id="mobile-controls-row">
                            <div class="card mobile-collapsible" id="filtersCard">
                                <h3 class="mobile-trigger">Filtros</h3>
                                <div class="card-content">
                                    <div class="filter-container">
                                        <div>
                                            <h3>Filtrar por Estado</h3>
                                            <div id="rastreoStatusFilters" class="filter-group"></div>
                                        </div>
                                        <div>
                                            <h3>Filtrar por Línea</h3>
                                            <div id="rastreoLineFilters" class="filter-group"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mobile-collapsible" id="actionsCard">
                                <h3 class="mobile-trigger">Acciones</h3>
                                <div class="card-content">
                                    <div class="actions-container"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card" id="tableCard">
                            <div id="table-controls-header">
                                <div id="desktop-controls-container">
                                    <div class="desktop-filters-group">
                                        <div class="filter-group-inline">
                                            <span class="filter-label">Estado:</span>
                                            <div id="rastreoStatusFiltersDesktop" class="filter-group"></div>
                                        </div>
                                        <div class="filter-group-inline">
                                            <span class="filter-label">Línea:</span>
                                            <div id="rastreoLineFiltersDesktop" class="filter-group"></div>
                                        </div>
                                    </div>
                                    <div class="desktop-actions-group">
                                        <div id="desktop-actions-wrapper" class="filter-group"></div>
                                    </div>
                                </div>
                                <input type="text" id="rastreoFilterInput" placeholder="Buscar en la tabla por serial, status, etc..." style="margin-top: 16px; margin-bottom: 16px;">
                                <div id="lineCountsContainer"></div>
                            </div>
                            <div class="table-wrapper">
                                <table id="rastreoTable"></table>
                                <p id="placeholderText">Selecciona una orden de la lista para ver sus detalles.</p>
                            </div>
                        </div>
                    </div>
                    <div id="empaqueView">
                        <div class="card" style="height:100%;">
                            <input type="text" id="empaqueFilterInput" placeholder="Buscar por Serial o BoxID..." style="margin-bottom:16px">
                            <div id="empaqueTableContainer" class="table-wrapper">
                                <table id="empaqueTable"></table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <div id="sapView">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.2s;">
                    <div class="card" id="sap-uploadCard">
                        <h3>Panel de Control</h3>
                        <div id="sapFileDropArea" class="file-drop-area disabled">
                            <p>Autentícate para cargar archivos</p>
                            <p><span>o haz clic en el ícono de ajustes</span></p>
                        </div>
                        <input type="file" id="sapFileInput" accept=".xlsx, .xls" style="display: none;">
                    </div>
                    <div class="card" id="sap-orderListCard">
                        <h3>Órdenes Cargadas</h3>
                        <div id="sapOrderList" class="card-content">
                            <p class="text-dark" style="font-size:0.9rem;">Cargue un archivo para ver las órdenes.</p>
                        </div>
                    </div>
                </aside>
                <header class="global-header card animated-startup" style="animation-delay: 0.3s;">
                    <div class="global-dashboard-card">
                        <div class="stat-item"><h3>Órdenes del Día</h3><p id="sapTotalOrdersStat">0</p></div>
                        <div class="stat-item"><h3>Órdenes Confirmadas</h3><p id="sapCompletedOrdersStat">0</p></div>
                    </div>
                </header>
                <main class="main-content animated-startup" style="animation-delay: 0.4s;">
                    <div class="card" id="sap-tableCard">
                        <div id="sap-controls-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
    <h3>WorkShop</h3>
    <div style="display: flex; gap: 10px;"> <button id="sapResetFilter" class="filter-btn" style="display: none;">Mostrar Hoy/Tarde</button>
        <button id="sapExportImageBtn" class="btn" style="width: auto; padding: 5px 10px;">Exportar Captura</button>
    </div>
                            <div id="sapLastUpdatedContainer" style="text-align: right; font-size: 0.75rem; color: var(--text-dark); padding-bottom: 10px; height: 1em;"></div>
                        </div>
                        <div class="table-wrapper">
                            <table id="sapTable"></table>
                            <p id="sapPlaceholderText">Cargue un archivo para ver los datos de SAP.</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    <div id="modalOverlay" class="modal-overlay">
        <div id="modalContent" class="modal-content">
            <span id="modalClose" class="modal-close">&times;</span>
            <h2 id="modalTitle" class="modal-title"></h2>
            <div id="modalBody" style="margin-top:16px; color: var(--text-secondary); max-height: 70vh; overflow-y: auto;"></div>
            <button id="copyReportBtn" class="btn" style="margin-top: 20px; display:none;">Copiar al Portapapeles</button>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0",
            authDomain: "rastreador-de-ordenes.firebaseapp.com",
            projectId: "rastreador-de-ordenes",
            storageBucket: "rastreador-de-ordenes.appspot.com",
            messagingSenderId: "956052823395",
            appId: "1:956052823395:web:2ba74d9591d2b24c3cc756"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            // State variables
            let workshopConfig = {
                mapping: { 'K46': 'MULTIPORT' },
                column: 'C'
            };
            let loadedOrders = new Map();
            let sapData = [];
            let sapLastUpdated = null;
            let sapLastUpdatedBy = null;
            let sapDateFilter = 'default';
            let activeOrderKey = null;
            let currentMode = 'rastreo';
            let mainMode = 'fwd';
            let currentVisibleData = [];
            let orderToUpdateKey = null;
            let rastreoStatusFilter = 'all';
            let rastreoLineFilter = 'all';
            let session = { user: null, isMaster: false, permissions: [] };
            let currentArea = 'MULTIPORT';
            let fwdListener = null;
            let sapListener = null;
            let initialSyncDoneForArea = {};

            // Key Maps
            const TRACKING_KEYS = { SERIAL: 'Product Serial Number', IS_SCRAP: 'Is Scrap', NOT_PACKED: 'Not Packed', CREATED_BY: 'Created By', DATE_REGISTERED: 'Date Registered', LINE: 'Line', STATION: 'Station' };
            const PACKING_KEYS = { SERIAL: 'Serial Number', EMPLOYEE_ID: 'Employee ID', PACKED_DATE: 'Finish Packed Date', BOX_ID: 'BoxID' };
            
            const REYNOSA_TIMEZONE = 'America/Matamoros';

            // Element cache
            // === ELEMENT CACHE ===
const doc = (id) => document.getElementById(id);
const appTitle = doc('app-title');
const fileDropArea = doc('fileDropArea');
const fileInput = doc('fileInput');
const updateFileInput = doc('updateFileInput');
const orderList = doc('orderList');
const statOrderNumber = doc('statOrderNumber');
const statCatalogNumber = doc('statCatalogNumber');
const statOrderQty = doc('statOrderQty');
const statPackedQty = doc('statPackedQty');
const statRemainingQty = doc('statRemainingQty');
const statScrapQty = doc('statScrapQty');
const totalOrdersStat = doc('totalOrdersStat');
const completedOrdersStat = doc('completedOrdersStat');
const modeRastreo = doc('modeRastreo');
const modeEmpaque = doc('modeEmpaque');
const rastreoFilterInput = doc('rastreoFilterInput');
const areaSelectBtn = doc('areaSelectBtn');
const adminBtn = doc('adminBtn');
const themeToggleBtn = doc('themeToggleBtn');
const logoutBtn = doc('logoutBtn');
const orderSearchInput = doc('orderSearchInput');
const showDailyPlanBtn = doc('showDailyPlanBtn');
const dailyPlanContainer = doc('dailyPlanContainer');
const lastUpdatedContainer = doc('lastUpdatedContainer');

const mobileControls = {
    status: doc('rastreoStatusFilters'),
    line: doc('rastreoLineFilters'),
    actions: doc('actionsCard')?.querySelector('.actions-container')
};
const desktopControls = {
    status: doc('rastreoStatusFiltersDesktop'),
    line: doc('rastreoLineFiltersDesktop'),
    actions: doc('desktop-actions-wrapper')
};

const placeholderText = doc('placeholderText');
const empaqueFilterInput = doc('empaqueFilterInput');
const sapFileDropArea = doc('sapFileDropArea');
const sapFileInput = doc('sapFileInput');
const sapPlaceholderText = doc('sapPlaceholderText');
const sapOrderList = doc('sapOrderList');
const sapTotalOrdersStat = doc('sapTotalOrdersStat');
const sapCompletedOrdersStat = doc('sapCompletedOrdersStat');
const sapResetFilterBtn = doc('sapResetFilter');
const sapLastUpdatedContainer = doc('sapLastUpdatedContainer');
const sapExportImageBtn = doc('sapExportImageBtn'); // <-- ¡AQUÍ ESTÁ LA LÍNEA QUE FALTABA!
const modeFwd = doc('modeFwd');
const modeSap = doc('modeSap');
const modalOverlay = doc('modalOverlay');
const modalTitle = doc('modalTitle');
const modalBody = doc('modalBody');
const modalClose = doc('modalClose');
const copyReportBtn = doc('copyReportBtn');


            // === EVENT LISTENERS ===
            modeFwd.addEventListener('click', () => switchMainMode('fwd'));
            modeSap.addEventListener('click', () => switchMainMode('sap'));
            fileDropArea.addEventListener('click', () => { if(!fileDropArea.classList.contains('disabled')) fileInput.click(); });
            fileDropArea.addEventListener('dragover', (e) => { if(!fileDropArea.classList.contains('disabled')) { e.preventDefault(); fileDropArea.classList.add('dragover'); }});
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => {
                if(!fileDropArea.classList.contains('disabled')) {
                    e.preventDefault(); fileDropArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
                }
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files); });
            updateFileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFiles(e.target.files, true); });
            modeRastreo.addEventListener('click', () => switchMode('rastreo'));
            modeEmpaque.addEventListener('click', () => switchMode('empaque'));
            rastreoFilterInput.addEventListener('input', () => renderRastreoView(activeOrderKey));
            empaqueFilterInput.addEventListener('input', () => renderEmpaqueView(activeOrderKey));
            orderSearchInput.addEventListener('input', updateOrderList); // <-- ¡AGREGA ESTA LÍNEA!

            
            const handleFilterClick = (e) => {
                if (e.target.matches('.filter-btn')) {
                    const group = e.target.closest('.filter-group');
                    const filterType = group.id.includes('Status') ? 'status' : 'line';
                    
                    document.querySelectorAll(`#${group.id}`).forEach(g => {
                        const active = g.querySelector('.active');
                        if(active) active.classList.remove('active');
                        const btnToActivate = g.querySelector(`[data-filter="${e.target.dataset.filter}"]`);
                        if(btnToActivate) btnToActivate.classList.add('active');
                    });

                    if (filterType === 'status') {
                        rastreoStatusFilter = e.target.dataset.filter;
                    } else {
                        rastreoLineFilter = e.target.dataset.filter;
                    }
                    renderRastreoView(activeOrderKey);
                }
            };
            
            mobileControls.status?.addEventListener('click', handleFilterClick);
            desktopControls.status?.addEventListener('click', handleFilterClick);
            mobileControls.line?.addEventListener('click', handleFilterClick);
            desktopControls.line?.addEventListener('click', handleFilterClick);

            sapFileDropArea.addEventListener('click', () => { if (!sapFileDropArea.classList.contains('disabled')) sapFileInput.click(); });
sapFileDropArea.addEventListener('dragover', (e) => { if (!sapFileDropArea.classList.contains('disabled')) { e.preventDefault(); sapFileDropArea.classList.add('dragover'); }});
sapFileDropArea.addEventListener('dragleave', () => sapFileDropArea.classList.remove('dragover'));
sapFileDropArea.addEventListener('drop', (e) => {
    if (!sapFileDropArea.classList.contains('disabled')) {
        e.preventDefault(); sapFileDropArea.classList.remove('dragover');
        // --- CORRECCIÓN ---
        // Volvemos a pasar solo el PRIMER archivo (files[0])
        if (e.dataTransfer.files.length) handleSapFile(e.dataTransfer.files[0]);
    }
});
sapFileInput.addEventListener('change', (e) => { 
    // --- CORRECCIÓN ---
    // Volvemos a pasar solo el PRIMER archivo (files[0])
    if (e.target.files.length) handleSapFile(e.target.files[0]); 
});

sapResetFilterBtn.addEventListener('click', () => {
    sapDateFilter = []; // Vaciamos el array para volver a la vista default
    renderSapView();
});

sapExportImageBtn.addEventListener('click', handleSapImageExport);

modalClose.addEventListener('click', hideModal);
modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });

adminBtn.addEventListener('click', () => {
    if (session.user && session.isMaster) {
        showAdminPanel();
    } else {
        showLogin();
    }
});
            areaSelectBtn.addEventListener('click', showAreaSelector);
            logoutBtn.addEventListener('click', logout);
            showDailyPlanBtn.addEventListener('click', generateDailyPlanReport);

            statOrderNumber.addEventListener('click', () => {
                const orderNumberText = statOrderNumber.textContent;
                if (orderNumberText && orderNumberText !== 'N/A' && orderNumberText !== 'Órdenes del Día') {
                    copyTextToClipboard(orderNumberText,
                        () => { // Success
                            const originalText = statOrderNumber.textContent;
                            statOrderNumber.textContent = '¡Copiado!';
                            setTimeout(() => {
                                statOrderNumber.textContent = originalText;
                            }, 1500);
                        },
                        (err) => { // Error
                            console.error('Error al copiar la orden: ', err);
                            showModal('Error', 'No se pudo copiar el texto.', 'error');
                        }
                    );
                }
            });

async function handleSapImageExport() {
    if (!sapData || sapData.length === 0) {
        showModal('Exportar Captura', 'No hay datos en la tabla de SAP para exportar.', 'warning');
        return;
    }

    const originalButtonText = sapExportImageBtn.textContent;
    sapExportImageBtn.textContent = 'Generando...';
    sapExportImageBtn.disabled = true;

    // Ocultamos botones temporalmente para que no salgan en la captura
    sapResetFilterBtn.style.visibility = 'hidden';
    sapExportImageBtn.style.visibility = 'hidden';

    // El elemento que queremos capturar
    const elementToCapture = doc('sap-tableCard'); 

    try {
        const canvas = await html2canvas(elementToCapture, {
            scale: 2,
            useCORS: true,
            backgroundColor: document.body.classList.contains('dark-theme') ? '#22252a' : '#f9fafb'
        });

        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/jpeg', 0.95);
        const dateStamp = new Date().toLocaleDateString('es-ES').replace(/\//g, '-');
        a.download = `Captura_SAP_${currentArea}_${dateStamp}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

    } catch (e) {
        console.error("Error al generar la imagen de SAP:", e);
        showModal('Error', 'Ocurrió un error al generar el archivo de imagen.', 'error');
    } finally {
        // Volvemos a mostrar los botones y restauramos el estado del botón de exportar
        sapResetFilterBtn.style.visibility = 'visible';
        sapExportImageBtn.style.visibility = 'visible';
        sapExportImageBtn.textContent = originalButtonText;
        sapExportImageBtn.disabled = false;
    }
}

            // ===================================
            // === CORE APP CONTROL & UTILITIES ===
            // ===================================
            function copyTextToClipboard(text, successCallback, errorCallback) {
                // Fallback for older browsers or insecure contexts (like iframes)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; // Avoid scrolling to bottom
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.width = "2em";
                textArea.style.height = "2em";
                textArea.style.padding = "0";
                textArea.style.border = "none";
                textArea.style.outline = "none";
                textArea.style.boxShadow = "none";
                textArea.style.background = "transparent";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        if(successCallback) successCallback();
                    } else {
                        if(errorCallback) errorCallback();
                    }
                } catch (err) {
                    if(errorCallback) errorCallback(err);
                }
                document.body.removeChild(textArea);
            }

            function switchMainMode(mode) {
                if (mainMode === mode) return;
                const oldView = doc(`${mainMode}View`);
                const newView = doc(`${mode}View`);
                oldView.style.opacity = 0;
                setTimeout(() => {
                    oldView.style.display = 'none';
                    document.body.classList.remove('mode-fwd', 'mode-sap');
                    newView.style.display = 'block';
                    document.body.classList.add(`mode-${mode}`);
                    requestAnimationFrame(() => { newView.style.opacity = 1; });
                    mainMode = mode;
                    localStorage.setItem('mainMode', mode);
                    modeFwd.classList.toggle('active', mode === 'fwd');
                    modeSap.classList.toggle('active', mode === 'sap');
                    appTitle.textContent = mode === 'fwd' ? 'Centro de Rastreo de Órdenes' : 'Análisis de Órdenes SAP';
                    render();
                }, 300);
            }
            
            function showModal(title, content, type = 'info', showCopyBtn = false) {
                modalOverlay.querySelector('.modal-content').className = `modal-content ${type}`;
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                copyReportBtn.textContent = 'Copiar al Portapapeles';
                copyReportBtn.style.display = showCopyBtn ? 'block' : 'none';
                if (showCopyBtn) {
                    copyReportBtn.onclick = () => {
                        const reportContent = modalBody.querySelector('.status-report')?.innerText || modalBody.innerText;
                        copyTextToClipboard(reportContent,
                            () => {
                                copyReportBtn.textContent = '¡Copiado!';
                                setTimeout(() => copyReportBtn.textContent = 'Copiar al Portapapeles', 2000);
                            },
                            () => {
                                showModal('Error', 'No se pudo copiar el reporte.', 'error');
                            }
                        );
                    };
                }
                modalOverlay.classList.add('visible');
            }

            function showConfirmationModal(message, onConfirmCallback) {
                const content = `
                    <p>${message}</p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="confirmBtn" class="btn btn-danger" style="flex: 1;">Confirmar</button>
                        <button id="cancelBtn" class="btn" style="flex: 1; background-color: var(--border-color);">Cancelar</button>
                    </div>
                `;
                showModal('Confirmar Acción', content);
                doc('confirmBtn').onclick = () => {
                    onConfirmCallback();
                    hideModal();
                };
                doc('cancelBtn').onclick = hideModal;
            }

            function hideModal() { modalOverlay.classList.remove('visible'); }

            function excelSerialToDate(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                try {
                    const decoded = XLSX.SSF.parse_date_code(serial);
                    if (decoded) {
                        const hours = (decoded.H === 0 && decoded.M === 0 && decoded.S === 0) ? 12 : decoded.H;
                        return new Date(Date.UTC(decoded.y, decoded.m - 1, decoded.d, hours, decoded.M, decoded.S));
                    }
                } catch(e) { console.error("Error al parsear la fecha serial de Excel:", e); }
                return null;
            }
            
            function formatDateTimeFromSerial(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return '';
                try {
                    const decoded = XLSX.SSF.parse_date_code(serial);
                    if (decoded) {
                        const day = String(decoded.d).padStart(2, '0');
                        const month = String(decoded.m).padStart(2, '0');
                        const year = decoded.y;
                        const hours = String(decoded.H).padStart(2, '0');
                        const minutes = String(decoded.M).padStart(2, '0');
                        return `${day}/${month}/${year} ${hours}:${minutes}`;
                    }
                } catch(e) { console.error("Error al formatear fecha/hora desde serial de Excel:", e); }
                return '';
            }

            function formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                return date.toLocaleDateString('es-ES', { timeZone: REYNOSA_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            function formatDateTime(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                return date.toLocaleString('es-ES', {
                    timeZone: REYNOSA_TIMEZONE,
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', hour12: false
                }).replace(',', '');
            }
            function findHeader(headers, keyText) { return headers && headers.find(h => h && h.toLowerCase() === keyText.toLowerCase()); }
            
            // =========================
            // === FWD VIEW FUNCTIONS ===
            // =========================
            async function saveOrderToFirebase(orderKey, orderData, area) {
                try {
                    const empaqueDataForDB = Array.from(orderData.empaqueData.entries()).map(([boxId, serials]) => ({ boxId, serials }));
                    const dataToSave = { ...orderData, empaqueData: empaqueDataForDB };
                    await db.collection('areas').doc(area).collection('orders').doc(orderKey).set(dataToSave, { merge: true });
                } catch (e) {
                    console.error("Error al guardar en Firebase: ", e);
                    showModal('Error al Guardar', `No se pudo guardar la orden ${orderKey}.`, 'error');
                }
            }

            async function deleteOrderFromFirebase(orderKey) {
                try {
                    await db.collection('areas').doc(currentArea).collection('orders').doc(orderKey).delete();
                } catch (e) {
                    console.error("Error al eliminar en Firebase: ", e);
                    showModal('Error al Eliminar', `No se pudo eliminar la orden ${orderKey}.`, 'error');
                }
            }

            function handleFiles(files, isUpdate = false) {
                const canEdit = session.isMaster || (session.permissions && session.permissions.includes(currentArea));
                if (!canEdit) {
                    showModal('Acceso Denegado', `No tienes permisos para modificar el área ${currentArea}.`, 'error');
                    return;
                }

                const excelFiles = Array.from(files).filter(f => f.name.endsWith('.xlsx') || f.name.endsWith('.xls'));
                const filePromises = excelFiles.map(file => processFile(file, isUpdate));

                Promise.all(filePromises)
                    .then(results => {
                        const updatePromises = [];
                        results.forEach(result => {
                            if (result) {
                                loadedOrders.set(result.key, result.data);
                                updatePromises.push(saveOrderToFirebase(result.key, result.data, currentArea));
                            }
                        });
                        
                        Promise.all(updatePromises).then(() => {
                            showModal('Éxito', `${results.length} orden(es) actualizadas con detalles.`, 'success');
                        });
                    })
                    .catch(err => {
                        showModal('Error al Cargar', err.message || 'Uno o más archivos no pudieron ser procesados.', 'error');
                        console.error("Error detallado en handleFiles:", err);
                    });
            }

            function processFile(file, isUpdate) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const orderNumber = String(worksheet['B3']?.v || `Archivo_${file.name.slice(0,10)}`);
                        
                        const keyToUse = isUpdate ? orderToUpdateKey : orderNumber;
                        let existingOrderData;

                        if (loadedOrders.has(keyToUse)) {
                            // La orden ya existe, la tomamos para actualizarla.
                            existingOrderData = loadedOrders.get(keyToUse);
                        } else {
                            // La orden es nueva. Creamos una estructura base con las celdas correctas.
                            console.log(`La orden ${orderNumber} no fue cargada por SAP. Creando nueva entrada.`);
                            existingOrderData = {
                                // AJUSTE: Leemos la cantidad total de la celda O3
                                orderQty: parseInt(worksheet['O3']?.v || 0),
                                // AJUSTE: Leemos el catálogo de la celda I3
                                catalogNumber: String(worksheet['I3']?.v || 'N/A'),
                                
                                orderDate: new Date(),
                                packedQty: 0,
                                rastreoData: [],
                                empaqueData: new Map(),
                                headers: { rastreo: [], empaque: [] }
                            };
                        }

                        const TRACKING_COLS = ['B', 'C', 'G', 'K', 'M', 'P', 'V', 'Y', 'Z', 'AA', 'AB'];
                        const PACKING_COLS = ['AE', 'AF', 'AK', 'AO'];
                        const rastreoRawData = extractTableData(worksheet, TRACKING_COLS, 20);
                        const packingRawData = extractTableData(worksheet, PACKING_COLS, 20);
                        
                        const orderData = {
                            ...existingOrderData, 
                            // Confirmado: Leemos la cantidad empacada de la celda U3
                            packedQty: parseInt(worksheet['U3']?.v || existingOrderData.packedQty || 0),
                            rastreoData: processRastreoData(rastreoRawData),
                            empaqueData: groupEmpaqueData(packingRawData),
                            headers: {
                                rastreo: Object.keys(rastreoRawData[0] || {}),
                                empaque: Object.keys(packingRawData[0] || {})
                            },
                            lastUpdated: new Date(),
                            lastUpdatedBy: session.user
                        };
                        resolve({ key: keyToUse, data: orderData });
                    } catch(err) { 
                        console.error("Error detallado en processFile:", err);
                        reject(err); 
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
            function extractTableData(worksheet, cols, startRow) {
                const headers = {};
                cols.forEach(col => {
                    const cell = worksheet[col + startRow];
                    if(cell && cell.v) headers[col] = cell.v.toString().trim();
                });

                if (Object.keys(headers).length === 0) return [];
                
                const jsonData = [];
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let rowNum = startRow + 1; rowNum <= range.e.r + 1; ++rowNum) {
                    const row = {};
                    let hasData = false;
                    for(const col in headers) {
                        const headerName = headers[col];
                        const cellAddress = col + rowNum;
                        const cell = worksheet[cellAddress];
                        if(cell && cell.v !== undefined) {
                            row[headerName] = cell.v;
                            hasData = true;
                        } else {
                            row[headerName] = '';
                        }
                    }
                    if (hasData) jsonData.push(row);
                }
                return jsonData;
            }
            
            function processRastreoData(data) {
                if (!data || data.length === 0) return [];
                const now = new Date();
                const headers = Object.keys(data[0] || {});
                const scrapHeader = findHeader(headers, TRACKING_KEYS.IS_SCRAP);
                const dateHeader = findHeader(headers, TRACKING_KEYS.DATE_REGISTERED);

                return data.map(row => {
                    let status = 'normal';
                    const isScrap = String(row[scrapHeader]).trim().toUpperCase() === 'X';

                    if (isScrap) {
                        status = 'scrap';
                    } else {
                        const dateSerial = row[dateHeader];
                        const registeredDate = excelSerialToDate(dateSerial);
                        if (registeredDate) {
                            const ageInMillis = now.getTime() - registeredDate.getTime();
                            const ageInHours = ageInMillis / (1000 * 60 * 60);

                            if (ageInHours > 25) {
                                status = 'very_delayed';
                            } else if (ageInHours > 8) {
                                status = 'delayed';
                            } else {
                                status = 'today';
                            }
                        }
                    }
                    return { ...row, status };
                });
            }

            function groupEmpaqueData(data) {
                if (!data || data.length === 0) return new Map();
                const boxIdHeader = findHeader(Object.keys(data[0]), PACKING_KEYS.BOX_ID);
                if (!boxIdHeader) return new Map();

                return data.reduce((acc, row) => {
                    const boxId = row[boxIdHeader];
                    if (boxId && String(boxId).trim() !== '') {
                        if (!acc.has(boxId)) acc.set(boxId, []);
                        acc.get(boxId).push(row);
                    }
                    return acc;
                }, new Map());
            }
            
            function switchMode(mode) {
                currentMode = mode;
                doc('rastreoView').style.display = mode === 'rastreo' ? 'block' : 'none';
                doc('empaqueView').style.display = mode === 'empaque' ? 'block' : 'none';

                modeRastreo.classList.toggle('active', mode === 'rastreo');
                modeEmpaque.classList.toggle('active', mode === 'empaque');
                render();
            }

            function updateOrderList() {
    // ---> INICIO DE CAMBIOS: Obtenemos el texto de búsqueda y lo preparamos
    const searchText = orderSearchInput ? orderSearchInput.value.trim().toUpperCase() : '';
    const isSearching = searchText !== '';

    // Guardamos los grupos que estaban expandidos antes de redibujar
    const expandedMonths = new Set();
    if (!isSearching) { // Solo guardamos el estado si NO estamos buscando
        orderList.querySelectorAll('.month-group.expanded').forEach(group => {
            if (group.dataset.month) expandedMonths.add(group.dataset.month);
        });
    }
    const expandedDates = new Set();
    if (!isSearching) { // Solo guardamos el estado si NO estamos buscando
        orderList.querySelectorAll('.date-group.expanded').forEach(group => {
            if (group.dataset.date) expandedDates.add(group.dataset.date);
        });
    }

    orderList.innerHTML = '';

    // ---> CAMBIO: Filtramos las órdenes si hay texto en la búsqueda
    let filteredOrders = loadedOrders;
    if (isSearching) {
        const tempFiltered = new Map();
        loadedOrders.forEach((value, key) => {
            if (key.toUpperCase().includes(searchText)) {
                tempFiltered.set(key, value);
            }
        });
        filteredOrders = tempFiltered;
    }
    // ---> FIN DE CAMBIOS en esta sección

    if (filteredOrders.size === 0) {
        orderList.innerHTML = `<p class="text-dark" style="font-size:0.9rem;">${isSearching ? 'No se encontraron órdenes.' : `No hay órdenes cargadas para el área ${currentArea || ''}.`}</p>`;
        return;
    }

    const MONTH_NAMES = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
    const groupedByMonth = new Map();

    // ---> CAMBIO: Usamos 'filteredOrders' en lugar de 'loadedOrders'
    for (const [key, order] of filteredOrders.entries()) {
        const date = order.orderDate || new Date(0);
        const monthYearKey = `${date.getMonth()}-${date.getFullYear()}`;
        if (!groupedByMonth.has(monthYearKey)) groupedByMonth.set(monthYearKey, []);
        groupedByMonth.get(monthYearKey).push({ key, ...order });
    }

    const sortedMonths = Array.from(groupedByMonth.keys()).sort((a, b) => {
        const [monthA, yearA] = a.split('-').map(Number);
        const [monthB, yearB] = b.split('-').map(Number);
        if (yearA !== yearB) return yearB - yearA;
        return monthB - monthA;
    });
    
    const todayString = new Date().toLocaleDateString('es-ES', {
        timeZone: REYNOSA_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric'
    });

    sortedMonths.forEach(monthYearKey => {
        const [monthIndex, year] = monthYearKey.split('-').map(Number);
        const monthName = `${MONTH_NAMES[monthIndex]} ${year}`;
        const ordersInMonth = groupedByMonth.get(monthYearKey);

        const monthGroupDiv = document.createElement('div');
        monthGroupDiv.className = 'month-group';
        monthGroupDiv.dataset.month = monthYearKey;

        const monthHeaderBtn = document.createElement('button');
        monthHeaderBtn.className = 'month-header';
        monthHeaderBtn.innerHTML = `<span>${monthName}</span> <span class="collapse-icon">►</span>`;

        const datesContainer = document.createElement('div');
        datesContainer.className = 'dates-for-month';

        const groupedByDate = new Map();
        ordersInMonth.forEach(order => {
            const date = order.orderDate || new Date(0);
            const dateString = formatDate(date);
            if (!groupedByDate.has(dateString)) groupedByDate.set(dateString, []);
            groupedByDate.get(dateString).push(order);
        });

        const sortedDates = Array.from(groupedByDate.keys()).sort((a, b) => {
            const dateA = new Date(a.split('/').reverse().join('-'));
            const dateB = new Date(b.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        sortedDates.forEach(dateString => {
            const ordersOnDate = groupedByDate.get(dateString);
            const orderCount = ordersOnDate.length;
            const isToday = dateString === todayString;

            const dateGroupDiv = document.createElement('div');
            dateGroupDiv.className = 'date-group';
            dateGroupDiv.dataset.date = dateString;

            const dateHeaderBtn = document.createElement('button');
            dateHeaderBtn.className = 'date-header';
            
            const countText = `${orderCount} ${orderCount === 1 ? 'orden' : 'órdenes'}`;
            dateHeaderBtn.innerHTML = `
                <span>📅 ${dateString}</span>
                ${isToday ? `<span class="status-indicator">(${countText})</span>` : `<span class="order-count">(${countText})</span>`}
                <span class="collapse-icon">►</span>
            `;

            const ordersContainer = document.createElement('div');
            ordersContainer.className = 'orders-for-date';
            ordersOnDate.forEach(order => ordersContainer.appendChild(createOrderButton(order.key, order)));

            dateGroupDiv.appendChild(dateHeaderBtn);
            dateGroupDiv.appendChild(ordersContainer);
            datesContainer.appendChild(dateGroupDiv);

            dateHeaderBtn.addEventListener('click', () => {
                dateGroupDiv.classList.toggle('expanded');
            });

            // ---> CAMBIO: Forzamos la expansión si se está buscando algo
            if (isSearching || expandedDates.has(dateString)) {
                dateGroupDiv.classList.add('expanded');
            }
        });

        monthGroupDiv.appendChild(monthHeaderBtn);
        monthGroupDiv.appendChild(datesContainer);
        orderList.appendChild(monthGroupDiv);
        
        monthHeaderBtn.addEventListener('click', () => {
            monthGroupDiv.classList.toggle('expanded');
        });
        
        // ---> CAMBIO: Forzamos la expansión si se está buscando algo
        if (isSearching || expandedMonths.has(monthYearKey)) {
            monthGroupDiv.classList.add('expanded');
        }
    });
    
    setActiveOrder(activeOrderKey);
}

            function createOrderButton(key, orderData) {
                const item = document.createElement('div');
                item.className = 'order-item';

                const btn = document.createElement('button');
                btn.className = 'order-btn';
                btn.textContent = key;
                btn.dataset.key = key;
                btn.onclick = () => setActiveOrder(key);
                if (orderData && orderData.orderQty > 0 && orderData.orderQty <= orderData.packedQty) {
                    btn.classList.add('is-complete');
                }
                
                const progressBar = document.createElement('div');
                progressBar.className = 'order-progress-bar';
                const progressBarInner = document.createElement('div');
                progressBarInner.className = 'order-progress-bar-inner';
                const percentage = (orderData.orderQty > 0) ? (orderData.packedQty / orderData.orderQty) * 100 : 0;
                progressBarInner.style.width = `${Math.min(percentage, 100)}%`;

                if (percentage < 30) progressBarInner.style.backgroundColor = 'var(--danger-color)';
                else if (percentage < 70) progressBarInner.style.backgroundColor = 'var(--warning-color)';
                else progressBarInner.style.backgroundColor = 'var(--success-color)';
                
                progressBar.appendChild(progressBarInner);
                btn.appendChild(progressBar);
                item.appendChild(btn);

                const canManageThisArea = session.isMaster || (session.permissions && session.permissions.includes(currentArea));
                
                if (key !== 'all' && canManageThisArea && session.isMaster) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-btn';
                    deleteBtn.title = 'Eliminar orden';
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                    deleteBtn.onclick = () => {
                        showConfirmationModal(`¿Estás seguro de que quieres eliminar la orden ${key}?`, async () => {
                            await deleteOrderFromFirebase(key);
                        });
                    };
                    item.appendChild(deleteBtn);
                }
                return item;
            }

            function setActiveOrder(key) {
                activeOrderKey = key;
                document.querySelectorAll('.order-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.key === key);
                });
                render();
            }

            function render() {
                if (mainMode === 'fwd') {
                    renderControls();
                    renderSummary();
                    updateGlobalDashboard();
                    if (currentMode === 'rastreo') {
                        renderRastreoView(activeOrderKey);
                    } else {
                        renderEmpaqueView(activeOrderKey);
                    }
                } else if (mainMode === 'sap') {
                    renderSapView();
                }
                adjustStickyTops();
            }

            function renderSummary() {
                let orderQty = 0, packedQty = 0, scrapCount = 0; let ordersToProcess = [];
                lastUpdatedContainer.textContent = '';
                
                if (activeOrderKey === 'all' || activeOrderKey === null) {
                    const todayString = new Date().toLocaleDateString('es-ES', {
                        timeZone: REYNOSA_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric'
                    });
                    ordersToProcess = Array.from(loadedOrders.values()).filter(order => formatDate(order.orderDate) === todayString);
                    
                    if (ordersToProcess.length > 0) {
                        statOrderNumber.textContent = 'Órdenes del Día';
                        const firstCatalog = ordersToProcess[0].catalogNumber;
                        const allSameCatalog = ordersToProcess.every(o => o.catalogNumber === firstCatalog);
                        statCatalogNumber.textContent = allSameCatalog ? firstCatalog : 'Múltiples Catálogos';
                    } else {
                        statOrderNumber.textContent = 'N/A';
                        statCatalogNumber.textContent = 'No hay órdenes para hoy';
                    }
                
                } else if (loadedOrders.has(activeOrderKey)) {
                    ordersToProcess = [loadedOrders.get(activeOrderKey)];
                    const order = ordersToProcess[0];
                    statOrderNumber.textContent = activeOrderKey;
                    statCatalogNumber.textContent = order.catalogNumber;
                    
                    if (order.lastUpdated) {
                        let updatedText = `Última actualización: ${formatDateTime(order.lastUpdated)}`;
                        if (order.lastUpdatedBy) {
                            updatedText += ` por: ${order.lastUpdatedBy}`;
                        }
                        lastUpdatedContainer.textContent = updatedText;
                    }

                } else if (loadedOrders.size > 0) {
                    setActiveOrder(null);
                    return;
                } else {
                    statOrderNumber.textContent = 'N/A';
                    statCatalogNumber.textContent = '';
                }
                
                ordersToProcess.forEach(order => {
                    orderQty += order.orderQty || 0;
                    packedQty += order.packedQty || 0;
                    if(order.rastreoData) {
                       scrapCount += order.rastreoData.filter(row => row.status === 'scrap').length;
                    }
                });

                statOrderQty.textContent = orderQty;
                statPackedQty.textContent = packedQty;
                statRemainingQty.textContent = orderQty - packedQty;
                statScrapQty.textContent = scrapCount;
            }

            function updateGlobalDashboard() {
                const todayString = new Date().toLocaleDateString('es-ES', {
                    timeZone: REYNOSA_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric'
                });
                let todaysOrdersCount = 0; let completedOrdersToday = 0;
                for (const order of loadedOrders.values()) {
                    const orderDateString = formatDate(order.orderDate || new Date());
                    if (orderDateString === todayString) {
                        todaysOrdersCount++;
                        if (order.orderQty > 0 && order.orderQty <= order.packedQty) completedOrdersToday++;
                    }
                }
                totalOrdersStat.textContent = todaysOrdersCount;
                completedOrdersStat.textContent = completedOrdersToday;
            }
            
            function renderControls() {
                const hasOrders = loadedOrders.size > 0;
                const statusHTML = `
                    <button class="filter-btn ${rastreoStatusFilter === 'all' ? 'active' : ''}" data-filter="all">Todos</button>
                    <button class="filter-btn ${rastreoStatusFilter === 'today' ? 'active' : ''}" data-filter="today">En Movimiento</button>
                    <button class="filter-btn ${rastreoStatusFilter === 'delayed' ? 'active' : ''}" data-filter="delayed">Sin Movimiento</button>
                    <button class="filter-btn ${rastreoStatusFilter === 'scrap' ? 'active' : ''}" data-filter="scrap">Scrap</button>
                `;
                mobileControls.status.innerHTML = statusHTML;
                desktopControls.status.innerHTML = statusHTML;

                const actionsHTML = `
                    <button class="btn" id="exportImageButtonMobile" ${!hasOrders ? 'disabled' : ''}>Exportar Captura</button>
                    <button class="btn" id="exportStatusButtonMobile" ${!hasOrders ? 'disabled' : ''}>Reporte de Estatus</button>
                `;
                const desktopActionsHTML = `
                    <button class="btn" id="exportImageButtonDesktop" ${!hasOrders ? 'disabled' : ''}>Captura</button>
                    <button class="btn" id="exportStatusButtonDesktop" ${!hasOrders ? 'disabled' : ''}>Reporte</button>
                `;
                mobileControls.actions.innerHTML = actionsHTML;
                desktopControls.actions.innerHTML = desktopActionsHTML;

                doc('exportImageButtonMobile').addEventListener('click', handleImageExport);
                doc('exportImageButtonDesktop').addEventListener('click', handleImageExport);
                doc('exportStatusButtonMobile').addEventListener('click', handleStatusReport);
                doc('exportStatusButtonDesktop').addEventListener('click', handleStatusReport);
            }

            async function renderRastreoView(key) {
                const tableWrapper = doc('rastreoTable').parentElement;
                tableWrapper.style.opacity = '0';
                await new Promise(res => setTimeout(res, 150));
                
                if (!key) {
                    updateRastreoTable([], []);
                    updateLineCounts([], []);
                    placeholderText.textContent = 'Selecciona una orden de la lista para ver sus detalles.';
                    placeholderText.style.display = 'block';
                    tableWrapper.style.opacity = '1';
                    return;
                }
                
                let dataToShow = []; let headers = [];
                if (key === 'all') {
                    loadedOrders.forEach(order => { if(order.rastreoData) dataToShow.push(...order.rastreoData) });
                    if (loadedOrders.size > 0) headers = Array.from(loadedOrders.values()).find(o => o.headers.rastreo)?.headers.rastreo;
                } else if (loadedOrders.has(key)) {
                    const order = loadedOrders.get(key);
                    dataToShow = order.rastreoData || []; headers = order.headers.rastreo || [];
                }
                
                createRastreoLineFilters(dataToShow, headers);

                let filteredData = dataToShow;
                if (rastreoStatusFilter !== 'all') {
                    if (rastreoStatusFilter === 'delayed') {
                        filteredData = dataToShow.filter(row => row.status === 'delayed' || row.status === 'very_delayed');
                    } else {
                        filteredData = dataToShow.filter(row => row.status === rastreoStatusFilter);
                    }
                }
                
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (rastreoLineFilter !== 'all' && lineHeader) filteredData = filteredData.filter(row => row[lineHeader] === rastreoLineFilter);
                const searchText = rastreoFilterInput.value.toLowerCase();
                if (searchText) filteredData = filteredData.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(searchText)));
                currentVisibleData = filteredData;
                
                placeholderText.style.display = (dataToShow.length > 0) ? 'none' : 'block';

                updateRastreoTable(filteredData, headers);
                updateLineCounts(filteredData, headers);
                
                tableWrapper.style.opacity = '1';
            }

            function createRastreoLineFilters(data, headers) {
                if (!headers) headers = [];
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                
                let lineHTML = '';
                if (!lineHeader || !data || data.length === 0) {
                    lineHTML = `<p class="text-dark" style="font-size: 0.9rem; margin: 0;">N/A</p>`;
                } else {
                    const uniqueLines = [...new Set(data.map(row => row[lineHeader]).filter(Boolean))].sort();
                    lineHTML += `<button class="filter-btn ${rastreoLineFilter === 'all' ? 'active' : ''}" data-filter="all">Todas</button>`;
                    uniqueLines.forEach(line => {
                        lineHTML += `<button class="filter-btn ${rastreoLineFilter === line ? 'active' : ''}" data-filter="${line}">${line}</button>`;
                    });
                }
                
                mobileControls.line.innerHTML = lineHTML;
                desktopControls.line.innerHTML = lineHTML;
            }
            
            function updateRastreoTable(data, headers) {
                const table = doc('rastreoTable');
                if (!table) return;
                const isMobile = window.innerWidth <= 992;
                let headersToRender;
                const serialHeader = findHeader(headers, TRACKING_KEYS.SERIAL);

                if (isMobile) {
                    headersToRender = [
                        findHeader(headers, TRACKING_KEYS.SERIAL), findHeader(headers, TRACKING_KEYS.LINE),
                        findHeader(headers, TRACKING_KEYS.STATION), findHeader(headers, TRACKING_KEYS.DATE_REGISTERED)
                    ].filter(Boolean);
                } else {
                    const headersToHide = [TRACKING_KEYS.CREATED_BY, TRACKING_KEYS.NOT_PACKED, TRACKING_KEYS.IS_SCRAP].map(h => findHeader(headers, h)).filter(Boolean);
                    headersToRender = headers ? headers.filter(h => !headersToHide.includes(h) && h !== 'status') : [];
                }

                if (!data || data.length === 0 || !headersToRender || headersToRender.length === 0) {
                    table.innerHTML = `<thead><tr><th></th></tr></thead><tbody></tbody>`;
                    return;
                }
                table.innerHTML = `
                    <thead><tr>${headersToRender.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>
                        ${data.map(row => `
                            <tr class="is-${row.status}">
                                ${headersToRender.map(h => {
                                    const isSerialColumn = h === serialHeader;
                                    const cellClass = isSerialColumn ? 'serial-cell' : '';
                                    const clickHandler = isSerialColumn ? `onclick="copySerialNumber(this, '${String(row[h]).replace(/'/g, "\\'")}')"` : '';
                                    return `<td class="${cellClass}" ${clickHandler} data-label="${h}">${formatCell(row[h], h, h === findHeader(headers, TRACKING_KEYS.DATE_REGISTERED))}</td>`
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>`;
            }

            function updateLineCounts(data, headers) {
                if (!headers) headers = [];
                const lineHeader = findHeader(headers, TRACKING_KEYS.LINE);
                if (!lineHeader) { lineCountsContainer.innerHTML = ''; return; }
                const counts = data.reduce((acc, row) => {
                    const line = row[lineHeader];
                    if (line) acc[line] = (acc[line] || 0) + 1;
                    return acc;
                }, {});
                
                lineCountsContainer.innerHTML = Object.entries(counts).sort().map(([line, count]) =>
                    `<div class="line-badge">${line}: <span>${count}</span></div>`
                ).join('');
            }
            
            async function showPackingDetailsModal(boxId, serials, headers) {
    const serialHeader = findHeader(headers, PACKING_KEYS.SERIAL);
    const employeeIdHeader = findHeader(headers, PACKING_KEYS.EMPLOYEE_ID);
    const packedDateHeader = findHeader(headers, PACKING_KEYS.PACKED_DATE);
    
    let grValue = "N/A", ordenValue = "N/A", usuarioValue = "N/A";
    try {
        const docSnap = await db.collection('boxID_historico').doc(boxId).get();
        
        // --- ¡AQUÍ ESTÁ LA CORRECCIÓN! ---
        // Cambiamos docSnap.exists() por docSnap.exists (sin los paréntesis)
        if (docSnap.exists) { 
            const data = docSnap.data();
            grValue = data.gr || "N/A";
            ordenValue = data.orden || "N/A";
            usuarioValue = data.usuario || "N/A";
        }
    } catch (e) {
        console.error("Error al obtener datos del BoxID:", e);
        grValue = "Error"; ordenValue = "Error"; usuarioValue = "Error";
    }

    let packerInfo = '';
    if (serials && serials.length > 0) {
        const latestSerial = serials.reduce((latest, current) => (current[packedDateHeader] > latest[packedDateHeader]) ? current : latest, serials[0]);
        const packerId = latestSerial[employeeIdHeader];
        
        const grHTML = `<span class="packer-info">GR: <strong class="copyable" onclick="copyGR(this, '${grValue}')" title="Haz clic para copiar">${grValue}</strong></span>`;
        const ordenHTML = `<span class="packer-info">Orden: <strong class="copyable" onclick="copyGR(this, '${ordenValue}')" title="Haz clic para copiar">${ordenValue}</strong></span>`;
        const usuarioHTML = `<span class="packer-info">Confirmado por: <strong>${usuarioValue}</strong></span>`;
        
        packerInfo = `<div class="packing-modal-header">
                        <span class="packer-info">EMPACADOR: <strong>${packerId || 'N/A'}</strong></span>
                        ${ordenHTML}
                        ${grHTML}
                        ${usuarioHTML}
                    </div>`;
    }
    
    let content = `${packerInfo}<ul class="packing-details-list">`;
    if (serials && serials.length > 0) {
        serials.forEach(serial => {
            content += `<li>
                <span>${serial[serialHeader]}</span>
                <span>${formatDateTimeFromSerial(serial[packedDateHeader])}</span>
            </li>`;
        });
    } else {
        content += '<li>No hay seriales en esta caja.</li>';
    }
    content += '</ul>';

    showModal(`Detalle de Caja: ${boxId}`, content);
}

            async function renderEmpaqueView(key) {
    const tableWrapper = doc('empaqueTableContainer');
    tableWrapper.style.opacity = '0';
    await new Promise(res => setTimeout(res, 150));

    let receivedBoxData = new Map();
    let grDataMap = new Map();
    try {
        const [boxSnapshot, grSnapshot] = await Promise.all([
            db.collection('boxID_historico').get(),
            db.collection('gr_historico').get()
        ]);
        boxSnapshot.forEach(doc => receivedBoxData.set(doc.id, doc.data()));
        grSnapshot.forEach(doc => grDataMap.set(doc.id, doc.data()));
    } catch (e) {
        console.error("Error al obtener datos históricos:", e);
    }
    
    let dataToShow = new Map(); let headers = [];
    if (key === 'all' || key === null) {
        loadedOrders.forEach(order => {
            if(order.empaqueData) order.empaqueData.forEach((serials, boxId) => {
                if (!dataToShow.has(boxId)) dataToShow.set(boxId, []);
                if(serials && serials.length > 0) dataToShow.get(boxId).push(...serials);
            });
        });
        if (loadedOrders.size > 0) {
            const orderWithHeaders = Array.from(loadedOrders.values()).find(o => o.headers && o.headers.empaque && o.headers.empaque.length > 0);
            if (orderWithHeaders) headers = orderWithHeaders.headers.empaque;
        }
    } else if (loadedOrders.has(key)) {
        const order = loadedOrders.get(key);
        dataToShow = order.empaqueData || new Map(); headers = order.headers.empaque || [];
    }

    if (!dataToShow || dataToShow.size === 0) {
        tableWrapper.innerHTML = `<table id="empaqueTable"><thead><tr><th>No hay datos de empaque.</th></tr></thead></table>`;
        tableWrapper.style.opacity = '1'; return;
    }

    const packedDateHeader = findHeader(headers, PACKING_KEYS.PACKED_DATE);
    const filterText = empaqueFilterInput.value.toLowerCase();
    
    let tableHTML = `<thead><tr><th>BoxID</th><th>Cantidad</th><th>Último Empaque</th><th>Recibido Logística</th><th>GR</th><th>Orden</th><th>Usuario</th></tr></thead><tbody>`;
    let entriesFound = 0;
    const reversedEntries = Array.from(dataToShow.entries()).reverse();

    for (const [boxId, serials] of reversedEntries) {
        if(!serials || serials.length === 0) continue;
        const serialsMatchFilter = serials.some(s => String(s[findHeader(headers, PACKING_KEYS.SERIAL)]).toLowerCase().includes(filterText));
        if (filterText && !String(boxId).toLowerCase().includes(filterText) && !serialsMatchFilter) continue;
        entriesFound++;
        const latestSerial = serials.reduce((latest, current) => (current[packedDateHeader] > latest[packedDateHeader]) ? current : latest, serials[0]);

        const boxData = receivedBoxData.get(boxId);
        const statusClass = boxData ? 'boxid-received' : 'boxid-missing';
        const receivedDateText = boxData && boxData.receivedAt ? formatShortDateTime(boxData.receivedAt.toDate()) : 'N/A';
        
        // --- ¡AQUÍ ESTÁ LA CORRECCIÓN! ---
        // Limpiamos el GR antes de buscarlo para evitar pedos de espacios o tipos de dato
        const grValue = boxData && boxData.gr ? String(boxData.gr).trim() : 'N/A';
        
        const grInfo = grDataMap.get(grValue);
        const ordenValue = grInfo && grInfo.orden ? grInfo.orden : 'N/A';
        const usuarioValue = grInfo && grInfo.usuario ? grInfo.usuario : 'N/A';

        tableHTML += `
            <tr class="box-row" data-boxid="${boxId}">
                <td data-label="BoxID" class="${statusClass}">${boxId}</td>
                <td data-label="Cantidad">${serials.length}</td>
                <td data-label="Último Empaque">${formatDateTimeFromSerial(latestSerial[packedDateHeader])}</td>
                <td data-label="Recibido Logística">${receivedDateText}</td>
                <td data-label="GR">${grValue}</td>
                <td data-label="Orden">${ordenValue}</td>
                <td data-label="Usuario">${usuarioValue}</td>
            </tr>`;
    }
    tableHTML += `</tbody>`;

    if (entriesFound === 0) { tableWrapper.innerHTML = `<table id="empaqueTable"><thead><tr><th>No se encontraron resultados.</th></tr></thead></table>`; } 
    else { tableWrapper.innerHTML = `<table id="empaqueTable">${tableHTML}</table>`; }

    tableWrapper.querySelectorAll('.box-row').forEach(row => {
        row.addEventListener('click', () => {
            const boxId = row.dataset.boxid;
            const serialsForBox = dataToShow.get(boxId);
            showPackingDetailsModal(boxId, serialsForBox, headers);
        });
    });
    tableWrapper.style.opacity = '1';
}


// Función para formatear la fecha como DD/MM/YY HH:MM
function formatShortDateTime(date) {
    if (!(date instanceof Date) || isNaN(date)) return '';
    const year = date.getFullYear().toString().slice(-2);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hour}:${minute}`;
}

// Función para copiar el GR con feedback visual
window.copyGR = function(element, gr) {
    if (!gr || gr === 'N/A') return;
    
    copyTextToClipboard(gr,
        () => { // Success
            const originalText = element.textContent;
            element.textContent = '¡Copiado!';
            element.style.color = 'var(--success-color)';
            setTimeout(() => {
                element.textContent = originalText;
                element.style.color = '';
            }, 1500);
        },
        (err) => { // Error
            console.error('Error al copiar el GR: ', err);
        }
    );
}

            
            async function handleImageExport(event) {
                if (!currentVisibleData || currentVisibleData.length === 0) {
                    showModal('Exportar Captura', 'No hay datos en la vista actual para exportar.', 'warning');
                    return;
                }

                const button = event.target.closest('button');
                const originalButtonText = button.textContent;
                button.textContent = 'Generando...';
                button.disabled = true;

                const cloneContainer = document.createElement('div');
                cloneContainer.style.position = 'absolute';
                cloneContainer.style.left = '-9999px';
                cloneContainer.style.top = '0';
                cloneContainer.style.display = 'inline-block';
                cloneContainer.style.background = 'var(--surface-color)';
                cloneContainer.style.padding = '20px';
                cloneContainer.style.borderRadius = '16px';

                const tableToClone = doc('rastreoTable');
                const clonedTable = tableToClone.cloneNode(true);
                
                if (activeOrderKey && activeOrderKey !== 'all') {
                    const caption = clonedTable.createCaption();
                    caption.textContent = activeOrderKey;
                }
                
                const style = document.createElement('style');
                style.innerHTML = `
                    :root { --surface-color: #1E293B; --border-color: #334155; --danger-color: #FB7185; --warning-color: #FBBF24; --orange-color: #F97316; --success-color: #34D399; --text-primary: #F8FAFC; --text-secondary: #94A3B8; }
                    table { color: var(--text-primary); background-color: var(--surface-color); border-collapse: collapse; font-family: 'Inter', sans-serif; font-size: 14px; }
                    caption { caption-side: top; text-align: center; font-size: 24px; font-weight: 700; color: var(--text-secondary); margin-bottom: 20px; font-family: 'Inter', sans-serif; }
                    th, td { padding: 12px 24px; text-align: center !important; border: 1px solid var(--border-color); white-space: nowrap; }
                    thead { display: table-header-group !important; background-color: #1a2436; position: static !important; }
                    th { font-weight: 600; color: var(--text-secondary); font-size: 12px; }
                    tr { display: table-row !important; }
                    td { display: table-cell !important; background-color: inherit !important; }
                    td::before { display: none !important; }
                    tr.is-scrap { background-color: rgba(251, 113, 133, 0.1) !important; }
                    tr.is-scrap td { color: var(--danger-color) !important; }
                    tr.is-very_delayed { background-color: rgba(249, 115, 22, 0.1) !important; }
                    tr.is-very_delayed td { color: var(--orange-color) !important; }
                    tr.is-delayed { background-color: rgba(251, 191, 36, 0.1) !important; }
                    tr.is-delayed td { color: var(--warning-color) !important; }
                    tr.is-today { background-color: rgba(52, 211, 153, 0.1) !important; }
                    tr.is-today td { color: var(--success-color) !important; }
                `;
                
                cloneContainer.appendChild(style);
                cloneContainer.appendChild(clonedTable);
                document.body.appendChild(cloneContainer);

                await new Promise(resolve => setTimeout(resolve, 100));

                try {
                    const canvas = await html2canvas(cloneContainer, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: null,
                    });

                    const a = document.createElement('a');
                    a.href = canvas.toDataURL('image/jpeg', 0.95);
                    const orderName = (activeOrderKey && activeOrderKey !== 'all') ? activeOrderKey : 'Multiples_Ordenes';
                    const dateStamp = new Date().toLocaleDateString('es-ES').replace(/\//g, '-');
                    a.download = `Captura_Rastreo_${orderName}_${dateStamp}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                } catch (e) {
                    console.error("Error al generar la imagen:", e);
                    showModal('Error', 'Ocurrió un error al generar el archivo de imagen.', 'error');
                } finally {
                    document.body.removeChild(cloneContainer);
                    button.textContent = originalButtonText;
                    button.disabled = false;
                }
            }

            function handleStatusReport() {
                const incompleteOrders = Array.from(loadedOrders.entries())
                    .filter(([key, order]) =>
                        (order.orderQty > order.packedQty) &&
                        (order.rastreoData && order.rastreoData.length > 0)
                    )
                    .map(([key, order]) => ({ key, ...order }));

                if (incompleteOrders.length === 0) {
                    showModal('Reporte de Estatus', `✅ No hay órdenes incompletas con seriales cargados en el área ${currentArea}.`, 'success');
                    return;
                }

                let reportHTML = `<div class="status-report">`;
                reportHTML += `<p><strong>Fecha del Reporte:</strong> ${new Date().toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' })}</p>`;

                incompleteOrders.forEach(order => {
                    const packedSerials = new Set();
                    if (order.empaqueData) {
                        order.empaqueData.forEach(serialsInBox => {
                            serialsInBox.forEach(serialData => {
                                const serialHeader = findHeader(Object.keys(serialData), PACKING_KEYS.SERIAL);
                                if(serialHeader) packedSerials.add(serialData[serialHeader]);
                            });
                        });
                    }

                    const serialHeader = findHeader(order.headers.rastreo, TRACKING_KEYS.SERIAL);
                    const stationHeader = findHeader(order.headers.rastreo, TRACKING_KEYS.STATION);

                    const pendingSerials = serialHeader ? order.rastreoData.filter(rastreoItem =>
                        !packedSerials.has(rastreoItem[serialHeader]) && rastreoItem.status !== 'scrap'
                    ) : [];

                    const delayedSerials = pendingSerials.filter(s => s.status === 'delayed' || s.status === 'very_delayed');
                    const inProgressSerials = pendingSerials.filter(s => s.status === 'today');
                    
                    const percentage = (order.orderQty > 0) ? (order.packedQty / order.orderQty) * 100 : 0;
                    let progressBarColor = 'var(--success-color)';
                    if (percentage < 30) progressBarColor = 'var(--danger-color)';
                    else if (percentage < 70) progressBarColor = 'var(--warning-color)';

                    reportHTML += `
                        <h4>📦 Orden: ${order.key} (${order.packedQty || 0}/${order.orderQty || 0})</h4>
                        <div class="order-progress-bar" style="height: 8px;">
                            <div class="order-progress-bar-inner" style="width: ${Math.min(percentage, 100)}%; background-color: ${progressBarColor};"></div>
                        </div>
                    `;

                    if (delayedSerials.length > 0) {
                        reportHTML += `<p style="margin-top: 15px;"><strong>⚠️ Sin Movimiento (${delayedSerials.length}):</strong></p><ul>`;
                        delayedSerials.forEach(serial => {
                            reportHTML += `<li>${serial[serialHeader]} - (Estación: ${serial[stationHeader] || 'N/A'})</li>`;
                        });
                        reportHTML += `</ul>`;
                    }
                    
                    if (inProgressSerials.length > 0) {
                        reportHTML += `<p><strong>✅ En Proceso (${inProgressSerials.length}):</strong></p><ul>`;
                        inProgressSerials.forEach(serial => {
                            reportHTML += `<li>${serial[serialHeader]} - (Estación: ${serial[stationHeader] || 'N/A'})</li>`;
                        });
                        reportHTML += `</ul>`;
                    }

                    if(pendingSerials.length === 0){
                        reportHTML += `<p style="margin-top: 15px;">No hay seriales pendientes de empacar para esta orden.</p>`;
                    }
                });

                reportHTML += `</div>`;
                showModal(`Reporte de Estatus: ${currentArea}`, reportHTML, 'info', true);
            }
            
            // ========================
            // === SAP VIEW FUNCTIONS ===
            // ========================
            async function saveSapDataToFirebase(data, area) {
                try {
                    const dataToSave = {
                        orders: data,
                        lastUpdated: new Date(),
                        lastUpdatedBy: session.user
                    };
                    await db.collection('areas').doc(area).collection('sap_data').doc('current_data').set(dataToSave);
                } catch (e) {
                    console.error(`Error al guardar datos SAP en Firebase para ${area}: `, e);
                    showModal('Error', `No se pudieron guardar los datos de SAP en la nube para ${area}.`, 'error');
                }
            }
            
            async function syncMultiAreaSapData(groupedData) {
                const totalOrders = Object.values(groupedData).reduce((sum, arr) => sum + arr.length, 0);
                const areasAffected = Object.keys(groupedData);

                showModal('Procesando...', `Sincronizando ${totalOrders} órdenes en ${areasAffected.length} áreas...`, 'info');

                const promises = [];
                for (const areaName in groupedData) {
                    if (Object.hasOwnProperty.call(groupedData, areaName)) {
                        const ordersForArea = groupedData[areaName];
                        promises.push(saveSapDataToFirebase(ordersForArea, areaName));
                        promises.push(syncSapOrdersToFwd(ordersForArea, areaName));
                        initialSyncDoneForArea[areaName] = true;
                    }
                }

                await Promise.all(promises);
                hideModal();
                showModal('Éxito', `Workshop general procesado. Se han sincronizado los datos para las áreas: ${areasAffected.join(', ')}.`, 'success');
            }

            async function handleSapFile(file) {
    if (!file) return;

    const canEdit = session.isMaster || (session.permissions && session.permissions.includes(currentArea));
    if (!canEdit) {
        showModal('Acceso Denegado', `No tienes permisos para modificar el área ${currentArea}.`, 'error');
        return;
    }

    showModal('Procesando SAP...', `<p>Leyendo el archivo y preparando para guardar en el histórico. Por favor, espere...</p>`);

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            
            // 1. Procesa el archivo y obtiene los datos de las órdenes
            const processedData = processSapFile(workbook, session.isMaster);
            
            // Si es un archivo maestro, manejamos múltiples áreas
            if (session.isMaster && processedData.isMultiArea) {
                const areasAfectadas = Object.keys(processedData.data);
                showModal('Procesando Múltiples Áreas...', `Sincronizando órdenes en ${areasAfectadas.length} áreas...`);
                
                const promises = [];
                for (const areaName in processedData.data) {
                    const ordersForArea = processedData.data[areaName];
                    promises.push(saveSapOrdersToHistoric(ordersForArea, areaName)); // Guardamos en el histórico
                    promises.push(syncSapOrdersToFwd(ordersForArea, areaName));   // Sincronizamos con FWD
                }
                await Promise.all(promises);
                
                showModal('Éxito', `Workshop general procesado. Se han sincronizado los datos para las áreas: ${areasAfectadas.join(', ')}.`, 'success');

            } else { // Si es un archivo de una sola área
                const orders = processedData.isMultiArea ? processedData.data[currentArea] || [] : processedData;
                if(orders.length === 0) {
                    showModal('Sin Datos', 'El archivo no contiene órdenes válidas para el área actual.', 'warning');
                    return;
                }
                
                // 2. Guarda las órdenes en el nuevo histórico
                await saveSapOrdersToHistoric(orders, currentArea);
                
                // 3. Sincroniza los datos con la vista FWD como antes
                await syncSapOrdersToFwd(orders, currentArea);

                showModal('Éxito', `Archivo SAP cargado. Se han creado/actualizado ${orders.length} órdenes en el histórico del área ${currentArea}.`, 'success');
            }
            
            sapDateFilter = 'default';

        } catch (err) {
            console.error("Error procesando archivo SAP:", err);
            showModal('Error', `No se pudo procesar el archivo SAP. <br><small>${err.message}</small>`, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}


async function saveSapOrdersToHistoric(sapOrders, areaName) {
    if (!areaName || sapOrders.length === 0) return;
    
    const batch = db.batch();
    const historicCollectionRef = db.collection('areas').doc(areaName).collection('sap_historico');

    for (const sapOrder of sapOrders) {
        const orderId = String(sapOrder['Orden']);
        const orderRef = historicCollectionRef.doc(orderId);
        
        // Creamos un objeto con la info a guardar
        const dataToSave = {
            ...sapOrder,
            lastUpdated: new Date(), // Le añadimos una fecha de última actualización
            lastUpdatedBy: session.user
        };

        // set con merge:true es la clave. Si no existe, lo crea. Si ya existe, lo actualiza.
        batch.set(orderRef, dataToSave, { merge: true });
    }

    try {
        await batch.commit();
        console.log(`${sapOrders.length} órdenes de SAP guardadas en el histórico del área ${areaName}.`);
    } catch (e) {
        console.error(`Error al guardar en el histórico de SAP para ${areaName}:`, e);
        showModal('Error de Guardado', `No se pudo actualizar el histórico de SAP para ${areaName}.`, 'error');
    }
}

            async function syncSapOrdersToFwd(sapOrders, areaName) {
                if (!areaName || sapOrders.length === 0) return;
                
                const batch = db.batch();
                const ordersCollectionRef = db.collection('areas').doc(areaName).collection('orders');

                const existingOrdersSnapshot = await ordersCollectionRef.get();
                const existingOrdersMap = new Map();
                existingOrdersSnapshot.forEach(doc => {
                    existingOrdersMap.set(doc.id, doc.data());
                });

                for (const sapOrder of sapOrders) {
                    const orderId = String(sapOrder['Orden']);
                    const orderRef = ordersCollectionRef.doc(orderId);
                    
                    const existingOrder = existingOrdersMap.get(orderId);

                    const masterData = {
                        orderQty: sapOrder['Total orden'] || 0,
                        catalogNumber: sapOrder['Catalogo'] || 'N/A',
                        orderDate: excelSerialToDate(sapOrder['Finish']) || new Date(),
                    };

                    if (existingOrder) {
                        batch.update(orderRef, masterData);
                    } else {
                        const defaultData = {
                            packedQty: 0,
                            rastreoData: [],
                            empaqueData: [],
                            headers: { rastreo: [], empaque: [] },
                            lastUpdated: new Date(),
                            lastUpdatedBy: session.user
                        };
                        batch.set(orderRef, { ...defaultData, ...masterData });
                    }
                }

                try {
                    await batch.commit();
                    console.log(`${sapOrders.length} órdenes de SAP sincronizadas con FWD para el área ${areaName}.`);
                } catch (e) {
                    console.error(`Error al sincronizar órdenes de SAP a FWD para ${areaName}:`, e);
                    showModal('Error de Sincronización', `No se pudieron actualizar las órdenes en la vista FWD para ${areaName}.`, 'error');
                }
            }


            function processSapFile(workbook, isMasterUpload = false) {
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                if (!worksheet) throw new Error("No se encontró una hoja de cálculo en el archivo.");
                const getCellValue = (cellAddress) => (worksheet[cellAddress] ? worksheet[cellAddress].v : null);
                
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                const reynosaTodayString = new Date().toLocaleDateString('en-CA', { timeZone: REYNOSA_TIMEZONE });
                
                if (isMasterUpload) {
                    const resultsByArea = {};
                    for (let i = range.s.r + 1; i <= range.e.r; i++) {
                        const rowNum = i + 1;
                        const orderId = getCellValue('A' + rowNum);
                        if (!orderId) continue;
                        
                        const orderIdStr = String(orderId).trim();
                        if (!orderIdStr.startsWith('900')) {
                            continue;
                        }

                        const areaCode = getCellValue(workshopConfig.column + rowNum);
                        const areaName = workshopConfig.mapping[areaCode];

                        if (areaName) {
                            if (!resultsByArea[areaName]) {
                                resultsByArea[areaName] = [];
                            }
                            const orderData = extractSapRow(worksheet, rowNum, reynosaTodayString);
                            resultsByArea[areaName].push(orderData);
                        }
                    }
                    return { isMultiArea: true, data: resultsByArea };
                } else {
                    const processedData = [];
                    for (let i = range.s.r + 1; i <= range.e.r; i++) {
                        const rowNum = i + 1;
                        const orderId = getCellValue('A' + rowNum);
                        if (!orderId) continue;

                        const orderIdStr = String(orderId).trim();
                        if (!orderIdStr.startsWith('900')) {
                            continue;
                        }

                        processedData.push(extractSapRow(worksheet, rowNum, reynosaTodayString));
                    }
                    return processedData;
                }
            }

            function extractSapRow(worksheet, rowNum, reynosaTodayString){
                const getCellValue = (cellAddress) => (worksheet[cellAddress] ? worksheet[cellAddress].v : null);
                const total = parseFloat(getCellValue('I' + rowNum)) || 0;
                const confirmed = parseFloat(getCellValue('J' + rowNum)) || 0;
                const faltante = total - confirmed;
                const stock1 = getCellValue('B' + rowNum) || '';
                const stock2 = getCellValue('L' + rowNum) || '';
                let status = 'incomplete';
                const finishDateSerial = getCellValue('G' + rowNum);
                const finishDate = excelSerialToDate(finishDateSerial);
                const finishDateStringCA = finishDate ? finishDate.toLocaleDateString('en-CA', { timeZone: REYNOSA_TIMEZONE }) : '';
                
                if (faltante <= 0) {
                    status = 'complete';
                } else if (finishDateStringCA && finishDateStringCA < reynosaTodayString) {
                    status = 'late';
                }

                return {
                    'Orden': getCellValue('A' + rowNum),
                    'Catalogo': getCellValue('D' + rowNum) || null,
                    'Material': getCellValue('C' + rowNum) || null,
                    'Special Stock': [stock1, stock2].filter(Boolean).join(' / ') || null,
                    'Finish': finishDateSerial,
                    'Total orden': total,
                    'Total confirmado': confirmed,
                    'Faltante': faltante,
                    'status': status
                };
            }

            function renderSapView() {
    const canEdit = session.isMaster || (session.permissions && session.permissions.includes(currentArea));
    sapFileDropArea.classList.toggle('disabled', !canEdit);
    if(sapFileDropArea.querySelector('p')) {
        sapFileDropArea.querySelector('p').textContent = canEdit
            ? (session.isMaster ? 'Arrastra un archivo maestro SAP (General o de Área)' : 'Arrastra un archivo maestro SAP (.xlsx)')
            : 'No tienes permisos para esta área';
    }
    
    const hasData = sapData.length > 0;
    sapPlaceholderText.style.display = hasData ? 'none' : 'block';
    sapExportImageBtn.disabled = !hasData;

    updateSapDashboard();
    updateSapOrderList();
    updateSapTable();

    // El botón "Mostrar Hoy/Tarde" ahora limpia el array de filtros
    sapResetFilterBtn.style.display = (sapDateFilter.length > 0 && hasData) ? 'inline-block' : 'none';
    
    if (sapLastUpdated) {
        let updatedText = `Última actualización: ${formatDateTime(sapLastUpdated)}`;
        if (sapLastUpdatedBy) {
            updatedText += ` por: ${sapLastUpdatedBy}`;
        }
        sapLastUpdatedContainer.textContent = updatedText;
    } else {
        sapLastUpdatedContainer.textContent = '';
    }
}
            
            function isSapOrderForToday(order) {
                const todayString = new Date().toLocaleDateString('es-ES', {
                    timeZone: REYNOSA_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric'
                });
                const finishDate = excelSerialToDate(order['Finish']);
                return finishDate && formatDate(finishDate) === todayString;
            }

            function updateSapDashboard() {
                if(sapData.length === 0) {
                    sapTotalOrdersStat.textContent = '0';
                    sapCompletedOrdersStat.textContent = '0';
                    return;
                }
                const ordersToday = sapData.filter(row => isSapOrderForToday(row)).length;
                const ordersCompletedToday = sapData.filter(row => row.status === 'complete' && isSapOrderForToday(row)).length;

                sapTotalOrdersStat.textContent = ordersToday;
                sapCompletedOrdersStat.textContent = ordersCompletedToday;
            }

            function updateSapOrderList() {
    if (sapData.length === 0) {
        sapOrderList.innerHTML = `<p class="text-dark" style="font-size:0.9rem;">Cargue un archivo para ver las órdenes.</p>`;
        return;
    }
    
    // Si el filtro no es un array (es 'default' o un solo día de antes), lo convertimos en array para facilitar
    if (!Array.isArray(sapDateFilter)) {
        sapDateFilter = sapDateFilter === 'default' ? [] : [sapDateFilter];
    }

    const groupedByDate = new Map();
    sapData.forEach(order => {
        const date = excelSerialToDate(order['Finish']) || new Date(0);
        const dateString = formatDate(date);
        if (!groupedByDate.has(dateString)) groupedByDate.set(dateString, 0);
        groupedByDate.set(dateString, groupedByDate.get(dateString) + 1);
    });

    const sortedDates = Array.from(groupedByDate.keys()).sort((a, b) => {
        const dateA = new Date(a.split('/').reverse().join('-'));
        const dateB = new Date(b.split('/').reverse().join('-'));
        return dateB - dateA;
    });

    const todayString = new Date().toLocaleDateString('es-ES', { timeZone: REYNOSA_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric' });
    
    let html = '';
    sortedDates.forEach(dateString => {
        const orderCount = groupedByDate.get(dateString);
        const isToday = dateString === todayString;
        const countText = `${orderCount} ${orderCount === 1 ? 'orden' : 'órdenes'}`;

        html += `<div class="order-item">
                    <button class="date-header" data-date="${dateString}" style="width:100%; justify-content: space-between;">
                        <span>📅 ${dateString}</span>
                        ${isToday ? `<span class="status-indicator">(${countText})</span>` : `<span class="order-count">(${countText})</span>`}
                    </button>
                 </div>`;
    });
    
    sapOrderList.innerHTML = html;
    
    sapOrderList.querySelectorAll('.date-header').forEach(header => {
        // Marcamos como activos todos los que estén en nuestro array de filtros
        if (sapDateFilter.includes(header.dataset.date)) {
            header.classList.add('active');
        }
        
        header.addEventListener('click', () => {
            const clickedDate = header.dataset.date;
            const dateIndex = sapDateFilter.indexOf(clickedDate);

            // Lógica de Toggling: Si ya está, lo quitamos. Si no está, lo agregamos.
            if (dateIndex > -1) {
                sapDateFilter.splice(dateIndex, 1); // Quitar del array
            } else {
                sapDateFilter.push(clickedDate); // Agregar al array
            }
            
            // Volvemos a renderizar todo para reflejar los cambios
            renderSapView();
        });
    });
}
            
            function updateSapTable() {
    const table = doc('sapTable');
    if (sapData.length === 0) {
        table.innerHTML = '';
        return;
    }

    let dataToDisplay = [];
    // Si el array de filtros está vacío, usamos la lógica de "Hoy/Tarde"
    if (sapDateFilter.length === 0) {
        dataToDisplay = sapData.filter(row => row.status === 'late' || isSapOrderForToday(row));
    } else {
        // Si el array tiene fechas, filtramos por todas las fechas incluidas en él
        dataToDisplay = sapData.filter(row => {
            const orderDate = formatDate(excelSerialToDate(row['Finish']));
            return sapDateFilter.includes(orderDate);
        });
    }

    // El resto de la función para pintar la tabla no cambia...
    if (dataToDisplay.length === 0) {
        table.innerHTML = `<thead><tr><th>No hay órdenes para la selección actual.</th></tr></thead>`;
        return;
    }

    const headers = ['Orden', 'Catalogo', 'Material', 'Special Stock', 'Finish', 'Total orden', 'Total confirmado', 'Faltante'];
    table.innerHTML = `
        <thead><tr>${headers.map(h => `<th>${h.replace(/_/g, ' ')}</th>`).join('')}</tr></thead>
        <tbody>
            ${dataToDisplay.map(row => `
                <tr class="is-${row.status}-sap">
                    <td data-label="Orden">${row['Orden']}</td>
                    <td data-label="Catalogo">${row['Catalogo']}</td>
                    <td data-label="Material">${row['Material']}</td>
                    <td data-label="Special Stock">${row['Special Stock']}</td>
                    <td data-label="Finish">${formatDate(excelSerialToDate(row['Finish']))}</td>
                    <td data-label="Total orden">${row['Total orden']}</td>
                    <td data-label="Total confirmado">${row['Total confirmado']}</td>
                    <td data-label="Faltante">${row['Faltante']}</td>
                </tr>
            `).join('')}
        </tbody>`;
}

            function formatCell(value, header, isDateTime = false) {
                if (isDateTime) return formatDateTimeFromSerial(value);
                if (header && header.toLowerCase().includes('date')) return formatDate(excelSerialToDate(value));
                return value === undefined || value === null ? '' : value;
            }
            
            function syncFwdAndSapDates() {
                if (loadedOrders.size === 0 || sapData.length === 0) return;

                const sapDateMap = new Map(sapData.map(order => [String(order.Orden), order.Finish]));
                
                loadedOrders.forEach((orderData, orderKey) => {
                    if (sapDateMap.has(orderKey)) {
                        const sapFinishDateSerial = sapDateMap.get(orderKey);
                        const sapFinishDate = excelSerialToDate(sapFinishDateSerial);
                        if(sapFinishDate) {
                            orderData.orderDate = sapFinishDate;
                        }
                    }
                });
            }

            // ===================================
            // === AUTH & AREA FUNCTIONS ===
            // ===================================
            function showLogin() {
                let content = `
                    <p>Introduce tus credenciales para acceder.</p>
                    <input type="text" id="userInput" placeholder="Usuario" style="text-transform:uppercase">
                    <input type="password" id="passwordInput" placeholder="Contraseña">
                    <button id="loginBtn" class="btn" style="margin-top: 16px;">Autenticar</button>
                `;
                showModal('Inicio de Sesión', content);
                doc('loginBtn').addEventListener('click', checkCredentials);
                doc('passwordInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') checkCredentials(); });
                doc('userInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') checkCredentials(); });
            }

            async function checkCredentials() {
                const userInput = doc('userInput').value.trim().toUpperCase();
                const passwordInput = doc('passwordInput').value;
                if (!userInput || !passwordInput) {
                    showModal('Error', 'Debes ingresar el usuario y la contraseña.', 'error');
                    return;
                }

                try {
                    const userDoc = await db.collection('users').doc(userInput).get();
                    if (!userDoc.exists) {
                        showModal('Error', 'El usuario no existe.', 'error');
                        return;
                    }

                    const userData = userDoc.data();
                    if (userData.password === passwordInput) {
                        session = {
                            user: userData.username,
                            isMaster: userData.isMaster || false,
                            permissions: userData.permissions || []
                        };
                        sessionStorage.setItem('appSession', JSON.stringify(session));
                        hideModal();
                        updateUIAfterAuth();
                    } else {
                        showModal('Error', 'Contraseña incorrecta.', 'error');
                    }
                } catch (e) {
                    console.error("Error de autenticación: ", e);
                    showModal('Error', 'Ocurrió un error al verificar las credenciales.', 'error');
                }
            }
            
            function logout() {
                session = { user: null, isMaster: false, permissions: [] };
                sessionStorage.removeItem('appSession');
                updateUIAfterAuth();
            }

            function updateUIAfterAuth() {
                const isAuthenticated = !!session.user;
                const canEditCurrentArea = isAuthenticated && (session.isMaster || (session.permissions && session.permissions.includes(currentArea)));

                fileDropArea.classList.toggle('disabled', !canEditCurrentArea);
                fileDropArea.querySelector('p').textContent = canEditCurrentArea ? 'Arrastra archivos de detalle (.xlsx)' : 'No tienes permisos para esta área';
                
                sapFileDropArea.classList.toggle('disabled', !canEditCurrentArea);
                if(sapFileDropArea.querySelector('p')) {
                    sapFileDropArea.querySelector('p').textContent = canEditCurrentArea
                        ? (session.isMaster ? 'Arrastra un archivo maestro SAP (General o de Área)' : 'Arrastra un archivo maestro SAP (.xlsx)')
                        : 'No tienes permisos para esta área';
                }
                
                if (isAuthenticated) {
                    logoutBtn.style.display = 'flex';
                    if (session.isMaster) {
                        adminBtn.style.display = 'flex';
                        adminBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg> ${session.user}`;
                    } else {
                        adminBtn.style.display = 'none';
                    }
                } else {
                    logoutBtn.style.display = 'none';
                    adminBtn.style.display = 'flex';
                    adminBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>`;
                }

                dailyPlanContainer.style.display = session.isMaster ? 'flex' : 'none';
                areaSelectBtn.textContent = `Área: ${currentArea}`;
                
                updateOrderList();
                render();
            }

            async function showAreaSelector() {
                const areasSnapshot = await db.collection('areas').get();
                let areas = [];
                areasSnapshot.forEach(doc => {
                    if(doc.id !== 'CONFIG') areas.push({ id: doc.id, ...doc.data() })
                });
                areas.sort((a,b) => a.id.localeCompare(b.id));

                let content = '<h3>Selecciona un Área para Visualizar</h3><ul class="area-list" style="grid-template-columns: 1fr auto;">';
                areas.forEach(area => {
                    content += `<li><span>${area.name}</span> <button class="btn select-area-btn" data-area="${area.id}" style="width: auto; padding: 5px 10px;">Seleccionar</button></li>`;
                });
                content += '</ul>';
                showModal('Selector de Área', content);

                doc('modalBody').querySelectorAll('.select-area-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newArea = e.target.dataset.area;
                        if (newArea !== currentArea) {
                            currentArea = newArea;
                            localStorage.setItem('currentArea', currentArea);
                            areaSelectBtn.textContent = `Área: ${currentArea}`;
                            setupListenersForArea(currentArea);
                        }
                        updateUIAfterAuth();
                        hideModal();
                    });
                });
            }

            async function showAdminPanel() {
                const [areasSnapshot, usersSnapshot] = await Promise.all([
                    db.collection('areas').get(),
                    db.collection('users').get()
                ]);

                let areas = [];
                areasSnapshot.forEach(doc => {
                    if(doc.id !== 'CONFIG') areas.push({ id: doc.id, ...doc.data() })
                });
                areas.sort((a,b) => a.id.localeCompare(b.id));

                let users = [];
                usersSnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                users.sort((a, b) => a.id.localeCompare(b.id));

                let content = `
                <div class="admin-section">
                    <h3 class="admin-section-header">Gestionar Usuarios</h3>
                    <div class="admin-section-content">
                        <ul class="area-list user-list">
                            ${users.map(user => `<li>
                                <span style="font-weight: bold;">${user.username} ${user.isMaster ? ' (Admin)' : ''}</span>
                                <div class="permissions-display">${(user.permissions || []).join(', ')}</div>
                                <div>
                                    ${user.username !== 'MULTIPORT' ? `
                                    <button class="btn edit-user-btn" data-id="${user.id}" style="width: auto; padding: 5px 10px;">Editar</button>
                                    <button class="btn btn-danger delete-user-btn" data-id="${user.id}" style="width: auto; padding: 5px 10px; margin-left: 5px;">Eliminar</button>
                                    ` : ''}
                                </div>
                            </li>`).join('')}
                        </ul>
                        <button id="createUserBtn" class="btn" style="margin-top: 20px;">Crear Nuevo Usuario</button>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-section-header">Gestionar Áreas y Contraseñas</h3>
                    <div class="admin-section-content">
                        <ul class="area-list">
                            ${areas.map(area => `<li>
                                <input type="text" class="area-name-input" data-id="${area.id}" value="${area.name}" disabled>
                                <input type="text" class="area-password-input" data-id="${area.id}" value="${area.password || ''}">
                                <div>
                                    <button class="btn save-area-btn" data-id="${area.id}" style="width: auto; padding: 5px 10px;">Guardar</button>
                                    ${!area.isMaster ? `<button class="btn btn-danger delete-area-btn" data-id="${area.id}" style="width: auto; padding: 5px 10px; margin-left: 5px;">Eliminar</button>` : ''}
                                </div>
                            </li>`).join('')}
                        </ul>
                        <h4 style="margin-top: 20px;">Crear Nueva Área</h4>
                        <input type="text" id="newAreaInput" placeholder="Nombre de Área (ej. ENSAMBLE)" style="text-transform:uppercase">
                        <input type="text" id="newPasswordInput" placeholder="Contraseña para la nueva área">
                        <button id="createAreaBtn" class="btn" style="margin-top: 10px;">Crear Área</button>
                    </div>
                </div>
                
                <div id="masterConfigSection" class="admin-section" style="display: block;">
                    <h3 class="admin-section-header">Configuración de Workshop General</h3>
                    <div class="admin-section-content">
                        <div class="config-item">
                            <label for="masterColumnInput">Columna de Código de Área:</label>
                            <input type="text" id="masterColumnInput" value="${workshopConfig.column}">
                        </div>
                        <h4>Mapeo de Códigos a Áreas</h4>
                        <ul id="areaMappingList" class="area-list"></ul>
                        <button id="addMappingBtn" class="btn" style="width: auto; padding: 5px 10px; margin-top: 10px;">Añadir Mapeo</button>
                        <button id="saveWorkshopConfigBtn" class="btn" style="margin-top: 20px;">Guardar Configuración General</button>
                    </div>
                </div>`;

                showModal('Panel de Administrador', content);
                
                doc('createUserBtn').addEventListener('click', () => createOrUpdateUser(null));

                doc('modalBody').querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.id;
                        const user = users.find(u => u.id === userId);
                        createOrUpdateUser(user);
                    });
                });
                doc('modalBody').querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.dataset.id;
                        showConfirmationModal(`¿Seguro que quieres eliminar al usuario "${userId}"?`, async () => {
                            await db.collection('users').doc(userId).delete();
                            showAdminPanel();
                        });
                    });
                });

                doc('modalBody').querySelectorAll('.admin-section-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.parentElement.classList.toggle('expanded');
                    });
                });

                const mappingList = doc('areaMappingList');
                mappingList.innerHTML = '';
                for (const code in workshopConfig.mapping) {
                    const areaName = workshopConfig.mapping[code];
                    mappingList.appendChild(createMappingItem(code, areaName));
                }
                doc('addMappingBtn').addEventListener('click', () => {
                    mappingList.appendChild(createMappingItem('', ''));
                });
                doc('saveWorkshopConfigBtn').addEventListener('click', saveWorkshopConfig);

                doc('createAreaBtn').addEventListener('click', async () => {
                    const newAreaName = doc('newAreaInput').value.trim().toUpperCase();
                    const newPassword = doc('newPasswordInput').value.trim();
                    if (newAreaName && newPassword) {
                        await db.collection('areas').doc(newAreaName).set({
                            name: newAreaName,
                            password: newPassword,
                            isMaster: false,
                            createdAt: new Date()
                        });
                        showAdminPanel();
                    } else {
                        showModal('Atención', 'Debes especificar un nombre y una contraseña para la nueva área.', 'warning');
                    }
                });

                doc('modalBody').querySelectorAll('.save-area-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const areaId = e.target.dataset.id;
                        const newPassword = doc('modalBody').querySelector(`.area-password-input[data-id="${areaId}"]`).value.trim();
                        if (newPassword) {
                            await db.collection('areas').doc(areaId).update({ password: newPassword });
                            showAdminPanel();
                        }
                    });
                });

                doc('modalBody').querySelectorAll('.delete-area-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const areaId = e.target.dataset.id;
                        showConfirmationModal(`¿Seguro que quieres eliminar el área "${areaId}" y todos sus datos?`, async () => {
                            await deleteAreaAndSubcollections(areaId);
                            showAdminPanel();
                        });
                    });
                });
            }
            
            async function createOrUpdateUser(userToEdit = null) {
                const isEditing = userToEdit !== null;
                const title = isEditing ? `Editar Usuario: ${userToEdit.username}` : 'Crear Nuevo Usuario';

                const areasSnapshot = await db.collection('areas').get();
                let areas = [];
                areasSnapshot.forEach(doc => { if (doc.id !== 'CONFIG') areas.push({ id: doc.id, ...doc.data() }); });
                areas.sort((a,b) => a.id.localeCompare(b.id));

                let modalContent = `
                    <input type="text" id="modalUserInput" placeholder="Nombre de Usuario" style="text-transform:uppercase" value="${isEditing ? userToEdit.username : ''}" ${isEditing ? 'disabled' : ''}>
                    <input type="text" id="modalPasswordInput" placeholder="${isEditing ? 'Nueva contraseña (dejar en blanco para no cambiar)' : 'Contraseña'}">
                    <h5 style="margin-top:16px; margin-bottom: 8px;">Permisos de Área:</h5>
                    <div id="modalPermissions" class="permissions-list">
                        ${areas.map(area => {
                            const isChecked = isEditing && userToEdit.permissions && userToEdit.permissions.includes(area.id);
                            return `<label><input type="checkbox" value="${area.id}" ${isChecked ? 'checked' : ''}>${area.name}</label>`;
                        }).join('')}
                    </div>
                    <div style="margin-top: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="modalIsMasterInput" style="width: auto; margin: 0;" ${isEditing && userToEdit.isMaster ? 'checked' : ''}>
                            Asignar permisos de Administrador
                        </label>
                    </div>
                    <button id="saveUserBtn" class="btn" style="margin-top: 20px;">${isEditing ? 'Guardar Cambios' : 'Crear Usuario'}</button>
                `;
                showModal(title, modalContent);

                doc('saveUserBtn').onclick = async () => {
                    const username = doc('modalUserInput').value.trim().toUpperCase();
                    const password = doc('modalPasswordInput').value.trim();
                    
                    if (!username || (!isEditing && !password)) {
                        showModal('Error', 'El nombre de usuario y la contraseña son obligatorios.', 'error');
                        return;
                    }

                    const permissions = Array.from(doc('modalPermissions').querySelectorAll('input:checked')).map(cb => cb.value);
                    const isMaster = doc('modalIsMasterInput').checked;
                    
                    const userData = {
                        username: username,
                        permissions: permissions,
                        isMaster: isMaster
                    };

                    if (password) {
                        userData.password = password;
                    }

                    await db.collection('users').doc(username).set(userData, { merge: true });
                    showAdminPanel();
                };
            }
            
            async function deleteAreaAndSubcollections(areaId) {
                const subcollections = ['orders', 'sap_data'];
                for (const subcollection of subcollections) {
                    const snapshot = await db.collection('areas').doc(areaId).collection(subcollection).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
                await db.collection('areas').doc(areaId).delete();
            }

            function createMappingItem(code, areaName) {
                const li = document.createElement('li');
                li.className = 'mapping-item';
                li.innerHTML = `
                    <input type="text" class="mapping-code" placeholder="Código (ej. K46)" value="${code}">
                    <input type="text" class="mapping-area" placeholder="Nombre de Área" value="${areaName}">
                    <button class="btn btn-danger" style="width: auto; padding: 5px 10px;" onclick="this.parentElement.remove()">X</button>
                `;
                return li;
            }

            async function saveWorkshopConfig() {
                const newColumn = doc('masterColumnInput').value.trim().toUpperCase() || 'C';
                const newMapping = {};
                doc('areaMappingList').querySelectorAll('.mapping-item').forEach(item => {
                    const code = item.querySelector('.mapping-code').value.trim().toUpperCase();
                    const area = item.querySelector('.mapping-area').value.trim().toUpperCase();
                    if (code && area) {
                        newMapping[code] = area;
                    }
                });
                
                const newConfig = { column: newColumn, mapping: newMapping };
                
                try {
                    await db.collection('areas').doc('CONFIG').set({ general_workshop: newConfig }, { merge: true });
                    workshopConfig = newConfig;
                    showModal('Éxito', 'La configuración del workshop general ha sido guardada.', 'success');
                } catch (e) {
                    console.error("Error guardando configuración:", e);
                    showModal('Error', 'No se pudo guardar la configuración.', 'error');
                }
            }

            async function loadWorkshopConfig() {
                try {
                    const configDoc = await db.collection('areas').doc('CONFIG').get();
                    if (configDoc.exists && configDoc.data().general_workshop) {
                        workshopConfig = configDoc.data().general_workshop;
                        console.log("Configuración de workshop cargada desde Firebase.");
                    } else {
                        console.log("No se encontró configuración de workshop, usando valores por defecto.");
                    }
                } catch(e) {
                    console.error("Error cargando configuración de workshop:", e);
                }
            }
            
            async function generateDailyPlanReport() {
                showModal('Plan del Día', '<h4 style="text-align: center;">Cargando reporte...</h4>');
                try {
                    const todayString = new Date().toLocaleDateString('es-ES', {
                        timeZone: REYNOSA_TIMEZONE, day: '2-digit', month: '2-digit', year: 'numeric'
                    });

                    const areasSnapshot = await db.collection('areas').get();
                    const areaDocs = areasSnapshot.docs.filter(doc => doc.id !== 'CONFIG');
                    
                    const promises = areaDocs.map(doc => doc.ref.collection('sap_data').doc('current_data').get());
                    const allSapDataDocs = await Promise.all(promises);

                    let dailyOrdersByArea = {};
                    let totalDailyOrders = 0;

                    allSapDataDocs.forEach((sapDoc, index) => {
                        if (sapDoc.exists) {
                            const areaName = areaDocs[index].id;
                            const sapOrders = sapDoc.data().orders || [];
                            
                            const pendingOrdersForToday = sapOrders.filter(order =>
                                isSapOrderForToday(order) && order.status !== 'complete'
                            );
                            
                            const countForArea = pendingOrdersForToday.length;
                            
                            if (countForArea > 0) {
                                dailyOrdersByArea[areaName] = countForArea;
                                totalDailyOrders += countForArea;
                            }
                        }
                    });

                    let reportHTML = `
                        <div class="daily-plan-modal">
                            <div class="plan-header">
                                <div class="plan-stat">
                                    <span>Órdenes Pendientes</span>
                                    <p>${totalDailyOrders}</p>
                                </div>
                                <div class="plan-date">
                                    <span>Fecha</span>
                                    <p>${todayString}</p>
                                </div>
                            </div>
                            <div class="plan-title-separator">Plan de Trabajo por Área</div>
                            <ul class="plan-area-list">
                    `;

                    if (totalDailyOrders > 0) {
                        const sortedAreas = Object.keys(dailyOrdersByArea).sort();
                        for (const area of sortedAreas) {
                            reportHTML += `<li class="plan-area-item">
                                                <span class="area-name">${area}</span>
                                                <span class="area-count">${dailyOrdersByArea[area]}</span>
                                            </li>`;
                        }
                    } else {
                        reportHTML += `<li class="plan-area-item-empty">No hay órdenes pendientes para el día de hoy.</li>`;
                    }
                    
                    reportHTML += `</ul></div>`;
                    showModal('Plan del Día', reportHTML);

                } catch (e) {
                    console.error("Error al generar el reporte del plan diario:", e);
                    showModal('Error', 'No se pudo generar el reporte del plan diario.', 'error');
                }
            }


            // ===================================
            // === THEME & INITIALIZATION ===
            // ===================================
            let currentTheme = localStorage.getItem('theme') || 'dark';

            function applyTheme(theme) {
                document.body.className = `${theme}-theme`;
                const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
                const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
                themeToggleBtn.innerHTML = theme === 'light' ? moonIcon : sunIcon;
            }
            
            function adjustStickyTops() {
                requestAnimationFrame(() => {
                    const isCurrentlyMobile = window.innerWidth <= 992;
                    if (isCurrentlyMobile) return;

                    const fwdHeader = document.querySelector('#fwdView .header');
                    const fwdControls = document.getElementById('table-controls-header');
                    const sapHeader = document.querySelector('#sapView .global-header');
                    const sapControls = document.getElementById('sap-controls-header');
                    
                    if (fwdHeader && fwdControls) {
                        const headerHeight = fwdHeader.offsetHeight;
                        const topValue = 16 + headerHeight;
                        fwdControls.style.top = `${topValue}px`;
                    }

                    if (sapHeader && sapControls) {
                        const headerHeight = sapHeader.offsetHeight;
                        const topValue = 16 + headerHeight;
                        sapControls.style.top = `${topValue}px`;
                    }
                });
            }

            themeToggleBtn.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', currentTheme);
                applyTheme(currentTheme);
            });

            function setupListenersForArea(area) {
    if (!area) return;
    // Detenemos los listeners anteriores para evitar duplicados
    if (fwdListener) fwdListener();
    if (sapListener) sapListener();

    // === LISTENER PARA FWD (RASTREO) - ESTE NO CAMBIA ===
    fwdListener = db.collection('areas').doc(area).collection('orders').onSnapshot(snapshot => {
        const ordersFromDB = new Map();
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.orderDate && data.orderDate.toDate) { data.orderDate = data.orderDate.toDate(); }
            if (data.lastUpdated && data.lastUpdated.toDate) { data.lastUpdated = data.lastUpdated.toDate(); }
            const empaqueDataMap = new Map();
            if (data.empaqueData && Array.isArray(data.empaqueData)) {
                data.empaqueData.forEach(item => { empaqueDataMap.set(item.boxId, item.serials); });
            }
            data.empaqueData = empaqueDataMap;
            ordersFromDB.set(doc.id, data);
        });
        loadedOrders = ordersFromDB;
        syncFwdAndSapDates();
        updateOrderList();
        if (mainMode === 'fwd') render();
    }, err => {
        console.error("Error escuchando datos de FWD: ", err);
        showModal('Error de Conexión', `No se pudo conectar a los datos del área ${area}.`, 'error');
    });
    
    // === LISTENER PARA SAP (HISTÓRICO) - CON LA NUEVA LÓGICA ===
    sapListener = db.collection('areas').doc(area).collection('sap_historico').onSnapshot(snapshot => {
        let newSapData = [];
        let latestUpdate = null;
        let updatedBy = null;

        snapshot.forEach(doc => {
            const orderData = doc.data();
            newSapData.push(orderData);
            
            const orderLastUpdated = orderData.lastUpdated ? orderData.lastUpdated.toDate() : null;
            if (orderLastUpdated && (!latestUpdate || orderLastUpdated > latestUpdate)) {
                latestUpdate = orderLastUpdated;
                updatedBy = orderData.lastUpdatedBy;
            }
        });

        sapData = newSapData;
        sapLastUpdated = latestUpdate;
        sapLastUpdatedBy = updatedBy;
        
        syncFwdAndSapDates();
        updateOrderList();
        if (mainMode === 'sap') {
            render();
        }
    }, err => {
        console.error("Error escuchando datos del histórico de SAP: ", err);
        showModal('Error de Conexión', `No se pudo conectar al histórico de SAP para el área ${area}.`, 'error');
    });
}

// --- ¡AQUÍ ESTÁ EL CÓDIGO RESTAURADO! ---
let isMobile = window.innerWidth <= 992;
const mobileCollapsibleCardIds = ['uploadCard', 'orderListCard', 'filtersCard', 'actionsCard', 'sap-uploadCard', 'sap-orderListCard'];
function setupMobileMode() {
    mobileCollapsibleCardIds.forEach(id => {
        const cardElement = doc(id);
        if (!cardElement) return;
        cardElement.classList.add('mobile-collapsible');
        const trigger = cardElement.querySelector('h3');
        if (trigger) {
            trigger.classList.add('mobile-trigger');
            if (!trigger.dataset.mobileListener) {
                trigger.addEventListener('click', (e) => {
                    if(window.innerWidth <= 992) {
                        e.currentTarget.closest('.card').classList.toggle('expanded');
                    }
                });
                trigger.dataset.mobileListener = 'true';
            }
        }
    });
}

function teardownMobileMode() {
    mobileCollapsibleCardIds.forEach(id => {
        const cardElement = doc(id);
        if (!cardElement) return;
        cardElement.classList.remove('mobile-collapsible', 'expanded');
        const trigger = cardElement.querySelector('h3');
        if(trigger) trigger.classList.remove('mobile-trigger');
    });
}
            window.addEventListener('resize', () => {
                const newIsMobile = window.innerWidth <= 992;
                if (newIsMobile !== isMobile) {
                    isMobile = newIsMobile;
                    if (isMobile) setupMobileMode(); else teardownMobileMode();
                    render();
                }
                adjustStickyTops();
            });

            window.copySerialNumber = function(element, serial) {
                if (!serial) return;
                const serialToCopy = serial.startsWith('S#') ? serial.substring(2) : serial;
                
                copyTextToClipboard(serialToCopy,
                    () => { // Success
                        const originalText = element.textContent;
                        element.textContent = '¡Copiado!';
                        element.style.fontWeight = 'bold';
                        element.style.color = 'var(--success-color)';
                        setTimeout(() => {
                            element.textContent = originalText;
                            element.style.fontWeight = '';
                            element.style.color = '';
                        }, 1500);
                    },
                    (err) => { // Error
                        console.error('Error al copiar el número de serie: ', err);
                        const originalText = element.textContent;
                        element.textContent = 'Error';
                        setTimeout(() => {
                            element.textContent = originalText;
                        }, 1500);
                    }
                );
            }

            async function initializeApp() {
                await loadWorkshopConfig();

                const masterUserRef = db.collection('users').doc('MULTIPORT');
                const masterUserDoc = await masterUserRef.get();
                if (!masterUserDoc.exists) {
                    await masterUserRef.set({
                        username: 'MULTIPORT',
                        password: 'CORNING25',
                        isMaster: true,
                        permissions: []
                    });
                    console.log("Usuario maestro 'MULTIPORT' creado.");
                }
                const masterAreaRef = db.collection('areas').doc('MULTIPORT');
                const masterAreaDoc = await masterAreaRef.get();
                if (!masterAreaDoc.exists) {
                    await masterAreaRef.set({
                        name: 'MULTIPORT',
                        password: 'CORNING25',
                        isMaster: true
                    }, { merge: true });
                    console.log("Área maestra 'MULTIPORT' verificada y asegurada.");
                }


                mainMode = localStorage.getItem('mainMode') || 'fwd';
                currentArea = localStorage.getItem('currentArea') || 'MULTIPORT';
                applyTheme(currentTheme);
                
                modeFwd.classList.toggle('active', mainMode === 'fwd');
                modeSap.classList.toggle('active', mainMode === 'sap');

                doc('fwdView').style.display = mainMode === 'fwd' ? 'block' : 'none';
                doc('sapView').style.display = mainMode === 'sap' ? 'block' : 'none';
                doc('fwdView').style.opacity = mainMode === 'fwd' ? '1' : '0';
                doc('sapView').style.opacity = mainMode === 'sap' ? '1' : '0';

                if (isMobile) setupMobileMode();
                
                const savedSession = sessionStorage.getItem('appSession');
                if (savedSession) {
                    session = JSON.parse(savedSession);
                }

                updateUIAfterAuth();
                setupListenersForArea(currentArea);

                setTimeout(adjustStickyTops, 500);
            }

            // === INICIO DE LA APP ===
            initializeApp();
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('✅ Service Worker registrado con éxito. Alcance:', registration.scope);
                })
                .catch(error => {
                    console.log('❌ Error al registrar el Service Worker:', error);
                });
            });
        }
    </script>
</body>
</html>
